<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fulcrum AI</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: #f5f7fa;
            color: #333;
        }

        .container {
            min-height: 100vh;
            background: #f1f5f9;
            position: relative;
        }

        /* Sidebar Navigation */
        .sidebar {
            width: 280px;
            background: linear-gradient(145deg, #0f172a 0%, #1e293b 25%, #334155 100%);
            color: white;
            padding: 0;
            box-shadow: 4px 0 24px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            overflow: hidden;
        }

        .sidebar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(145deg, transparent 0%, rgba(59, 130, 246, 0.05) 50%, transparent 100%);
            pointer-events: none;
            animation: shimmer 8s ease-in-out infinite;
        }

        @keyframes shimmer {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 0.6; }
        }

        .sidebar h1 {
            text-align: center;
            margin: 0;
            padding: 2.5rem 2rem 1.5rem;
            font-size: 1.75rem;
            font-weight: 800;
            letter-spacing: -0.025em;
            background: linear-gradient(135deg, #ffffff 0%, #e2e8f0 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            position: relative;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar h1 i {
            margin-right: 0.75rem;
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 1.5rem;
        }

        .nav-section {
            flex: 1;
            margin: 1.5rem 0 0 0;
            padding: 0 1rem;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .nav-section::-webkit-scrollbar {
            width: 4px;
        }

        .nav-section::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
        }

        .nav-section::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 2px;
        }

        .nav-section::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 1.25rem 1.5rem;
            margin: 0.375rem 0;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 12px;
            position: relative;
            font-weight: 500;
            font-size: 0.95rem;
            border: 1px solid transparent;
        }

        .nav-item:hover {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.15) 0%, rgba(30, 64, 175, 0.1) 100%);
            border-color: rgba(59, 130, 246, 0.3);
            transform: translateX(4px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
        }

        .nav-item.active {
            background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);
            border-color: rgba(255, 255, 255, 0.2);
            transform: translateX(6px);
            box-shadow: 0 8px 24px rgba(59, 130, 246, 0.4);
            font-weight: 600;
        }

        .nav-item.active::before {
            content: '';
            position: absolute;
            left: -1rem;
            top: 50%;
            transform: translateY(-50%);
            width: 4px;
            height: 50%;
            background: linear-gradient(to bottom, #ffffff, #e2e8f0);
            border-radius: 2px;
        }

        .nav-item i {
            margin-right: 1rem;
            width: 20px;
            text-align: center;
            font-size: 1.1rem;
            transition: all 0.3s ease;
        }

        .nav-item.active i {
            color: #ffffff;
            text-shadow: 0 0 8px rgba(255, 255, 255, 0.5);
        }

        .nav-item span {
            transition: all 0.3s ease;
        }

        /* Sidebar User Section */
        .sidebar-user {
            margin-top: auto;
            padding: 1.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.8) 0%, rgba(30, 41, 59, 0.6) 100%);
            backdrop-filter: blur(8px);
        }

        .user-info {
            display: flex;
            align-items: center;
            margin-bottom: 1.25rem;
            padding: 1rem;
            background: rgba(59, 130, 246, 0.1);
            border-radius: 12px;
            border: 1px solid rgba(59, 130, 246, 0.2);
            transition: all 0.3s ease;
            min-width: 0;
            overflow: hidden;
        }

        .user-info:hover {
            background: rgba(59, 130, 246, 0.15);
            border-color: rgba(59, 130, 246, 0.3);
            transform: translateY(-1px);
        }

        .user-avatar {
            font-size: 2rem;
            margin-right: 1rem;
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            filter: drop-shadow(0 0 8px rgba(59, 130, 246, 0.3));
        }

        .user-details {
            flex: 1;
            min-width: 0;
            overflow: hidden;
        }

        .user-email {
            font-size: 0.95rem;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 0.25rem;
            letter-spacing: -0.025em;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 100%;
        }

        .user-status {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.7);
            display: flex;
            align-items: center;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            background: #10b981;
            border-radius: 50%;
            margin-right: 0.5rem;
            box-shadow: 0 0 8px rgba(16, 185, 129, 0.6);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .logout-btn {
            width: 100%;
            padding: 1rem;
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.15) 0%, rgba(220, 38, 38, 0.1) 100%);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #ffffff;
            border-radius: 12px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .logout-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.2) 0%, rgba(220, 38, 38, 0.15) 100%);
            transition: left 0.3s ease;
        }

        .logout-btn:hover {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.25) 0%, rgba(220, 38, 38, 0.2) 100%);
            border-color: rgba(239, 68, 68, 0.5);
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(239, 68, 68, 0.3);
        }

        .logout-btn:hover::before {
            left: 0;
        }

        .logout-btn i {
            margin-right: 0.75rem;
            transition: transform 0.3s ease;
        }

        .logout-btn:hover i {
            transform: translateX(-2px);
        }

        /* Sidebar Responsive Design */
        @media (max-width: 1024px) {
            .sidebar {
                width: 260px;
            }
            
            .main-content {
                margin-left: 260px;
            }
            
            .sidebar h1 {
                font-size: 1.5rem;
                padding: 2rem 1.5rem 1.25rem;
            }
            
            .nav-item {
                padding: 1rem 1.25rem;
                font-size: 0.9rem;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 240px;
                transform: translateX(-100%);
                transition: transform 0.3s ease;
                z-index: 1000;
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .sidebar.mobile-open {
                transform: translateX(0);
            }
            
            .sidebar h1 {
                font-size: 1.25rem;
                padding: 1.5rem 1rem 1rem;
            }
            
            .nav-item {
                padding: 0.875rem 1rem;
                font-size: 0.85rem;
            }
            
            .sidebar-user {
                padding: 1rem;
            }
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 2rem;
            margin-left: 280px;
            min-height: 100vh;
        }

        .header {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            margin-bottom: 2rem;
            border: 1px solid #f1f5f9;
        }

        .search-container {
            position: relative;
            margin-bottom: 2rem;
        }

        .search-box {
            width: 100%;
            padding: 1rem 1.25rem 1rem 3rem;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 500;
            background: #fafbfc;
            transition: all 0.3s ease;
            color: #374151;
        }

        .search-box:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
        }

        .search-box::placeholder {
            color: #9ca3af;
            font-weight: 400;
        }

        .search-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: #6b7280;
            font-size: 1.1rem;
        }

        .suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e1e5e9;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .suggestion-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            border-bottom: 1px solid #f3f4f6;
        }

        .suggestion-item:hover {
            background-color: #f3f4f6;
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        /* Filters */
        .filters {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            padding: 1.5rem;
            background: #f8fafc;
            border-radius: 10px;
            border: 1px solid #e2e8f0;
            align-items: center;
        }

        .filter-group {
            flex: 1;
            min-width: 200px;
        }

        .filter-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.375rem;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }

        .custom-dropdown {
            position: relative;
            width: 280px;
        }

        .dropdown-toggle {
            width: 100%;
            min-height: 48px;
            padding: 0.875rem 3rem 0.875rem 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .dropdown-toggle:hover {
            border-color: #667eea;
            background: #fafbfc;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .dropdown-toggle.active {
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
        }

        .dropdown-text {
            flex: 1;
            color: #374151;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .dropdown-text.placeholder {
            color: #9ca3af;
        }

        .dropdown-arrow {
            color: #6b7280;
            transition: transform 0.2s ease;
            margin-left: 0.5rem;
        }

        .dropdown-toggle.active .dropdown-arrow {
            transform: rotate(180deg);
        }

        .dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #e1e5e9;
            border-top: none;
            border-radius: 0 0 6px 6px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .dropdown-menu::-webkit-scrollbar {
            width: 6px;
        }

        .dropdown-menu::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        .dropdown-menu::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        .dropdown-menu::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        .dropdown-menu.show {
            display: block;
        }

        .dropdown-content {
            padding: 0.25rem 0;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 0.5rem 0.75rem;
            cursor: pointer;
            transition: background-color 0.15s ease;
        }

        .checkbox-item:hover {
            background-color: #f8fafc;
        }

        .checkbox-item input[type="checkbox"] {
            margin: 0;
            margin-right: 0.5rem;
            cursor: pointer;
            width: 16px;
            height: 16px;
            accent-color: #667eea;
        }

        .checkbox-item label {
            flex: 1;
            cursor: pointer;
            font-size: 0.9rem;
            color: #374151;
            margin: 0;
        }

        .filter-count {
            font-size: 0.8rem;
            color: #6b7280;
            margin-top: 0.5rem;
            font-weight: 500;
            background: #f1f5f9;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            display: inline-block;
        }

        .filters-left {
            display: flex;
            gap: 3rem;
            align-items: flex-end;
            justify-content: center;
        }

        .filter-actions {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            justify-content: center;
            width: 100%;
        }

        .clear-filters-btn {
            padding: 0.5rem;
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            color: #6b7280;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            width: 32px;
            min-height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 1.125rem; /* Align with dropdown buttons - label height (0.75rem + 0.375rem margin) */
            position: relative;
            flex-shrink: 0;
        }

        .clear-filters-btn:hover {
            background: #fee2e2;
            border-color: #fca5a5;
            color: #dc2626;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.15);
        }

        .clear-filters-btn i {
            margin-right: 0;
            font-size: 0.75rem;
        }

        /* Override flex alignment for the clear button's parent filter group */
        .clear-button-group {
            align-self: flex-start;
            margin-top: 0;
        }



        /* Upload Modal */
        .upload-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(8px);
        }

        .upload-modal-content {
            background: white;
            margin: 5% auto;
            padding: 2rem;
            border-radius: 16px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25), 0 10px 20px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .upload-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #e1e5e9;
        }

        .upload-modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #374151;
        }

        .upload-modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6b7280;
            padding: 0.5rem;
            border-radius: 6px;
        }

        .upload-modal-close:hover {
            background: #f3f4f6;
            color: #374151;
        }

        .upload-area {
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            padding: 3rem 2rem;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            margin-bottom: 1.5rem;
        }

        .upload-area:hover,
        .upload-area.drag-over {
            border-color: #3b82f6;
            background: #eff6ff;
        }

        .upload-area i {
            font-size: 3rem;
            color: #9ca3af;
            margin-bottom: 1rem;
        }

        .upload-area.drag-over i {
            color: #3b82f6;
        }

        .upload-area-text {
            color: #6b7280;
            font-size: 1rem;
            margin-bottom: 0.5rem;
        }

        .upload-area-subtext {
            color: #9ca3af;
            font-size: 0.875rem;
        }

        .selected-files {
            margin-bottom: 1.5rem;
        }

        .selected-files h4 {
            color: #374151;
            font-size: 1rem;
            margin-bottom: 0.75rem;
        }

        .file-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 0.5rem;
        }

        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem;
            background: #f8fafc;
            border-radius: 4px;
            margin-bottom: 0.5rem;
        }

        .file-item:last-child {
            margin-bottom: 0;
        }

        .file-name {
            font-size: 0.875rem;
            color: #374151;
            flex: 1;
        }

        .file-size {
            font-size: 0.75rem;
            color: #6b7280;
            margin-right: 0.5rem;
        }

        .file-remove {
            background: none;
            border: none;
            color: #dc2626;
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 4px;
        }

        .file-remove:hover {
            background: #fee2e2;
        }

        .upload-actions {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }

        .upload-btn {
            padding: 0.75rem 1.5rem;
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.2);
        }

        .upload-btn:hover {
            background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 16px rgba(59, 130, 246, 0.3);
        }

        .upload-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        .cancel-btn {
            padding: 0.75rem 1.5rem;
            background: #f3f4f6;
            color: #374151;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .cancel-btn:hover {
            background: #e5e7eb;
            transform: translateY(-1px);
        }

        .upload-progress {
            margin-top: 1rem;
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: #10b981;
            transition: width 0.3s ease;
        }

        .upload-status {
            margin-top: 0.5rem;
            font-size: 0.875rem;
            color: #6b7280;
        }

        /* Merge Employees Modal */
        .merge-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(8px);
        }

        .merge-modal-content {
            background: white;
            margin: 2% auto;
            padding: 2rem;
            border-radius: 16px;
            width: 95%;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25), 0 10px 20px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .merge-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #e1e5e9;
        }

        .merge-modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #374151;
        }

        .merge-modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6b7280;
            padding: 0.5rem;
            border-radius: 6px;
        }

        .merge-modal-close:hover {
            background: #f3f4f6;
            color: #374151;
        }

        .merge-step {
            margin-bottom: 2rem;
        }

        .merge-step h3 {
            color: #374151;
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
        }

        .merge-step h3 i {
            margin-right: 0.75rem;
            color: #3b82f6;
        }

        .merge-step p {
            color: #6b7280;
            margin-bottom: 1.5rem;
        }

        .merge-actions {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .find-duplicates-btn,
        .manual-select-btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
        }

        .find-duplicates-btn {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.2);
        }

        .find-duplicates-btn:hover {
            background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 16px rgba(59, 130, 246, 0.3);
        }

        .manual-select-btn {
            background: #f3f4f6;
            color: #374151;
            border: 1px solid #d1d5db;
        }

        .manual-select-btn:hover {
            background: #e5e7eb;
            transform: translateY(-1px);
        }

        .find-duplicates-btn i,
        .manual-select-btn i {
            margin-right: 0.5rem;
        }

        .merge-loading {
            text-align: center;
            padding: 2rem;
            color: #6b7280;
        }

        .merge-loading i {
            font-size: 2rem;
            margin-bottom: 1rem;
            color: #3b82f6;
        }

        /* Script Output Styles */
        .script-output-content {
            min-height: 300px;
        }

        #splitRolesOutputText {
            background: #f8fafc;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            padding: 1.5rem;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.85rem;
            line-height: 1.5;
            color: #374151;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 1.5rem;
        }

        .script-output-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            padding-top: 1rem;
            border-top: 1px solid #e1e5e9;
        }

        .refresh-data-btn,
        .close-output-btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
        }

        .refresh-data-btn {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.2);
        }

        .refresh-data-btn:hover {
            background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 16px rgba(59, 130, 246, 0.3);
        }

        .close-output-btn {
            background: #6b7280;
            color: white;
        }

        .close-output-btn:hover {
            background: #4b5563;
            transform: translateY(-1px);
        }

        .refresh-data-btn i,
        .close-output-btn i {
            margin-right: 0.5rem;
        }

        .duplicates-results h4 {
            color: #374151;
            font-size: 1rem;
            margin-bottom: 1rem;
        }

        .duplicates-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
        }

        .duplicate-item {
            padding: 1rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .duplicate-item:last-child {
            border-bottom: none;
        }

        .duplicate-info {
            flex: 1;
        }

        .duplicate-employees {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .duplicate-employees .employee-info {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .duplicate-employees .employee-info strong {
            font-size: 0.9rem;
            color: #374151;
        }

        .similarity-badge {
            background: #f0f9ff;
            color: #0369a1;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            margin-top: 0.25rem;
        }

        .merge-arrow {
            margin: 0 1rem;
            color: #667eea;
            font-size: 1.2rem;
        }

        .duplicate-stats {
            display: flex;
            gap: 1rem;
        }

        .duplicate-stats .stat {
            background: #f8fafc;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            color: #6b7280;
        }

        .select-duplicate-btn {
            padding: 0.5rem 1rem;
            background: #10b981;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }

        .select-duplicate-btn:hover {
            background: #059669;
        }

        .select-duplicate-btn i {
            margin-right: 0.5rem;
        }

        .no-duplicates-message {
            text-align: center;
            padding: 2rem;
            color: #10b981;
            background: #f0fdf4;
            border-radius: 8px;
            border: 1px solid #bbf7d0;
        }

        .no-duplicates-message i {
            font-size: 2rem;
            margin-bottom: 1rem;
        }

        .manual-selection h4 {
            color: #374151;
            font-size: 1rem;
            margin-bottom: 1rem;
        }

        .employee-selection-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .employee-selector label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
            margin-bottom: 0.5rem;
        }

        .employee-selector select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.9rem;
            background: white;
        }

        .manual-actions {
            display: flex;
            justify-content: center;
        }

        .preview-merge-btn {
            padding: 0.75rem 1.5rem;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .preview-merge-btn:hover:not(:disabled) {
            background: #5a6fd8;
        }

        .preview-merge-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        .preview-merge-btn i {
            margin-right: 0.5rem;
        }

        .merge-comparison {
            margin-bottom: 2rem;
        }

        .comparison-section {
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: #f8fafc;
            border-radius: 8px;
        }

        .comparison-section h4 {
            color: #374151;
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .employee-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }

        .employee-column {
            padding: 1rem;
            border-radius: 8px;
        }

        .primary-column {
            background: #f0f9ff;
            border: 2px solid #3b82f6;
        }

        .secondary-column {
            background: #fef3c7;
            border: 2px solid #f59e0b;
        }

        .employee-column h5 {
            color: #374151;
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
        }

        .employee-column h5 i {
            margin-right: 0.5rem;
        }

        .employee-details h6 {
            color: #374151;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .employee-details p {
            color: #6b7280;
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
        }

        .field-selection-options {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .field-option {
            padding: 1rem;
            background: white;
            border-radius: 6px;
            border: 1px solid #e5e7eb;
        }

        .field-option label {
            display: block;
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.5rem;
        }

        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .radio-group label {
            display: flex;
            align-items: center;
            font-weight: normal;
            cursor: pointer;
        }

        .radio-group input[type="radio"] {
            margin-right: 0.5rem;
        }

        .merge-impact-summary {
            padding: 1rem;
            background: white;
            border-radius: 6px;
            border: 1px solid #e5e7eb;
        }

        .impact-stats {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .impact-stat {
            padding: 0.5rem;
            background: #f8fafc;
            border-radius: 4px;
            font-size: 0.875rem;
        }

        .impact-stat.warning {
            background: #fef3c7;
            color: #d97706;
        }

        .merge-preview-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 2rem;
        }

        .back-to-selection-btn,
        .confirm-merge-btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .back-to-selection-btn {
            background: #f3f4f6;
            color: #374151;
            border: 1px solid #d1d5db;
        }

        .back-to-selection-btn:hover {
            background: #e5e7eb;
        }

        .confirm-merge-btn {
            background: #dc2626;
            color: white;
        }

        .confirm-merge-btn:hover {
            background: #b91c1c;
        }

        .back-to-selection-btn i,
        .confirm-merge-btn i {
            margin-right: 0.5rem;
        }

        .merge-results {
            text-align: center;
        }

        .merge-success {
            padding: 2rem;
        }

        .success-icon {
            font-size: 3rem;
            color: #10b981;
            margin-bottom: 1rem;
        }

        .merge-success h4 {
            color: #374151;
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .merge-summary p {
            color: #6b7280;
            margin-bottom: 1.5rem;
        }

        .merge-stats {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin-bottom: 1.5rem;
        }

        .merge-stats .stat {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 600;
            color: #10b981;
        }

        .stat-label {
            font-size: 0.875rem;
            color: #6b7280;
        }

        .merge-time {
            font-size: 0.875rem;
            color: #9ca3af;
        }

        .merge-error {
            padding: 2rem;
            text-align: center;
        }

        .error-icon {
            font-size: 3rem;
            color: #dc2626;
            margin-bottom: 1rem;
        }

        .merge-error h4 {
            color: #374151;
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .error-message {
            background: #fef2f2;
            color: #dc2626;
            padding: 1rem;
            border-radius: 6px;
            border: 1px solid #fecaca;
            margin: 1rem 0;
            font-family: monospace;
            font-size: 0.875rem;
        }

        .merge-completion-actions {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 2rem;
        }

        .close-merge-btn,
        .refresh-data-btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .close-merge-btn {
            background: #f3f4f6;
            color: #374151;
            border: 1px solid #d1d5db;
        }

        .close-merge-btn:hover {
            background: #e5e7eb;
        }

        .refresh-data-btn {
            background: #10b981;
            color: white;
        }

        .refresh-data-btn:hover {
            background: #059669;
        }

        .close-merge-btn i,
        .refresh-data-btn i {
            margin-right: 0.5rem;
        }

        /* Merge Dropdown */
        .merge-dropdown {
            position: relative;
            display: inline-block;
        }

        .merge-btn {
            padding: 0.875rem 1.75rem;
            background: #8b5cf6;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: 0 2px 8px rgba(139, 92, 246, 0.2);
        }

        .merge-btn:hover {
            background: #7c3aed;
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(139, 92, 246, 0.3);
        }

        /* Delete Employee Button */
        .delete-employee-btn {
            padding: 0.875rem 1.75rem;
            background: #dc2626;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-right: 0.75rem;
            box-shadow: 0 2px 8px rgba(220, 38, 38, 0.2);
        }

        .delete-employee-btn:hover {
            background: #b91c1c;
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(220, 38, 38, 0.3);
        }

        .delete-employee-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }

        /* Refresh Data Button */
        .refresh-data-btn {
            padding: 0.875rem 1.75rem;
            background: #059669;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-right: 0.75rem;
            box-shadow: 0 2px 8px rgba(5, 150, 105, 0.2);
        }

        .refresh-data-btn:hover {
            background: #047857;
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(5, 150, 105, 0.3);
        }

        .refresh-data-btn.spinning i {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .merge-btn .fa-chevron-down {
            font-size: 0.7rem;
            transition: transform 0.3s ease;
        }

        .merge-dropdown.active .fa-chevron-down {
            transform: rotate(180deg);
        }

        .merge-dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            background-color: white;
            min-width: 200px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            border-radius: 8px;
            z-index: 1000;
            border: 1px solid #e5e7eb;
            overflow: hidden;
            top: 100%;
            margin-top: 0.5rem;
        }

        .merge-dropdown.active .merge-dropdown-content {
            display: block;
            animation: dropdownFadeIn 0.3s ease-out;
        }

        @keyframes dropdownFadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .merge-option {
            display: flex;
            align-items: center;
            width: 100%;
            padding: 0.75rem 1rem;
            background: none;
            border: none;
            text-align: left;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #374151;
            font-size: 0.9rem;
            gap: 0.75rem;
        }

        .merge-option:hover {
            background-color: #f3f4f6;
            color: #1f2937;
        }

        .merge-option:not(:last-child) {
            border-bottom: 1px solid #e5e7eb;
        }

        .merge-option i {
            width: 16px;
            color: #6b7280;
        }

        .merge-option:hover i {
            color: #374151;
        }

        /* Upload Dropdown */
        .upload-dropdown {
            position: relative;
            display: inline-block;
            margin-right: 0.75rem;
        }

        .upload-btn {
            padding: 0.875rem 1.75rem;
            background: #f59e0b;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: 0 2px 8px rgba(245, 158, 11, 0.2);
        }

        .upload-btn:hover {
            background: #d97706;
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(245, 158, 11, 0.3);
        }

        .upload-btn .fa-chevron-down {
            font-size: 0.7rem;
            transition: transform 0.3s ease;
        }

        .upload-dropdown.active .fa-chevron-down {
            transform: rotate(180deg);
        }

        .upload-dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            background-color: white;
            min-width: 200px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            border-radius: 8px;
            z-index: 1000;
            border: 1px solid #e5e7eb;
            overflow: hidden;
            top: 100%;
            margin-top: 0.5rem;
        }

        .upload-dropdown.active .upload-dropdown-content {
            display: block;
            animation: dropdownFadeIn 0.3s ease-out;
        }

        .upload-option {
            display: flex;
            align-items: center;
            width: 100%;
            padding: 0.75rem 1rem;
            background: none;
            border: none;
            text-align: left;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #374151;
            font-size: 0.9rem;
            gap: 0.75rem;
        }

        .upload-option:hover {
            background-color: #f3f4f6;
            color: #1f2937;
        }

        .upload-option:not(:last-child) {
            border-bottom: 1px solid #e5e7eb;
        }

        .upload-option i {
            width: 16px;
            color: #6b7280;
        }

        .upload-option:hover i {
            color: #374151;
        }

        /* Content Area */
        .content {
            background: #f8fafc;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            overflow: hidden;
            padding: 1.5rem;
        }

        .content-header {
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
            color: white;
            padding: 1.5rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 12px;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 12px rgba(30, 64, 175, 0.3);
        }

        .content-header h2 {
            font-size: 1.5rem;
            font-weight: 700;
            margin: 0;
            letter-spacing: -0.025em;
        }

        .results-count {
            font-size: 0.9rem;
            opacity: 0.9;
            background: rgba(255, 255, 255, 0.2);
            padding: 0.375rem 0.75rem;
            border-radius: 16px;
            font-weight: 600;
            backdrop-filter: blur(4px);
        }

        /* Table */
        .table-container {
            overflow-x: auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            border-radius: 12px;
            overflow: hidden;
        }

        th, td {
            padding: 1.75rem 2rem;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
            vertical-align: top;
        }

        th {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            font-weight: 700;
            color: #1f2937;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            position: sticky;
            top: 0;
            z-index: 10;
            border-bottom: 2px solid #e5e7eb;
        }

        th:first-child {
            border-top-left-radius: 12px;
        }

        th:last-child {
            border-top-right-radius: 12px;
        }

        tbody tr {
            transition: all 0.2s ease;
            background: white;
        }

        tbody tr:hover {
            background: linear-gradient(135deg, #f8fafc 0%, #f0f9ff 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        tbody tr:last-child td:first-child {
            border-bottom-left-radius: 12px;
        }

        tbody tr:last-child td:last-child {
            border-bottom-right-radius: 12px;
        }

        tbody tr:last-child td {
            border-bottom: none;
        }

        .employee-name {
            font-weight: 700;
            color: #1e40af;
            font-size: 1.05rem;
            line-height: 1.4;
            cursor: pointer;
            transition: color 0.2s ease;
        }

        .employee-name:hover {
            color: #1d4ed8;
            text-decoration: underline;
        }

        .team-badge {
            background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);
            color: white;
            padding: 0.375rem 0.875rem;
            border-radius: 16px;
            font-size: 0.75rem;
            font-weight: 600;
            display: inline-block;
            margin: 0.125rem 0.375rem 0.125rem 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 180px;
            line-height: 1.3;
            vertical-align: middle;
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3);
            transition: all 0.2s ease;
        }

        .team-badge:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(59, 130, 246, 0.4);
        }

        .team-badges-container {
            display: flex;
            flex-wrap: wrap;
            gap: 0.375rem;
            align-items: center;
            line-height: 1.6;
        }

        .role-text {
            color: #4b5563;
            font-size: 0.95rem;
            line-height: 1.5;
            font-weight: 500;
        }

        .projects-count {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 600;
            display: inline-block;
            box-shadow: 0 2px 4px rgba(16, 185, 129, 0.3);
            transition: all 0.2s ease;
        }

        .projects-count:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(16, 185, 129, 0.4);
        }

        /* Clickable row styling */
        .clickable-row {
            cursor: pointer;
        }

        .clickable-row:active {
            transform: scale(0.995);
        }

        /* Table responsiveness improvements */
        @media (max-width: 768px) {
            th, td {
                padding: 1rem 1.25rem;
                font-size: 0.875rem;
            }
            
            .employee-name {
                font-size: 1rem;
            }
            
            .team-badge {
                font-size: 0.7rem;
                padding: 0.25rem 0.625rem;
                max-width: 120px;
            }
        }

        .experience-badge {
            background-color: #f0f9ff;
            color: #0369a1;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        /* Loading and Empty States */
        .loading, .empty-state {
            text-align: center;
            padding: 3rem;
            color: #6b7280;
        }

        .loading i {
            font-size: 2rem;
            margin-bottom: 1rem;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Employee Detail View */
        .detail-header {
            display: flex;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #e1e5e9;
        }

        .back-btn {
            display: flex;
            align-items: center;
            padding: 0.75rem 1.5rem;
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            margin-right: 1.5rem;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
        }

        .back-btn:hover {
            background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(59, 130, 246, 0.3);
        }

        .back-btn i {
            margin-right: 0.5rem;
        }

        .employee-detail-container {
            background: white;
            border-radius: 10px;
            padding: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .detail-sections {
            display: grid;
            gap: 2rem;
        }

        .detail-section {
            background: #f8fafc;
            border-radius: 12px;
            padding: 1.5rem;
            border-left: 4px solid #3b82f6;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }

        .detail-section:hover {
            box-shadow: 0 4px 16px rgba(59, 130, 246, 0.1);
            transform: translateY(-1px);
        }

        .detail-section h3 {
            color: #374151;
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
        }

        .detail-section h3 i {
            margin-right: 0.75rem;
            color: #3b82f6;
            width: 20px;
            text-align: center;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
        }

        .detail-item label {
            font-size: 0.75rem;
            font-weight: 600;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.025em;
            margin-bottom: 0.25rem;
        }

        .detail-item span {
            font-size: 0.95rem;
            color: #374151;
            font-weight: 500;
        }

        /* Edit functionality styles */
        .detail-item {
            position: relative;
        }

        .edit-icon {
            position: absolute;
            top: 0;
            right: 0;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 6px;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: all 0.3s ease;
        }

        .detail-item:hover .edit-icon {
            opacity: 1;
        }

        .edit-icon:hover {
            background: #2563eb;
            transform: scale(1.05);
        }

        .edit-mode input,
        .edit-mode textarea {
            width: 100%;
            padding: 0.5rem;
            border: 2px solid #3b82f6;
            border-radius: 6px;
            font-size: 0.95rem;
            color: #374151;
            background: white;
            transition: all 0.3s ease;
        }

        .edit-mode input:focus,
        .edit-mode textarea:focus {
            outline: none;
            border-color: #1d4ed8;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .edit-mode textarea {
            min-height: 80px;
            resize: vertical;
        }

        .edit-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .save-btn, .cancel-btn {
            padding: 0.25rem 0.75rem;
            border: none;
            border-radius: 4px;
            font-size: 0.8rem;
            cursor: pointer;
            font-weight: 500;
        }

        .save-btn {
            background: #10b981;
            color: white;
        }

        .save-btn:hover {
            background: #059669;
        }

        .cancel-btn {
            background: #6b7280;
            color: white;
        }

        .cancel-btn:hover {
            background: #4b5563;
        }

        .edit-content-wrapper {
            position: relative;
        }

        .edit-content-icon {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 6px;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.7;
            transition: all 0.3s ease;
            z-index: 10;
        }

        .edit-content-wrapper:hover .edit-content-icon {
            opacity: 1;
        }

        .edit-content-icon:hover {
            background: #2563eb;
            transform: scale(1.05);
        }

        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            color: #6b7280;
        }

        .project-edit-icon {
            position: absolute;
            top: 0.5rem;
            right: 2.25rem;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 6px;
            width: 22px;
            height: 22px;
            cursor: pointer;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.7;
            transition: all 0.3s ease;
            z-index: 10;
        }

        .project-item:hover .project-edit-icon {
            opacity: 1;
            transform: scale(1.05);
        }

        .project-edit-icon:hover {
            background: #2563eb;
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3);
        }

        .project-delete-icon {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: #dc2626;
            color: white;
            border: none;
            border-radius: 4px;
            width: 22px;
            height: 22px;
            cursor: pointer;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.7;
            transition: all 0.2s ease;
            z-index: 10;
        }

        .project-item:hover .project-delete-icon {
            opacity: 1;
            transform: scale(1.05);
        }

        .project-delete-icon:hover {
            background: #b91c1c;
            box-shadow: 0 2px 4px rgba(220, 38, 38, 0.3);
        }

        .project-delete-icon-disabled {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: #9ca3af;
            color: white;
            border: none;
            border-radius: 4px;
            width: 22px;
            height: 22px;
            cursor: not-allowed;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.5;
            z-index: 10;
        }

        .project-item {
            position: relative;
        }

        .edit-qualifications-form,
        .edit-teams-form,
        .edit-project-form {
            padding: 1rem;
            background: #f8fafc;
            border-radius: 8px;
            border: 2px solid #3b82f6;
            margin-bottom: 1rem;
            position: relative;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.1);
        }

        .qualification-field,
        .team-field,
        .project-field {
            margin-bottom: 1rem;
        }

        .qualification-field label,
        .team-field label,
        .project-field label {
            display: block;
            font-size: 0.85rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.5rem;
        }

        .qualification-field textarea,
        .team-field textarea,
        .project-field textarea,
        .project-field input {
            width: 100%;
            min-height: 40px;
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .project-field textarea {
            min-height: 80px;
            resize: vertical;
        }

        .qualification-field textarea:focus,
        .team-field textarea:focus,
        .project-field textarea:focus,
        .project-field input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .project-edit-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #e1e5e9;
        }

        .project-edit-header h4 {
            margin: 0;
            color: #374151;
            font-size: 1.1rem;
        }

        .close-edit-btn {
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 4px;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-edit-btn:hover {
            background: #dc2626;
        }

        .detail-content {
            color: #374151;
            line-height: 1.6;
        }

        .detail-content ul {
            margin: 0;
            padding-left: 1.5rem;
        }

        .detail-content li {
            margin-bottom: 0.5rem;
        }

        .project-item {
            background: white;
            border-radius: 6px;
            padding: 1rem;
            margin-bottom: 1rem;
            border: 1px solid #e1e5e9;
        }

        .project-item h4 {
            color: #374151;
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .project-item .project-meta {
            display: flex;
            gap: 1rem;
            margin-bottom: 0.5rem;
            font-size: 0.85rem;
            color: #6b7280;
        }

        .project-item .project-description {
            font-size: 0.9rem;
            color: #374151;
            line-height: 1.5;
        }

        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            background: #667eea;
            color: white;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
            margin: 0.25rem 0.25rem 0 0;
        }

        .team-item {
            background: white;
            border-radius: 6px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            border: 1px solid #e1e5e9;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .team-name {
            font-weight: 600;
            color: #374151;
        }

        .team-roles {
            font-size: 0.85rem;
            color: #6b7280;
        }

        .clickable-row {
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .clickable-row:hover {
            background-color: #f8fafc;
        }

        /* Responsive Design - Mobile First Approach */
        
        /* Small devices (landscape phones, 576px and up) */
        @media (max-width: 575.98px) {
            body {
                font-size: 14px;
            }
            
            .container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                order: 2;
                padding: 1rem 0;
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                z-index: 100;
                box-shadow: 0 -4px 20px rgba(0,0,0,0.15);
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            }
            
            .sidebar h1 {
                display: none;
            }
            
            .nav-section {
                margin: 0;
                display: flex;
                justify-content: space-around;
            }
            
            .nav-item {
                padding: 0.75rem 0.5rem;
                flex-direction: column;
                align-items: center;
                border-left: none;
                border-top: 3px solid transparent;
                min-width: 0;
                flex: 1;
                text-align: center;
            }
            
            .nav-item:hover, .nav-item.active {
                background-color: rgba(255,255,255,0.1);
                border-left-color: transparent;
                border-top-color: #fff;
            }
            
            .nav-item i {
                margin-right: 0;
                margin-bottom: 0.25rem;
                font-size: 1.2rem;
            }
            
            .nav-item span {
                font-size: 0.75rem;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }
            
            .main-content {
                order: 1;
                padding: 1rem;
                padding-bottom: 5rem; /* Space for bottom navigation */
            }
            
            .header {
                padding: 1rem;
                margin-bottom: 1rem;
            }
            
            .search-box {
                font-size: 16px; /* Prevent zoom on iOS */
                padding: 0.875rem 1rem 0.875rem 2.5rem;
            }
            
            .filters {
                flex-direction: column;
                gap: 0.75rem;
            }
            
            .filters-left {
                flex-direction: column;
                gap: 0.75rem;
            }
            
            .filter-group {
                min-width: 100%;
                max-width: none;
            }
            
            .filter-actions {
                flex-direction: column;
                align-items: stretch;
                gap: 0.75rem;
            }
            
            .clear-filters-btn,
            .upload-btn,
            .merge-btn {
                padding: 0.875rem 1rem;
                font-size: 0.9rem;
                text-align: center;
                justify-content: center;
                min-height: 44px; /* Touch target size */
            }
            
            .merge-dropdown {
                width: 100%;
            }
            
            .merge-dropdown-content {
                position: relative;
                display: block !important;
                box-shadow: none;
                border: 1px solid #e5e7eb;
                border-radius: 8px;
                margin-top: 0.5rem;
                animation: none;
            }
            
            .table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            table {
                min-width: 600px;
            }
            
            .detail-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .detail-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }

            .back-btn {
                margin-right: 0;
                padding: 0.875rem 1.5rem;
                min-height: 44px;
            }

            .employee-detail-container {
                padding: 1rem;
            }
            
            .detail-section {
                padding: 1rem;
            }
            
            .dropdown-toggle {
                min-height: 48px;
                font-size: 16px;
            }
            
            .dropdown-menu {
                max-height: 250px;
            }
            
            .team-badge {
                font-size: 0.7rem;
                padding: 0.2rem 0.5rem;
                max-width: 150px;
            }
            
            .team-badges-container {
                gap: 0.15rem;
                min-height: 24px;
            }
        }
        
        /* Medium devices (tablets, 768px and up) */
        @media (min-width: 576px) and (max-width: 991.98px) {
            .container {
                flex-direction: row;
            }
            
            .sidebar {
                width: 200px;
                min-width: 200px;
            }
            
            .sidebar h1 {
                font-size: 1.25rem;
            }
            
            .main-content {
                padding: 1.5rem;
            }
            
            .header {
                padding: 1.25rem;
            }
            
            .filters {
                flex-wrap: wrap;
                gap: 1rem;
            }
            
            .filters-left {
                flex-wrap: wrap;
                gap: 1rem;
            }
            
            .filter-group {
                min-width: 160px;
                flex: 1;
                max-width: 200px;
            }
            
            .filter-actions {
                flex-direction: row;
                flex-wrap: wrap;
                gap: 0.75rem;
            }
            
            .detail-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }
            
            .table-container {
                overflow-x: auto;
            }
            
            .team-badge {
                font-size: 0.75rem;
                max-width: 180px;
            }
            
            .team-badges-container {
                gap: 0.2rem;
                min-height: 26px;
            }
        }
        
        /* Large devices (desktops, 992px and up) */
        @media (min-width: 992px) {
            .sidebar {
                width: 250px;
            }
            
            .filter-group {
                min-width: 180px;
                max-width: 250px;
            }
            
            .detail-grid {
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            }
        }
        
        /* Extra large devices (large desktops, 1200px and up) */
        @media (min-width: 1200px) {
            .main-content {
                max-width: 1400px;
            }
            
            .filter-group {
                max-width: 280px;
            }
        }
        
        /* Touch device optimizations */
        @media (hover: none) and (pointer: coarse) {
            .nav-item,
            .dropdown-toggle,
            .clear-filters-btn,
            .upload-btn,
            .upload-option,
            .merge-btn,
            .merge-option,
            .back-btn,
            .suggestion-item {
                min-height: 44px;
            }
            
            .checkbox-item {
                padding: 0.75rem;
            }
            
            .clickable-row {
                cursor: default;
            }
            
            .clickable-row:active {
                background-color: #f0f4f8;
            }
        }
        
        /* High DPI displays */
        @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
            .sidebar {
                box-shadow: 3px 0 15px rgba(0,0,0,0.15);
            }
        }

        /* Section E Resume Styles */
        .section-e-actions {
            text-align: center;
            padding: 1rem 0;
        }

        .create-resume-btn {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .create-resume-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .create-resume-btn i {
            font-size: 1.1rem;
        }

        /* Section E Modal Styles */
        .section-e-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(8px);
            overflow-y: auto;
        }

        .section-e-modal-content {
            background-color: white;
            margin: 2% auto;
            padding: 0;
            border-radius: 16px;
            width: 90%;
            max-width: 900px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25), 0 10px 20px rgba(0, 0, 0, 0.1);
            position: relative;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .section-e-modal-header {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            padding: 1.5rem 2rem;
            border-radius: 16px 16px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            overflow: hidden;
        }

        .section-e-modal-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);
            opacity: 0.3;
        }

        .section-e-modal-header h2 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 600;
            position: relative;
            z-index: 1;
        }

        .section-e-close {
            color: white;
            font-size: 2rem;
            font-weight: bold;
            cursor: pointer;
            border: none;
            background: none;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
            position: relative;
            z-index: 1;
        }

        .section-e-close:hover {
            background-color: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }

        .section-e-modal-body {
            padding: 2rem;
            max-height: 80vh;
            overflow-y: auto;
        }

        .section-e-form-section {
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: #f8fafc;
            border-radius: 12px;
            border-left: 4px solid #3b82f6;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }

        .section-e-form-section:hover {
            box-shadow: 0 4px 16px rgba(59, 130, 246, 0.1);
            transform: translateY(-1px);
        }

        .section-e-form-section h3 {
            margin: 0 0 1rem 0;
            color: #374151;
            font-size: 1.2rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .section-e-form-section h3 i {
            color: #3b82f6;
        }

        .section-e-form-group {
            margin-bottom: 1rem;
        }

        .section-e-form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #374151;
        }

        .section-e-form-group input,
        .section-e-form-group textarea,
        .section-e-form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e1e5e9;
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.2s ease;
        }

        .section-e-form-group input:focus,
        .section-e-form-group textarea:focus,
        .section-e-form-group select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .section-e-form-group textarea {
            min-height: 80px;
            resize: vertical;
        }

        .section-e-form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .projects-list {
            margin-top: 1rem;
        }

        .project-entry {
            background: white;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            position: relative;
        }

        .project-entry-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .project-entry-header h4 {
            margin: 0;
            color: #374151;
            font-size: 1.1rem;
        }

        .remove-project-btn {
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s ease;
        }

        .remove-project-btn:hover {
            background: #dc2626;
        }

        .add-project-btn {
            background: #10b981;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 0.75rem 1rem;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: background-color 0.2s ease;
        }

        .add-project-btn:hover {
            background: #059669;
        }

        /* New styles for updated Section E interface */
        .selected-projects-list {
            min-height: 200px;
            border: 2px dashed #e5e7eb;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 1rem;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .selected-projects-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            height: 160px;
        }

        .selected-project-item {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .selected-project-item:hover {
            border-color: #3b82f6;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.1);
        }

        .selected-project-content {
            flex: 1;
        }

        .selected-project-title {
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 5px;
        }

        .selected-project-meta {
            font-size: 0.875rem;
            color: #64748b;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .remove-selected-project-btn {
            background: #ef4444;
            color: white;
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            flex-shrink: 0;
        }

        .remove-selected-project-btn:hover {
            background: #dc2626;
        }

        .projects-action-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 1rem;
        }

        .add-custom-project-btn {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.2);
        }

        .add-custom-project-btn:hover {
            background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(59, 130, 246, 0.3);
        }

        .find-relevant-projects-btn {
            background: #f59e0b;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .find-relevant-projects-btn:hover {
            background: #d97706;
            transform: translateY(-1px);
        }

        .ai-writeup-btn {
            background: linear-gradient(135deg, #8b5cf6 0%, #a855f7 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .ai-writeup-btn:hover {
            background: linear-gradient(135deg, #7c3aed 0%, #9333ea 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
        }

        .use-this-btn {
            background: #10b981;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
            margin: 0 10px;
            transition: all 0.2s ease;
        }

        .use-this-btn:hover {
            background: #059669;
            transform: translateY(-1px);
        }

        .ai-rewrite-btn {
            background: linear-gradient(135deg, #8b5cf6 0%, #a855f7 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
            margin: 0 10px;
            transition: all 0.2s ease;
        }

        .ai-rewrite-btn:hover {
            background: linear-gradient(135deg, #7c3aed 0%, #9333ea 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
        }

        .ai-generate-btn {
            background: linear-gradient(135deg, #8b5cf6 0%, #a855f7 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .ai-generate-btn:hover {
            background: linear-gradient(135deg, #7c3aed 0%, #9333ea 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
        }

        .projects-count-info {
            text-align: center;
            font-size: 0.875rem;
            color: #64748b;
            font-weight: 500;
        }

        /* Professional Registration Styles */
        .selected-registration-display {
            min-height: 80px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 1rem;
            background: #f9fafb;
        }

        .selected-registration-placeholder {
            text-align: center;
            color: #6b7280;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .selected-registration-item {
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            padding: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .registration-info {
            flex: 1;
        }

        .registration-text {
            color: #374151;
            font-weight: 500;
        }

        .remove-registration-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 6px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75rem;
        }

        .remove-registration-btn:hover {
            background: #dc2626;
        }

        .registration-action-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 1rem;
        }

        .select-registration-btn {
            background: #059669;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .select-registration-btn:hover {
            background: #047857;
            transform: translateY(-1px);
        }

        /* Professional Qualifications Styles */
        .selected-qualifications-list {
            min-height: 100px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 1rem;
            background: #f9fafb;
        }

        .selected-qualifications-placeholder {
            text-align: center;
            color: #6b7280;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .selected-qualification-item {
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .qualification-info {
            flex: 1;
        }

        .qualification-type {
            font-size: 0.75rem;
            color: #6b7280;
            text-transform: uppercase;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .qualification-text {
            color: #374151;
            font-weight: 500;
        }

        .remove-qualification-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 6px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75rem;
        }

        .remove-qualification-btn:hover {
            background: #dc2626;
        }

        .qualifications-action-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 1rem;
        }

        .add-qualifications-btn {
            background: #059669;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .add-qualifications-btn:hover {
            background: #047857;
            transform: translateY(-1px);
        }

        .add-custom-qualification-btn {
            background: #6366f1;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .add-custom-qualification-btn:hover {
            background: #4f46e5;
            transform: translateY(-1px);
        }

        .qualifications-count-info {
            text-align: center;
            font-size: 0.875rem;
            color: #64748b;
            font-weight: 500;
        }

        /* Qualifications Modal Styles */
        .qualifications-section {
            margin-bottom: 1.5rem;
        }

        .qualifications-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 12px;
            margin-bottom: 1rem;
        }

        .qualification-option {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .qualification-option:hover {
            border-color: #3b82f6;
            background: #eff6ff;
        }

        .qualification-option.selected {
            border-color: #059669;
            background: #ecfdf5;
        }

        .qualification-checkbox {
            width: 16px;
            height: 16px;
            accent-color: #059669;
        }

        .qualification-label {
            flex: 1;
            font-weight: 500;
            color: #374151;
        }

        /* Modal Overlay Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        /* Project Selection Modal Styles */
        .project-selection-modal {
            background: white;
            border-radius: 16px;
            max-width: 800px;
            width: 90vw;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25), 0 10px 20px rgba(0, 0, 0, 0.1);
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1001;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        #projectSelectionModal {
            z-index: 1000;
        }

        .project-selection-header {
            padding: 20px 24px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .project-selection-header h2 {
            margin: 0;
            color: #1e293b;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .close-modal-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #64748b;
            padding: 5px;
            border-radius: 4px;
        }

        .close-modal-btn:hover {
            background: #f1f5f9;
            color: #334155;
        }

        .project-selection-content {
            padding: 24px;
            flex: 1;
            overflow-y: auto;
        }

        .project-selection-info {
            margin-bottom: 20px;
            text-align: center;
        }

        .project-selection-info p {
            margin: 0 0 10px 0;
            color: #475569;
        }

        .selection-counter {
            font-weight: 600;
            color: #3b82f6;
        }

        .available-projects-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-height: 400px;
            overflow-y: auto;
            padding-right: 8px;
        }

        .available-project-item {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .available-project-item:hover {
            border-color: #3b82f6;
            background: #eff6ff;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.1);
        }

        .available-project-item.selected {
            border-color: #3b82f6;
            background: #eff6ff;
        }

        .available-project-item.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: #f1f5f9;
        }

        .project-checkbox {
            margin-top: 2px;
            width: 16px;
            height: 16px;
            accent-color: #3b82f6;
        }

        .available-project-content {
            flex: 1;
        }

        .available-project-title {
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 8px;
            line-height: 1.4;
        }

        .available-project-meta {
            display: flex;
            gap: 20px;
            margin-bottom: 8px;
            font-size: 0.875rem;
            color: #64748b;
            flex-wrap: wrap;
        }

        .available-project-description {
            font-size: 0.875rem;
            color: #475569;
            line-height: 1.4;
            max-height: 60px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .project-selection-footer {
            padding: 20px 24px;
            border-top: 1px solid #e5e7eb;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        .project-selection-cancel-btn {
            padding: 10px 20px;
            border: 1px solid #d1d5db;
            background: white;
            color: #374151;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .project-selection-cancel-btn:hover {
            background: #f9fafb;
            transform: translateY(-1px);
        }

        .project-selection-add-btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.2);
        }

        .project-selection-add-btn:hover {
            background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 16px rgba(59, 130, 246, 0.3);
        }

        .project-selection-add-btn:disabled {
            background: #d1d5db;
            cursor: not-allowed;
        }

        /* Solicitation Analysis Modal Styles */
        .solicitation-analysis-modal {
            background: white;
            border-radius: 16px;
            max-width: 900px;
            width: 90vw;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25), 0 10px 20px rgba(0, 0, 0, 0.1);
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1001;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .solicitation-upload-area {
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            margin-bottom: 20px;
            transition: all 0.2s ease;
            cursor: pointer;
            background: #f9fafb;
        }

        .solicitation-upload-area:hover {
            border-color: #f59e0b;
            background: #fffbeb;
        }

        .solicitation-upload-area.drag-over {
            border-color: #f59e0b;
            background: #fffbeb;
        }

        .upload-icon {
            font-size: 3rem;
            color: #d1d5db;
            margin-bottom: 1rem;
        }

        .upload-text {
            color: #6b7280;
            margin-bottom: 0.5rem;
        }

        .upload-subtext {
            color: #9ca3af;
            font-size: 0.875rem;
        }

        .file-upload-input {
            display: none;
        }

        .analysis-progress {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .progress-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e5e7eb;
            border-top: 4px solid #f59e0b;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .keywords-section {
            display: none;
            margin-top: 20px;
        }

        .keywords-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .keyword-item {
            background: #f3f4f6;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            padding: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .keyword-item:hover {
            border-color: #f59e0b;
            background: #fffbeb;
        }

        .keyword-item.selected {
            border-color: #f59e0b;
            background: #fef3c7;
        }

        .keyword-checkbox {
            width: 16px;
            height: 16px;
            accent-color: #f59e0b;
        }

        .keyword-text {
            flex: 1;
            font-size: 0.875rem;
            color: #374151;
        }

        .suggested-projects-section {
            display: none;
            margin-top: 20px;
        }

        .suggested-project-item {
            background: #f0f9ff;
            border: 2px solid #0ea5e9;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            position: relative;
        }

        .suggested-project-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .suggested-project-title {
            font-weight: 600;
            color: #0c4a6e;
            margin-bottom: 4px;
        }

        .suggested-project-meta {
            font-size: 0.875rem;
            color: #075985;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .match-score {
            background: #0ea5e9;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .matched-keywords {
            margin-top: 8px;
            font-size: 0.875rem;
            color: #374151;
        }

        .matched-keyword-tag {
            display: inline-block;
            background: #fef3c7;
            color: #92400e;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.75rem;
            margin-right: 4px;
            margin-bottom: 2px;
        }

        .add-suggested-project-btn {
            background: #059669;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .add-suggested-project-btn:hover {
            background: #047857;
        }

        .add-suggested-project-btn:disabled {
            background: #d1d5db;
            cursor: not-allowed;
        }

        .section-e-modal-footer {
            padding: 1.5rem 2rem;
            background: #f8fafc;
            border-radius: 0 0 16px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top: 1px solid #e1e5e9;
        }

        .section-e-generate-btn {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 0.75rem 2rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            position: relative;
            overflow: hidden;
        }

        .section-e-generate-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);
            transition: left 0.3s ease;
        }

        .section-e-generate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(59, 130, 246, 0.4);
        }

        .section-e-generate-btn:hover::before {
            left: 0;
        }

        .section-e-cancel-btn {
            background: #6b7280;
            color: white;
            border: none;
            border-radius: 10px;
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .section-e-cancel-btn:hover {
            background: #4b5563;
            transform: translateY(-1px);
        }

        /* Template Selection Styles */
        .template-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .template-card {
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
            background: white;
            position: relative;
        }

        .template-card:hover {
            border-color: #3b82f6;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.15);
        }

        .template-card.selected {
            border-color: #3b82f6;
            background: #f8fafc;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .template-card.selected::before {
            content: '\f00c';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: #3b82f6;
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
        }

        .template-preview {
            width: 100%;
            height: 120px;
            background: #f3f4f6;
            border-radius: 4px;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6b7280;
            overflow: hidden;
        }

        .template-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 4px;
        }

        .template-preview-placeholder {
            text-align: center;
        }

        .template-preview-placeholder i {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            display: block;
        }

        .template-name {
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.25rem;
        }

        .template-description {
            font-size: 0.875rem;
            color: #6b7280;
            line-height: 1.4;
        }

        .template-default-badge {
            background: #10b981;
            color: white;
            font-size: 0.75rem;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 0.5rem;
        }

        .template-loading {
            text-align: center;
            padding: 2rem;
            color: #6b7280;
        }

        .template-error {
            text-align: center;
            padding: 2rem;
            color: #ef4444;
            background: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: 6px;
        }

        /* DOCX Template Specific Styles */
        .template-card.docx-template {
            border-color: #2563eb;
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
        }

        .template-card.docx-template:hover {
            border-color: #1d4ed8;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);
        }

        .template-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.5rem;
        }

        .template-type-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .template-type-badge.pdf {
            background: #fef3c7;
            color: #92400e;
        }

        .template-type-badge.docx {
            background: #dbeafe;
            color: #1e40af;
        }

        .docx-features {
            margin-top: 0.5rem;
            padding: 0.5rem;
            background: rgba(37, 99, 235, 0.1);
            border-radius: 4px;
            font-size: 0.75rem;
            color: #1e40af;
        }

        .docx-features i {
            color: #059669;
            margin-right: 0.25rem;
        }

        .template-info {
            flex: 1;
        }

        /* Modal Responsive Styles */
        @media (max-width: 575.98px) {
            .section-e-modal {
                padding: 0;
            }
            
            .section-e-modal-content,
            .upload-modal-content,
            .merge-modal-content {
                width: 100%;
                height: 100vh;
                margin: 0;
                border-radius: 0;
                display: flex;
                flex-direction: column;
            }

            .section-e-modal-header,
            .upload-modal-header,
            .merge-modal-header {
                border-radius: 0;
                padding: 1rem 1.5rem;
                flex-shrink: 0;
            }

            .section-e-modal-body,
            .upload-modal-content,
            .merge-modal-content {
                flex: 1;
                overflow-y: auto;
                padding: 1rem 1.5rem;
            }

            .section-e-form-row {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .section-e-modal-footer {
                flex-direction: column;
                gap: 1rem;
                padding: 1rem 1.5rem;
                flex-shrink: 0;
                border-top: 1px solid #e1e5e9;
            }
            
            .section-e-form-group input,
            .section-e-form-group textarea,
            .section-e-form-group select {
                font-size: 16px; /* Prevent zoom on iOS */
            }
            
            .upload-area {
                padding: 2rem 1rem;
            }
            
            .upload-area i {
                font-size: 2rem;
            }
        }
        
        @media (min-width: 576px) and (max-width: 991.98px) {
            .section-e-modal-content,
            .upload-modal-content,
            .merge-modal-content {
                width: 90%;
                max-width: 600px;
                margin: 2% auto;
            }

            .section-e-form-row {
                grid-template-columns: 1fr 1fr;
            }

            .section-e-modal-footer {
                flex-direction: row;
                justify-content: space-between;
            }
        }
        
        @media (min-width: 992px) {
            .section-e-modal-content {
                max-width: 900px;
            }
            
            .upload-modal-content,
            .merge-modal-content {
                max-width: 700px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sidebar Navigation -->
        <div class="sidebar">
            <h1><i class="fas fa-database"></i> Fulcrum AI</h1>
            
            <div class="nav-section">
                <div class="nav-item active" data-section="employees">
                    <i class="fas fa-users"></i>
                    <span>Employees</span>
                </div>
                <div class="nav-item" data-section="projects">
                    <i class="fas fa-project-diagram"></i>
                    <span>Projects</span>
                </div>
                <div class="nav-item" data-section="teams">
                    <i class="fas fa-building"></i>
                    <span>Teams</span>
                </div>
            </div>

            <!-- User Info and Logout -->
            <div class="sidebar-user">
                <div class="user-info">
                    <i class="fas fa-user-circle user-avatar"></i>
                    <div class="user-details">
                        <div class="user-email" id="userEmail">user@example.com</div>
                        <div class="user-status">
                            <div class="status-indicator"></div>
                            Online
                        </div>
                    </div>
                </div>
                <button class="logout-btn" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                    Logout
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Header with Search and Filters -->
            <div class="header">
                <div class="search-container">
                    <input type="text" class="search-box" placeholder="Search employees, roles, or teams..." id="searchInput">
                    <i class="fas fa-search search-icon"></i>
                    <div class="suggestions" id="suggestions"></div>
                </div>
                
                <div class="filters">
                    <div class="filters-left">
                        <div class="filter-group">
                            <div class="filter-label">Names</div>
                            <div class="custom-dropdown" id="nameDropdown">
                                <div class="dropdown-toggle">
                                    <span class="dropdown-text">Select names...</span>
                                    <i class="fas fa-chevron-down dropdown-arrow"></i>
                                </div>
                                <div class="dropdown-menu" id="nameDropdownMenu">
                                    <div class="dropdown-content"></div>
                                </div>
                            </div>
                            <div class="filter-count" id="nameCount">0 selected</div>
                        </div>
                        
                        <div class="filter-group">
                            <div class="filter-label">Roles</div>
                            <div class="custom-dropdown" id="roleDropdown">
                                <div class="dropdown-toggle">
                                    <span class="dropdown-text">Select roles...</span>
                                    <i class="fas fa-chevron-down dropdown-arrow"></i>
                                </div>
                                <div class="dropdown-menu" id="roleDropdownMenu">
                                    <div class="dropdown-content"></div>
                                </div>
                            </div>
                            <div class="filter-count" id="roleCount">0 selected</div>
                        </div>
                        
                        <div class="filter-group">
                            <div class="filter-label">Teams</div>
                            <div class="custom-dropdown" id="teamDropdown">
                                <div class="dropdown-toggle">
                                    <span class="dropdown-text">Select teams...</span>
                                    <i class="fas fa-chevron-down dropdown-arrow"></i>
                                </div>
                                <div class="dropdown-menu" id="teamDropdownMenu">
                                    <div class="dropdown-content"></div>
                                </div>
                            </div>
                            <div class="filter-count" id="teamCount">0 selected</div>
                        </div>
                        
                        <div class="filter-group clear-button-group">
                            <button class="clear-filters-btn" id="clearFiltersBtn" title="Clear All Filters">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="filter-actions">
                        <div class="upload-dropdown">
                            <button class="upload-btn" id="uploadBtn">
                                <i class="fas fa-upload"></i> Upload
                                <i class="fas fa-chevron-down"></i>
                            </button>
                            <div class="upload-dropdown-content" id="uploadDropdown">
                                <button class="upload-option" id="uploadResumesBtn">
                                    <i class="fas fa-file-pdf"></i> Upload Resumes
                                </button>
                                <button class="upload-option" id="uploadTemplateBtn">
                                    <i class="fas fa-file-word"></i> Upload Template
                                </button>
                            </div>
                        </div>
                        <button class="delete-employee-btn" id="deleteEmployeeBtn">
                            <i class="fas fa-trash-alt"></i> Delete Employee
                        </button>
                        <button class="refresh-data-btn" id="refreshDataBtn">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                        <div class="merge-dropdown">
                            <button class="merge-btn" id="mergeBtn">
                                <i class="fas fa-code-merge"></i> Merge
                                <i class="fas fa-chevron-down"></i>
                            </button>
                            <div class="merge-dropdown-content" id="mergeDropdown">
                                <button class="merge-option" onclick="openMergeModal('employees')">
                                    <i class="fas fa-users"></i> Merge Employees
                                </button>
                                <button class="merge-option" onclick="openMergeModal('teams')">
                                    <i class="fas fa-building"></i> Merge Teams
                                </button>
                                <button class="merge-option" onclick="executeSplitRolesScript()">
                                    <i class="fas fa-user-tag"></i> Merge Roles
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Content Area -->
            <div class="content">
                <!-- Main List View -->
                <div id="listView">
                    <div class="content-header">
                        <h2 id="sectionTitle">Employees</h2>
                        <span class="results-count" id="resultsCount">Loading...</span>
                    </div>
                    
                    <div class="table-container">
                        <div id="loadingState" class="loading" style="display: none;">
                            <i class="fas fa-spinner"></i>
                            <p>Loading data...</p>
                        </div>
                        
                        <div id="emptyState" class="empty-state" style="display: none;">
                            <i class="fas fa-search"></i>
                            <p>No results found</p>
                        </div>
                        
                        <table id="dataTable">
                            <thead id="tableHead"></thead>
                            <tbody id="tableBody"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Employee Detail View -->
                <div id="employeeDetailView" style="display: none;">
                    <div class="detail-header">
                        <button class="back-btn" id="backToListBtn">
                            <i class="fas fa-arrow-left"></i> Back to List
                        </button>
                        <h2 id="employeeDetailName">Employee Details</h2>
                    </div>
                    
                    <div class="employee-detail-container">
                        <div class="detail-sections">
                            <!-- Personal Information -->
                            <div class="detail-section">
                                <h3><i class="fas fa-user"></i> Personal Information</h3>
                                <div class="detail-grid">
                                    <div class="detail-item" data-field="employee_name">
                                        <label>Name</label>
                                        <span id="detailName">-</span>
                                        <button class="edit-icon" onclick="editField('employee_name', 'detailName', 'text')">
                                            <i class="fas fa-pencil-alt"></i>
                                        </button>
                                    </div>
                                    <div class="detail-item" data-field="total_years_experience">
                                        <label>Total Experience</label>
                                        <span id="detailExperience">-</span>
                                        <button class="edit-icon" onclick="editField('total_years_experience', 'detailExperience', 'number')">
                                            <i class="fas fa-pencil-alt"></i>
                                        </button>
                                    </div>
                                    <div class="detail-item" data-field="role_in_contract">
                                        <label>Primary Role</label>
                                        <span id="detailRole">-</span>
                                        <button class="edit-icon" onclick="editField('role_in_contract', 'detailRole', 'text')">
                                            <i class="fas fa-pencil-alt"></i>
                                        </button>
                                    </div>
                                    <div class="detail-item" data-field="firm_name">
                                        <label>Primary Firm</label>
                                        <span id="detailFirm">-</span>
                                        <button class="edit-icon" onclick="editField('firm_name', 'detailFirm', 'text')">
                                            <i class="fas fa-pencil-alt"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Section E Resume -->
                            <div class="detail-section">
                                <h3><i class="fas fa-file-pdf"></i> Section E Resume</h3>
                                <div class="section-e-actions">
                                    <button class="create-resume-btn" onclick="openSectionEModal()">
                                        <i class="fas fa-plus"></i> Create Section E Resume
                                    </button>
                                </div>
                            </div>

                            <!-- Education -->
                            <div class="detail-section">
                                <h3><i class="fas fa-graduation-cap"></i> Education</h3>
                                <div class="edit-content-wrapper">
                                    <div id="detailEducation" class="detail-content" data-field="education">Loading...</div>
                                    <button class="edit-content-icon" onclick="editContentField('education', 'detailEducation', 'textarea')">
                                        <i class="fas fa-pencil-alt"></i>
                                    </button>
                                </div>
                            </div>

                            <!-- Professional Qualifications -->
                            <div class="detail-section">
                                <h3><i class="fas fa-certificate"></i> Professional Qualifications & Registrations</h3>
                                <div class="edit-content-wrapper">
                                    <div id="detailRegistrations" class="detail-content" data-field="qualifications">Loading...</div>
                                    <button class="edit-content-icon" onclick="editQualificationsField()">
                                        <i class="fas fa-pencil-alt"></i>
                                    </button>
                                </div>
                            </div>

                            <!-- Teams & Firms -->
                            <div class="detail-section">
                                <h3><i class="fas fa-building"></i> Teams & Firms</h3>
                                <div class="edit-content-wrapper">
                                    <div id="detailTeams" class="detail-content">Loading...</div>
                                    <button class="edit-content-icon" onclick="editTeamsField()">
                                        <i class="fas fa-pencil-alt"></i>
                                    </button>
                                </div>
                            </div>

                            <!-- Projects -->
                            <div class="detail-section">
                                <h3><i class="fas fa-project-diagram"></i> Projects</h3>
                                <div id="detailProjects" class="detail-content">Loading...</div>
                            </div>

                            <!-- Meta Information -->
                            <div class="detail-section">
                                <h3><i class="fas fa-info-circle"></i> Meta Information</h3>
                                <div class="detail-grid">
                                    <div class="detail-item">
                                        <label>Total Projects</label>
                                        <span id="detailTotalProjects">-</span>
                                    </div>
                                    <div class="detail-item">
                                        <label>Source Files</label>
                                        <span id="detailSourceFiles">-</span>
                                    </div>
                                    <div class="detail-item">
                                        <label>Last Updated</label>
                                        <span id="detailLastUpdated">-</span>
                                    </div>
                                    <div class="detail-item">
                                        <label>Database ID</label>
                                        <span id="detailId">-</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Section E Resume Modal -->
    <div id="sectionEModal" class="section-e-modal">
        <div class="section-e-modal-content">
            <div class="section-e-modal-header">
                <h2><i class="fas fa-file-pdf"></i> Create Section E Resume</h2>
                <button class="section-e-close" onclick="closeSectionEModal()">&times;</button>
            </div>
            <div class="section-e-modal-body">
                <!-- Personal Information Section -->
                <div class="section-e-form-section">
                    <h3><i class="fas fa-user"></i> Personal Information</h3>
                    <div class="section-e-form-row">
                        <div class="section-e-form-group">
                            <label>Employee Name</label>
                            <input type="text" id="sectionE_employeeName" readonly>
                        </div>
                        <div class="section-e-form-group">
                            <label>Total Years Experience</label>
                            <input type="number" id="sectionE_totalExperience" readonly>
                        </div>
                    </div>
                </div>

                <!-- Template Selection Section -->
                <div class="section-e-form-section">
                    <h3><i class="fas fa-file-pdf"></i> Template Selection</h3>
                    <p style="margin: 0 0 1rem 0; color: #6b7280; font-size: 0.9rem;">
                        Choose a template for your Section E document. You can preview each template before making your selection.
                    </p>
                    <div id="templateSelectionContainer" style="margin-bottom: 1rem;">
                        <div style="text-align: center; padding: 20px; color: #6b7280;">
                            <i class="fas fa-spinner fa-spin"></i> Loading templates...
                        </div>
                    </div>
                    <input type="hidden" id="selectedTemplateId" value="default">
                </div>

                <!-- Contract & Firm Information -->
                <div class="section-e-form-section">
                    <h3><i class="fas fa-briefcase"></i> Contract & Firm Information</h3>
                    <div class="section-e-form-group">
                        <label>Role in This Contract <span style="color: #ef4444;">*</span></label>
                        <select id="sectionE_roleInContract" style="display: none;">
                            <!-- Options will be populated dynamically -->
                        </select>
                        <input type="text" id="sectionE_roleInContract_input" placeholder="e.g., Project Manager, Lead Engineer">
                    </div>
                    <div class="section-e-form-row">
                        <div class="section-e-form-group">
                            <label>Firm Name <span style="color: #ef4444;">*</span></label>
                            <select id="sectionE_firmName" style="display: none;">
                                <!-- Options will be populated dynamically -->
                            </select>
                            <input type="text" id="sectionE_firmName_input" placeholder="e.g., Engineering Solutions Inc">
                        </div>
                        <div class="section-e-form-group">
                            <label>Location (City and State) <span style="color: #ef4444;">*</span></label>
                            <input type="text" id="sectionE_location" placeholder="e.g., Denver, CO">
                        </div>
                    </div>
                </div>

                <!-- Education & Qualifications -->
                <div class="section-e-form-section">
                    <h3><i class="fas fa-graduation-cap"></i> Education & Qualifications</h3>
                    <div class="section-e-form-group">
                        <label>Education</label>
                        <textarea id="sectionE_education" readonly rows="3"></textarea>
                    </div>
                </div>

                <!-- Current Professional Registration -->
                <div class="section-e-form-section">
                    <h3><i class="fas fa-id-badge"></i> Current Professional Registration</h3>
                    <p style="margin: 0 0 1rem 0; color: #6b7280; font-size: 0.9rem;">
                        Select current professional registration for this employee.
                    </p>
                    <div class="selected-registration-display" id="sectionE_selectedRegistrationDisplay">
                        <div class="selected-registration-placeholder" id="selectedRegistrationPlaceholder">
                            <i class="fas fa-id-badge" style="font-size: 1.5rem; color: #d1d5db; margin-bottom: 0.5rem;"></i>
                            <p style="color: #6b7280; margin: 0; font-size: 0.9rem;">No registration selected</p>
                        </div>
                    </div>
                    <div class="registration-action-buttons">
                        <button type="button" class="select-registration-btn" onclick="openRegistrationSelectionModal()">
                            <i class="fas fa-plus"></i> Select Registration
                        </button>
                    </div>
                </div>

                <!-- Other Professional Qualifications -->
                <div class="section-e-form-section">
                    <h3><i class="fas fa-certificate"></i> Other Professional Qualifications</h3>
                    <p style="margin: 0 0 1rem 0; color: #6b7280; font-size: 0.9rem;">
                        Select other professional qualifications and certifications.
                    </p>
                    <div class="selected-qualifications-list" id="sectionE_selectedQualificationsList">
                        <div class="selected-qualifications-placeholder" id="selectedQualificationsPlaceholder">
                            <i class="fas fa-certificate" style="font-size: 2rem; color: #d1d5db; margin-bottom: 1rem;"></i>
                            <p style="color: #6b7280; margin: 0;">No qualifications selected yet</p>
                        </div>
                    </div>
                    <div class="qualifications-action-buttons">
                        <button type="button" class="add-qualifications-btn" onclick="openQualificationsSelectionModal()">
                            <i class="fas fa-plus"></i> Select Qualifications
                        </button>
                        <button type="button" class="add-custom-qualification-btn" onclick="addNewCustomQualification()">
                            <i class="fas fa-plus-circle"></i> Add Custom Qualification
                        </button>
                    </div>
                    <div class="qualifications-count-info">
                        <span id="selectedQualificationsCount">0</span> qualifications selected
                    </div>
                </div>

                <!-- Relevant Projects -->
                <div class="section-e-form-section">
                    <h3><i class="fas fa-project-diagram"></i> Relevant Projects</h3>
                    <p style="margin: 0 0 1rem 0; color: #6b7280; font-size: 0.9rem;">
                        Select up to 5 projects to include in the Section E resume. You can also add new custom projects.
                    </p>
                    <div class="selected-projects-list" id="sectionE_selectedProjectsList">
                        <div class="selected-projects-placeholder" id="selectedProjectsPlaceholder">
                            <i class="fas fa-project-diagram" style="font-size: 2rem; color: #d1d5db; margin-bottom: 1rem;"></i>
                            <p style="color: #6b7280; margin: 0;">No projects selected yet</p>
                        </div>
                    </div>
                    <div class="projects-action-buttons">
                        <button type="button" class="add-project-btn" onclick="openProjectSelectionModal()">
                            <i class="fas fa-plus"></i> Add Projects
                        </button>
                        <button type="button" class="add-custom-project-btn" onclick="addNewCustomProject()">
                            <i class="fas fa-plus-circle"></i> Add Custom Project
                        </button>
                        <button type="button" class="find-relevant-projects-btn" onclick="openSolicitationAnalysisModal()">
                            <i class="fas fa-search"></i> Find Relevant Projects
                        </button>
                        <button type="button" class="ai-writeup-btn" onclick="openAIWriteupModal()">
                            <i class="fas fa-magic"></i> AI Writeup
                        </button>
                    </div>
                    <div class="projects-count-info">
                        <span id="selectedProjectsCount">0</span> of 5 projects selected
                    </div>
                </div>
            </div>
            <div class="section-e-modal-footer">
                <button class="section-e-cancel-btn" onclick="closeSectionEModal()">Cancel</button>
                <button class="section-e-generate-btn" onclick="generateSectionEResume()">
                    <i class="fas fa-download"></i> Generate & Download Resume
                </button>
            </div>
        </div>
    </div>

    <!-- Project Selection Modal -->
    <div id="projectSelectionModal" class="modal-overlay" style="display: none;">
        <div class="project-selection-modal">
            <div class="project-selection-header">
                <h2><i class="fas fa-project-diagram"></i> Select Projects</h2>
                <button class="close-modal-btn" onclick="closeProjectSelectionModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="project-selection-content">
                <div class="project-selection-info">
                    <p>Select up to 5 projects for <span id="employeeNameInModal">this employee</span>'s Section E resume:</p>
                    <div class="selection-counter">
                        <span id="modalSelectedCount">0</span> of 5 projects selected
                    </div>
                </div>
                
                <div class="available-projects-list" id="availableProjectsList">
                    <!-- Available projects will be populated here -->
                </div>
            </div>
            
            <div class="project-selection-footer">
                <button class="project-selection-cancel-btn" onclick="closeProjectSelectionModal()">Cancel</button>
                <button class="project-selection-add-btn" onclick="addSelectedProjectsToResume()">
                    <i class="fas fa-plus"></i> Add Selected Projects
                </button>
            </div>
        </div>
    </div>

    <!-- Solicitation Analysis Modal -->
    <div id="solicitationAnalysisModal" class="modal-overlay" style="display: none;">
        <div class="solicitation-analysis-modal">
            <div class="project-selection-header">
                <h2><i class="fas fa-search"></i> Find Relevant Projects</h2>
                <button class="close-modal-btn" onclick="closeSolicitationAnalysisModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="project-selection-content">
                <!-- File Upload Section -->
                <div id="uploadSection">
                    <h3 style="margin: 0 0 1rem 0; color: #374151;">Upload Solicitation Document</h3>
                    <p style="margin: 0 0 1rem 0; color: #6b7280; font-size: 0.9rem;">
                        Upload a PDF solicitation document to analyze and extract keywords for project matching.
                    </p>
                    
                    <div class="solicitation-upload-area" id="uploadArea" onclick="document.getElementById('solicitationFileInput').click()">
                        <div class="upload-icon">
                            <i class="fas fa-cloud-upload-alt"></i>
                        </div>
                        <div class="upload-text">Click to upload or drag and drop</div>
                        <div class="upload-subtext">PDF files only, up to 10MB</div>
                    </div>
                    
                    <input type="file" id="solicitationFileInput" class="file-upload-input" accept=".pdf" onchange="handleFileUpload(this.files[0])">
                </div>

                <!-- Analysis Progress Section -->
                <div id="analysisProgress" class="analysis-progress">
                    <div class="progress-spinner"></div>
                    <div>Analyzing solicitation document...</div>
                    <div style="font-size: 0.875rem; color: #6b7280; margin-top: 0.5rem;">
                        This may take 10-30 seconds depending on document size.
                    </div>
                </div>

                <!-- Keywords Selection Section -->
                <div id="keywordsSection" class="keywords-section">
                    <h3 style="margin: 0 0 1rem 0; color: #374151;">Select Relevant Keywords</h3>
                    <p style="margin: 0 0 1rem 0; color: #6b7280; font-size: 0.9rem;">
                        We've extracted key information from the solicitation. Select the keywords that best describe the project requirements:
                    </p>
                    
                    <div id="keywordsGrid" class="keywords-grid">
                        <!-- Keywords will be populated here -->
                    </div>
                    
                    <!-- Custom Keywords Section -->
                    <div id="customKeywordsSection" class="custom-keywords-section" style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid #e5e7eb;">
                        <h4 style="margin: 0 0 0.75rem 0; color: #374151; font-size: 1rem;">Add Custom Keywords</h4>
                        <p style="margin: 0 0 0.75rem 0; color: #6b7280; font-size: 0.875rem;">
                            Add your own keywords that you think are relevant to this solicitation:
                        </p>
                        
                        <div class="custom-keyword-input-row" style="display: flex; gap: 0.5rem; margin-bottom: 0.75rem;">
                            <input type="text" id="customKeywordInput" placeholder="Enter a custom keyword (e.g., structural engineering, project management)" 
                                   style="flex: 1; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.875rem;"
                                   onkeypress="handleCustomKeywordEnter(event)">
                            <style>
                                .add-custom-keyword-btn:hover {
                                    background: #5a67d8 !important;
                                }
                                .keyword-item.custom {
                                    border: 2px solid #667eea;
                                    background: #f0f4ff;
                                }
                                .custom-keyword-tag:hover button {
                                    color: #1e40af;
                                }
                            </style>
                            <select id="customKeywordCategory" style="padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.875rem;">
                                <option value="skill">Skill</option>
                                <option value="technology">Technology</option>
                                <option value="location">Location</option>
                                <option value="role">Role</option>
                                <option value="industry">Industry</option>
                                <option value="certification">Certification</option>
                            </select>
                            <button type="button" onclick="addCustomKeyword()" class="add-custom-keyword-btn" 
                                    style="padding: 0.5rem 1rem; background: #667eea; color: white; border: none; border-radius: 4px; font-size: 0.875rem; cursor: pointer;">
                                <i class="fas fa-plus"></i> Add
                            </button>
                        </div>
                        
                        <div id="customKeywordsDisplay" class="custom-keywords-display" style="display: none;">
                            <p style="margin: 0 0 0.5rem 0; color: #374151; font-size: 0.875rem; font-weight: 500;">Added Custom Keywords:</p>
                            <div id="customKeywordsList" class="custom-keywords-list" style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                <!-- Custom keywords will be added here -->
                            </div>
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 1rem;">
                        <button type="button" class="project-selection-add-btn" onclick="findMatchingProjects()" id="findProjectsBtn" disabled>
                            <i class="fas fa-search"></i> Find Matching Projects
                        </button>
                    </div>
                </div>

                <!-- Suggested Projects Section -->
                <div id="suggestedProjectsSection" class="suggested-projects-section">
                    <h3 style="margin: 0 0 1rem 0; color: #374151;">Suggested Projects</h3>
                    <p style="margin: 0 0 1rem 0; color: #6b7280; font-size: 0.9rem;">
                        Based on your selected keywords, here are the most relevant projects for this employee:
                    </p>
                    
                    <div id="suggestedProjectsList">
                        <!-- Suggested projects will be populated here -->
                    </div>
                </div>
            </div>
            
            <div class="project-selection-footer">
                <button class="project-selection-cancel-btn" onclick="closeSolicitationAnalysisModal()">Cancel</button>
                <button class="project-selection-add-btn" onclick="addSuggestedProjects()" id="addSuggestedBtn" style="display: none;">
                    <i class="fas fa-plus"></i> Add Selected Projects
                </button>
            </div>
        </div>
    </div>

    <!-- Qualifications Selection Modal -->
    <div id="qualificationsSelectionModal" class="modal-overlay" style="display: none;">
        <div class="project-selection-modal">
            <div class="project-selection-header">
                <h2><i class="fas fa-certificate"></i> Select Professional Qualifications</h2>
                <button class="close-modal-btn" onclick="closeQualificationsSelectionModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="project-selection-content">
                <div class="project-selection-info">
                    <p>Select other professional qualifications for <span id="employeeNameInQualModal">this employee</span>'s Section E resume:</p>
                </div>
                
                <!-- Qualifications Section -->
                <div class="qualifications-section">
                    <h3 style="margin: 0 0 1rem 0; color: #374151;">Other Professional Qualifications</h3>
                    <div class="qualifications-grid" id="qualificationsGrid">
                        <!-- Qualification options will be populated here -->
                    </div>
                    <div class="custom-qualification-input" style="margin-top: 1rem;">
                        <input type="text" id="customQualificationInput" placeholder="Add custom qualification..." 
                               style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
                        <button type="button" onclick="addCustomQualification()" 
                                style="margin-top: 0.5rem; padding: 0.5rem 1rem; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            <i class="fas fa-plus"></i> Add Qualification
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="project-selection-footer">
                <button class="project-selection-cancel-btn" onclick="closeQualificationsSelectionModal()">Cancel</button>
                <button class="project-selection-add-btn" onclick="addSelectedQualificationsToResume()">
                    <i class="fas fa-plus"></i> Add Selected Qualifications
                </button>
            </div>
        </div>
    </div>

    <!-- Registration Selection Modal -->
    <div id="registrationSelectionModal" class="modal-overlay" style="display: none;">
        <div class="project-selection-modal">
            <div class="project-selection-header">
                <h2><i class="fas fa-id-badge"></i> Select Professional Registration</h2>
                <button class="close-modal-btn" onclick="closeRegistrationSelectionModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="project-selection-content">
                <div class="project-selection-info">
                    <p>Select current professional registration for <span id="employeeNameInRegModal">this employee</span>:</p>
                </div>
                
                <!-- Registration Selection -->
                <div class="qualifications-section">
                    <h3 style="margin: 0 0 1rem 0; color: #374151;">Available Professional Registrations</h3>
                    <div class="qualifications-grid" id="availableRegistrationGrid">
                        <!-- Registration options will be populated here -->
                    </div>
                    <div class="custom-qualification-input" style="margin-top: 1rem;">
                        <input type="text" id="customRegistrationModalInput" placeholder="Add custom registration..." 
                               style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
                        <button type="button" onclick="addCustomRegistrationFromModal()" 
                                style="margin-top: 0.5rem; padding: 0.5rem 1rem; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            <i class="fas fa-plus"></i> Add Custom Registration
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="project-selection-footer">
                <button class="project-selection-cancel-btn" onclick="closeRegistrationSelectionModal()">Cancel</button>
                <button class="project-selection-add-btn" onclick="saveSelectedRegistration()">
                    <i class="fas fa-check"></i> Save Registration
                </button>
            </div>
        </div>
    </div>

    <script>
        // Authentication Check - Must be logged in to access dashboard
        function checkAuthentication() {
            const isLoggedIn = sessionStorage.getItem('isLoggedIn');
            const userEmail = sessionStorage.getItem('userEmail');
            
            if (!isLoggedIn || isLoggedIn !== 'true') {
                // Redirect to login page if not authenticated
                window.location.href = '/login.html';
                return false;
            }
            
            // Update user email in sidebar
            const userEmailElement = document.getElementById('userEmail');
            if (userEmailElement && userEmail) {
                userEmailElement.textContent = userEmail;
            }
            
            return true;
        }

        // Logout function
        function logout() {
            // Clear session data
            sessionStorage.removeItem('isLoggedIn');
            sessionStorage.removeItem('userEmail');
            
            // Redirect to login page
            window.location.href = '/login.html';
        }

        // Check authentication on page load
        if (!checkAuthentication()) {
            // Stop execution if not authenticated
            throw new Error('Authentication required');
        }

        // Supabase Configuration - UPDATE THESE WITH YOUR CREDENTIALS
        const SUPABASE_URL = 'YOUR_SUPABASE_URL_HERE';
        const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY_HERE';
        
        // Check if we're in development mode (for demo purposes)
        const isDemoMode = SUPABASE_URL === 'YOUR_SUPABASE_URL_HERE';
        
        // Initialize Supabase client only if configured
        let supabase;
        if (!isDemoMode) {
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        }

        // Application State
        let currentSection = 'employees';
        let allData = [];
        let filteredData = [];
        let searchTerm = '';
        let currentEmployeeData = null; // Track current employee for editing

        // DOM Elements
        const searchInput = document.getElementById('searchInput');
        const suggestions = document.getElementById('suggestions');
        const nameDropdown = document.getElementById('nameDropdown');
        const roleDropdown = document.getElementById('roleDropdown');
        const teamDropdown = document.getElementById('teamDropdown');
        const nameDropdownMenu = document.getElementById('nameDropdownMenu');
        const roleDropdownMenu = document.getElementById('roleDropdownMenu');
        const teamDropdownMenu = document.getElementById('teamDropdownMenu');
        const sectionTitle = document.getElementById('sectionTitle');
        const resultsCount = document.getElementById('resultsCount');
        const loadingState = document.getElementById('loadingState');
        const emptyState = document.getElementById('emptyState');
        const dataTable = document.getElementById('dataTable');
        const tableHead = document.getElementById('tableHead');
        const tableBody = document.getElementById('tableBody');

        // Filter state
        let selectedNames = [];
        let selectedRoles = [];
        let selectedTeams = [];

        // Sample data for demo mode
        const demoData = {
            employees: [
                {
                    employee_name: 'Milan Mardia',
                    role_in_contract: 'Project Engineer',
                    firm_name: 'Engineering Solutions Inc',
                    total_years_experience: 8,
                    education: 'MS Civil Engineering',
                    total_projects: 5
                },
                {
                    employee_name: 'Raj Mehta',
                    role_in_contract: 'Senior Architect',
                    firm_name: 'Design Associates LLC',
                    total_years_experience: 12,
                    education: 'BS Architecture',
                    total_projects: 8
                },
                {
                    employee_name: 'Sarah Johnson',
                    role_in_contract: 'Environmental Consultant',
                    firm_name: 'Green Solutions Corp',
                    total_years_experience: 6,
                    education: 'MS Environmental Science',
                    total_projects: 3
                }
            ],
            projects: [
                {
                    title_and_location: 'Highway Bridge Replacement - Denver, CO',
                    employee_name: 'Milan Mardia',
                    firm_name: 'Engineering Solutions Inc',
                    professional_services_year: 2023,
                    role_in_contract: 'Project Engineer',
                    description_scope: 'Complete bridge replacement including design, permitting, and construction oversight...'
                },
                {
                    title_and_location: 'Downtown Office Complex - Austin, TX',
                    employee_name: 'Raj Mehta',
                    firm_name: 'Design Associates LLC',
                    professional_services_year: 2022,
                    role_in_contract: 'Senior Architect',
                    description_scope: 'Mixed-use development with retail, office, and residential components...'
                }
            ],
            teams: [
                {
                    firm_name: 'Engineering Solutions Inc',
                    location: 'Denver, CO',
                    total_employees: 25,
                    avg_total_experience: 8.5,
                    total_projects: 15,
                    earliest_project_year: 2018,
                    latest_project_year: 2023
                },
                {
                    firm_name: 'Design Associates LLC',
                    location: 'Austin, TX',
                    total_employees: 18,
                    avg_total_experience: 10.2,
                    total_projects: 22,
                    earliest_project_year: 2015,
                    latest_project_year: 2023
                }
            ]
        };

        // Initialize the application
        async function init() {
            try {
                // Check if required DOM elements exist
                const missingElements = [];
                if (!loadingState) missingElements.push('loadingState');
                if (!emptyState) missingElements.push('emptyState');
                if (!dataTable) missingElements.push('dataTable');
                if (!searchInput) missingElements.push('searchInput');
                if (!sectionTitle) missingElements.push('sectionTitle');
                if (!resultsCount) missingElements.push('resultsCount');
                if (!tableHead) missingElements.push('tableHead');
                if (!tableBody) missingElements.push('tableBody');

                if (missingElements.length > 0) {
                    console.error('Missing DOM elements:', missingElements);
                    // Try to continue anyway for partial functionality
                }

                if (isDemoMode) {
                    showConfigurationMessage();
                } else {
                    setupEventListeners();
                    await loadSection('employees');
                }
            } catch (error) {
                console.error('Initialization error:', error);
                if (loadingState) {
                    showError('Failed to initialize application');
                } else {
                    console.error('Cannot show error - loadingState element missing');
                }
            }
        }

        function showConfigurationMessage() {
            if (loadingState) {
                loadingState.style.display = 'block';
                loadingState.innerHTML = `
                    <i class="fas fa-cog"></i>
                    <p><strong>Configuration Required</strong></p>
                    <p>Please update the Supabase credentials in the JavaScript section:</p>
                    <div style="font-family: monospace; background: #f3f4f6; padding: 1rem; margin: 1rem 0; border-radius: 4px; text-align: left;">
                        SUPABASE_URL = 'https://clcufcjifbvpbtsczkmx.supabase.co'<br>
                        SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNsY3VmY2ppZmJ2cGJ0c2N6a214Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1MTMxODQyNSwiZXhwIjoyMDY2ODk0NDI1fQ.fQTie6YIgPMl_8bo2W6e6jCjk7tGxWFXdSZZj0RTNa0'
                    </div>
                    <p>You can find these in your Supabase project settings  API.</p>
                    <br>
                    <button onclick="enableDemoMode()" style="background: #667eea; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 6px; cursor: pointer; font-size: 0.9rem;">
                        View Demo with Sample Data
                    </button>
                `;
            } else {
                console.error('loadingState element not found');
            }
        }

        function enableDemoMode() {
            // Reset loading state content and hide it
            if (loadingState) {
                loadingState.innerHTML = `
                    <i class="fas fa-spinner"></i>
                    <p>Loading data...</p>
                `;
                loadingState.style.display = 'none';
            }
            
            // Enable demo mode with sample data
            setupEventListeners();
            loadDemoData('employees');
        }

        function setupEventListeners() {
            // Navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', () => {
                    const section = item.dataset.section;
                    switchSection(section);
                });
            });

            // Search with debouncing
            if (searchInput) {
                let searchTimeout;
                searchInput.addEventListener('input', (e) => {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        handleSearch(e.target.value);
                    }, 300);
                });

                // Search suggestions
                searchInput.addEventListener('focus', showSuggestions);
                searchInput.addEventListener('blur', () => {
                    setTimeout(hideSuggestions, 200);
                });
            }

            // Dropdown toggles
            setupDropdown('nameDropdown', 'nameDropdownMenu');
            setupDropdown('roleDropdown', 'roleDropdownMenu');
            setupDropdown('teamDropdown', 'teamDropdownMenu');

            // Clear filters button
            const clearFiltersBtn = document.getElementById('clearFiltersBtn');
            if (clearFiltersBtn) {
                clearFiltersBtn.addEventListener('click', clearAllFilters);
            }

            // Close dropdowns when clicking outside
            document.addEventListener('click', closeAllDropdowns);
        }

        async function switchSection(section) {
            // Update navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`[data-section="${section}"]`).classList.add('active');

            currentSection = section;
            
            if (isDemoMode) {
                loadDemoData(section);
            } else {
                await loadSection(section);
            }
        }

        function loadDemoData(section) {
            allData = demoData[section] || [];
            filteredData = [...allData];
            
            // Ensure loading is hidden and table is visible
            hideLoading();
            hideEmpty();
            
            switch (section) {
                case 'employees':
                    setupEmployeesTable();
                    break;
                case 'projects':
                    setupProjectsTable();
                    break;
                case 'teams':
                    setupTeamsTable();
                    break;
            }
            
            populateFilters();
            renderTable();
            updateResultsCount();
            
            // Explicitly show the table
            showTable();
        }

        async function loadSection(section) {
            try {
                switch (section) {
                    case 'employees':
                        await loadEmployees();
                        break;
                    case 'projects':
                        await loadProjects();
                        break;
                    case 'teams':
                        await loadTeams();
                        break;
                }
            } catch (error) {
                console.error(`Error loading ${section}:`, error);
                showError(`Failed to load ${section}`);
            }
        }

        async function loadEmployees() {
            const { data, error } = await supabase
                .from('employee_profiles')
                .select('*')
                .order('employee_name');

            if (error) throw error;

            allData = data;
            filteredData = [...allData];
            
            // Ensure loading is hidden and content is shown
            hideLoading();
            hideEmpty();
            
            setupEmployeesTable();
            populateFilters();
            renderTable();
            updateResultsCount();
            
            // Explicitly show the table
            showTable();
        }

        async function loadProjects() {
            const { data, error } = await supabase
                .from('project_details')
                .select('*')
                .order('title_and_location');

            if (error) throw error;

            allData = data;
            filteredData = [...allData];
            
            // Ensure loading is hidden and content is shown
            hideLoading();
            hideEmpty();
            
            setupProjectsTable();
            populateFilters();
            renderTable();
            updateResultsCount();
            
            // Explicitly show the table
            showTable();
        }

        async function loadTeams() {
            const { data, error } = await supabase
                .from('team_analytics')
                .select('*')
                .order('firm_name');

            if (error) throw error;

            allData = data;
            filteredData = [...allData];
            
            // Ensure loading is hidden and content is shown
            hideLoading();
            hideEmpty();
            
            setupTeamsTable();
            populateFilters();
            renderTable();
            updateResultsCount();
            
            // Explicitly show the table
            showTable();
        }

        function setupEmployeesTable() {
            if (sectionTitle) {
                sectionTitle.textContent = 'Employees';
            }
            if (tableHead) {
                tableHead.innerHTML = `
                    <tr>
                        <th>Name</th>
                        <th>Role</th>
                        <th>Team</th>
                        <th>Projects</th>
                    </tr>
                `;
            }
        }

        function setupProjectsTable() {
            if (sectionTitle) {
                sectionTitle.textContent = 'Projects';
            }
            if (tableHead) {
                tableHead.innerHTML = `
                    <tr>
                        <th>Project Title</th>
                        <th>Employee</th>
                        <th>Firm</th>
                        <th>Year</th>
                        <th>Role</th>
                        <th>Scope</th>
                    </tr>
                `;
            }
        }

        function setupTeamsTable() {
            if (sectionTitle) {
                sectionTitle.textContent = 'Teams';
            }
            if (tableHead) {
                tableHead.innerHTML = `
                    <tr>
                        <th>Firm Name</th>
                        <th>Location</th>
                        <th>Employees</th>
                        <th>Avg Experience</th>
                        <th>Projects</th>
                        <th>Years Active</th>
                    </tr>
                `;
            }
        }

        function populateFilters() {
            // Clear existing options and reset selections
            selectedNames = [];
            selectedRoles = [];
            selectedTeams = [];

            if (currentSection === 'employees') {
                // Names
                const names = [...new Set(allData.map(item => item.employee_name).filter(Boolean))].sort();
                populateDropdown('nameDropdownMenu', names, 'names');

                // Roles (split comma-separated values and deduplicate)
                const allRoles = [];
                allData.forEach(item => {
                    if (item.role_in_contract) {
                        const deduplicatedRole = deduplicateRoles(item.role_in_contract);
                        const roles = deduplicatedRole.split(',').map(r => r.trim()).filter(Boolean);
                        allRoles.push(...roles);
                    }
                });
                const uniqueRoles = [...new Set(allRoles)].sort();
                populateDropdown('roleDropdownMenu', uniqueRoles, 'roles');

                // Teams (split comma-separated values)
                const allTeams = [];
                allData.forEach(item => {
                    if (item.firm_name) {
                        const teams = item.firm_name.split(',').map(t => t.trim()).filter(Boolean);
                        allTeams.push(...teams);
                    }
                });
                const uniqueTeams = [...new Set(allTeams)].sort();
                populateDropdown('teamDropdownMenu', uniqueTeams, 'teams');

            } else if (currentSection === 'projects') {
                // Project titles as "names"
                const titles = [...new Set(allData.map(item => item.title_and_location).filter(Boolean))].sort();
                populateDropdown('nameDropdownMenu', titles, 'names');

                // Roles
                const roles = [...new Set(allData.map(item => item.role_in_contract).filter(Boolean))].sort();
                populateDropdown('roleDropdownMenu', roles, 'roles');

                // Teams
                const teams = [...new Set(allData.map(item => item.firm_name).filter(Boolean))].sort();
                populateDropdown('teamDropdownMenu', teams, 'teams');

            } else if (currentSection === 'teams') {
                // Firm names as "names"
                const firms = [...new Set(allData.map(item => item.firm_name).filter(Boolean))].sort();
                populateDropdown('nameDropdownMenu', firms, 'names');

                // Locations as "roles"
                const locations = [...new Set(allData.map(item => item.location).filter(Boolean))].sort();
                populateDropdown('roleDropdownMenu', locations, 'roles');

                // Clear teams dropdown for teams section
                populateDropdown('teamDropdownMenu', [], 'teams');
            }

            // Update filter counts and dropdown text
            updateFilterCounts();
            updateDropdownText();
        }

        function populateDropdown(menuId, items, filterType) {
            const menu = document.getElementById(menuId);
            const content = menu.querySelector('.dropdown-content');
            
            content.innerHTML = '';
            
            items.forEach(item => {
                const checkboxItem = document.createElement('div');
                checkboxItem.className = 'checkbox-item';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `${filterType}_${item.replace(/\s+/g, '_')}`;
                checkbox.value = item;
                checkbox.addEventListener('change', () => handleFilterChange(filterType, item, checkbox.checked));
                
                const label = document.createElement('label');
                label.htmlFor = checkbox.id;
                label.textContent = item;
                
                checkboxItem.appendChild(checkbox);
                checkboxItem.appendChild(label);
                content.appendChild(checkboxItem);
            });
        }

        function handleFilterChange(filterType, value, checked) {
            if (filterType === 'names') {
                if (checked) {
                    selectedNames.push(value);
                } else {
                    selectedNames = selectedNames.filter(name => name !== value);
                }
            } else if (filterType === 'roles') {
                if (checked) {
                    selectedRoles.push(value);
                } else {
                    selectedRoles = selectedRoles.filter(role => role !== value);
                }
            } else if (filterType === 'teams') {
                if (checked) {
                    selectedTeams.push(value);
                } else {
                    selectedTeams = selectedTeams.filter(team => team !== value);
                }
            }
            
            updateFilterCounts();
            updateDropdownText();
            applyFilters();
        }

        function setupDropdown(dropdownId, menuId) {
            const dropdown = document.getElementById(dropdownId);
            const toggle = dropdown.querySelector('.dropdown-toggle');
            const menu = document.getElementById(menuId);
            
            toggle.addEventListener('click', (e) => {
                e.stopPropagation();
                
                // Close other dropdowns
                closeAllDropdowns(dropdownId);
                
                // Toggle current dropdown
                const isOpen = menu.classList.contains('show');
                if (isOpen) {
                    menu.classList.remove('show');
                    toggle.classList.remove('active');
                } else {
                    menu.classList.add('show');
                    toggle.classList.add('active');
                }
            });
        }

        function closeAllDropdowns(except = null) {
            const dropdowns = ['nameDropdownMenu', 'roleDropdownMenu', 'teamDropdownMenu'];
            const toggles = ['nameDropdown', 'roleDropdown', 'teamDropdown'];
            
            dropdowns.forEach((menuId, index) => {
                const toggleId = toggles[index];
                if (except && toggleId === except) return;
                
                const menu = document.getElementById(menuId);
                const toggle = document.getElementById(toggleId).querySelector('.dropdown-toggle');
                
                menu.classList.remove('show');
                toggle.classList.remove('active');
            });
        }

        function updateDropdownText() {
            // Update name dropdown text
            const nameText = nameDropdown.querySelector('.dropdown-text');
            if (selectedNames.length === 0) {
                nameText.textContent = 'Select names...';
                nameText.classList.add('placeholder');
            } else if (selectedNames.length === 1) {
                nameText.textContent = selectedNames[0];
                nameText.classList.remove('placeholder');
            } else {
                nameText.textContent = `${selectedNames.length} names selected`;
                nameText.classList.remove('placeholder');
            }

            // Update role dropdown text
            const roleText = roleDropdown.querySelector('.dropdown-text');
            if (selectedRoles.length === 0) {
                roleText.textContent = 'Select roles...';
                roleText.classList.add('placeholder');
            } else if (selectedRoles.length === 1) {
                roleText.textContent = selectedRoles[0];
                roleText.classList.remove('placeholder');
            } else {
                roleText.textContent = `${selectedRoles.length} roles selected`;
                roleText.classList.remove('placeholder');
            }

            // Update team dropdown text
            const teamText = teamDropdown.querySelector('.dropdown-text');
            if (selectedTeams.length === 0) {
                teamText.textContent = 'Select teams...';
                teamText.classList.add('placeholder');
            } else if (selectedTeams.length === 1) {
                teamText.textContent = selectedTeams[0];
                teamText.classList.remove('placeholder');
            } else {
                teamText.textContent = `${selectedTeams.length} teams selected`;
                teamText.classList.remove('placeholder');
            }
        }

        function handleSearch(term) {
            searchTerm = term.toLowerCase();
            applyFilters();
            
            if (term.length > 0) {
                generateSuggestions(term);
            } else {
                hideSuggestions();
            }
        }

        function generateSuggestions(term) {
            const suggestions_data = [];
            
            if (currentSection === 'employees') {
                allData.forEach(item => {
                    // Employee names
                    if (item.employee_name && item.employee_name.toLowerCase().includes(term)) {
                        suggestions_data.push({type: 'Name', value: item.employee_name});
                    }
                    
                    // Roles (handle comma-separated values)
                    if (item.role_in_contract) {
                        const roles = item.role_in_contract.split(',').map(r => r.trim());
                        roles.forEach(role => {
                            if (role && role.toLowerCase().includes(term)) {
                                suggestions_data.push({type: 'Role', value: role});
                            }
                        });
                    }
                    
                    // Teams (handle comma-separated values)
                    if (item.firm_name) {
                        const teams = item.firm_name.split(',').map(t => t.trim());
                        teams.forEach(team => {
                            if (team && team.toLowerCase().includes(term)) {
                                suggestions_data.push({type: 'Team', value: team});
                            }
                        });
                    }
                });
            }

            // Remove duplicates
            const uniqueSuggestions = suggestions_data.filter((item, index, self) => 
                index === self.findIndex(t => t.value === item.value && t.type === item.type)
            ).slice(0, 8);

            if (uniqueSuggestions.length > 0) {
                suggestions.innerHTML = uniqueSuggestions.map(item => 
                    `<div class="suggestion-item" onclick="selectSuggestion('${item.value.replace(/'/g, '\\\'')}')">${item.value} <small>(${item.type})</small></div>`
                ).join('');
                showSuggestions();
            } else {
                hideSuggestions();
            }
        }

        function selectSuggestion(value) {
            searchInput.value = value;
            handleSearch(value);
            hideSuggestions();
        }

        function showSuggestions() {
            if (suggestions.innerHTML.trim()) {
                suggestions.style.display = 'block';
            }
        }

        function hideSuggestions() {
            suggestions.style.display = 'none';
        }

        function applyFilters() {
            const filterNames = selectedNames.map(name => name.toLowerCase());
            const filterRoles = selectedRoles.map(role => role.toLowerCase());
            const filterTeams = selectedTeams.map(team => team.toLowerCase());

            filteredData = allData.filter(item => {
                let matchesSearch = !searchTerm;
                let matchesName = filterNames.length === 0;
                let matchesRole = filterRoles.length === 0;
                let matchesTeam = filterTeams.length === 0;

                if (currentSection === 'employees') {
                    matchesSearch = !searchTerm || 
                        (item.employee_name && item.employee_name.toLowerCase().includes(searchTerm)) ||
                        (item.role_in_contract && item.role_in_contract.toLowerCase().includes(searchTerm)) ||
                        (item.firm_name && item.firm_name.toLowerCase().includes(searchTerm));

                    matchesName = filterNames.length === 0 || 
                        (item.employee_name && filterNames.includes(item.employee_name.toLowerCase()));

                    // Handle comma-separated roles
                    matchesRole = filterRoles.length === 0 || 
                        (item.role_in_contract && filterRoles.some(role => 
                            item.role_in_contract.toLowerCase().split(',').map(r => r.trim()).includes(role)
                        ));

                    // Handle comma-separated teams
                    matchesTeam = filterTeams.length === 0 || 
                        (item.firm_name && filterTeams.some(team => 
                            item.firm_name.toLowerCase().split(',').map(t => t.trim()).includes(team)
                        ));

                } else if (currentSection === 'projects') {
                    matchesSearch = !searchTerm || 
                        (item.title_and_location && item.title_and_location.toLowerCase().includes(searchTerm)) ||
                        (item.employee_name && item.employee_name.toLowerCase().includes(searchTerm)) ||
                        (item.firm_name && item.firm_name.toLowerCase().includes(searchTerm));

                    matchesName = filterNames.length === 0 || 
                        (item.title_and_location && filterNames.includes(item.title_and_location.toLowerCase()));

                    matchesRole = filterRoles.length === 0 || 
                        (item.role_in_contract && filterRoles.includes(item.role_in_contract.toLowerCase()));

                    matchesTeam = filterTeams.length === 0 || 
                        (item.firm_name && filterTeams.includes(item.firm_name.toLowerCase()));

                } else if (currentSection === 'teams') {
                    matchesSearch = !searchTerm || 
                        (item.firm_name && item.firm_name.toLowerCase().includes(searchTerm)) ||
                        (item.location && item.location.toLowerCase().includes(searchTerm));

                    matchesName = filterNames.length === 0 || 
                        (item.firm_name && filterNames.includes(item.firm_name.toLowerCase()));

                    matchesRole = filterRoles.length === 0 || 
                        (item.location && filterRoles.includes(item.location.toLowerCase()));
                }

                return matchesSearch && matchesName && matchesRole && matchesTeam;
            });

            renderTable();
            updateResultsCount();
        }

        function updateFilterCounts() {
            // Update name filter count
            const nameCount = selectedNames.length;
            document.getElementById('nameCount').textContent = nameCount === 0 ? '0 selected' : `${nameCount} selected`;

            // Update role filter count
            const roleCount = selectedRoles.length;
            document.getElementById('roleCount').textContent = roleCount === 0 ? '0 selected' : `${roleCount} selected`;

            // Update team filter count
            const teamCount = selectedTeams.length;
            document.getElementById('teamCount').textContent = teamCount === 0 ? '0 selected' : `${teamCount} selected`;
        }

        function clearAllFilters() {
            // Clear all selections
            selectedNames = [];
            selectedRoles = [];
            selectedTeams = [];

            // Uncheck all checkboxes
            document.querySelectorAll('.dropdown-content input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
            });

            // Clear search
            searchInput.value = '';
            searchTerm = '';

            // Close all dropdowns
            closeAllDropdowns();

            // Update counts, dropdown text and apply filters
            updateFilterCounts();
            updateDropdownText();
            applyFilters();
        }

        function renderTable() {
            if (filteredData.length === 0) {
                showEmpty();
                return;
            }

            // Ensure loading is hidden and table is shown
            hideLoading();
            hideEmpty();
            showTable();

            if (currentSection === 'employees') {
                renderEmployeesTable();
            } else if (currentSection === 'projects') {
                renderProjectsTable();
            } else if (currentSection === 'teams') {
                renderTeamsTable();
            }
        }

        function renderTeamBadges(firmName) {
            if (!firmName) return '-';
            
            // Split by comma and clean up names
            const teams = firmName.split(',').map(team => team.trim()).filter(team => team);
            
            if (teams.length === 0) return '-';
            
            const badges = teams.map(team => {
                // Truncate long team names
                const displayName = team.length > 30 ? team.substring(0, 30) + '...' : team;
                return `<span class="team-badge" title="${team}">${displayName}</span>`;
            }).join('');
            
            return `<div class="team-badges-container">${badges}</div>`;
        }

        function renderEmployeesTable() {
            tableBody.innerHTML = filteredData.map((employee, index) => `
                <tr class="clickable-row" onclick="showEmployeeDetail('${employee.employee_name ? employee.employee_name.replace(/'/g, '\\\'') : ''}')">
                    <td><span class="employee-name">${employee.employee_name || '-'}</span></td>
                    <td><span class="role-text">${deduplicateRoles(employee.role_in_contract) || '-'}</span></td>
                    <td>${employee.firm_name ? renderTeamBadges(employee.firm_name) : '<span style="color: #9ca3af; font-style: italic;">No team assigned</span>'}</td>
                    <td><span class="projects-count">${employee.total_projects || 0} project${(employee.total_projects || 0) !== 1 ? 's' : ''}</span></td>
                </tr>
            `).join('');
        }

        function renderProjectsTable() {
            tableBody.innerHTML = filteredData.map(project => `
                <tr>
                    <td><span class="employee-name">${project.title_and_location || '-'}</span></td>
                    <td>${project.employee_name || '-'}</td>
                    <td>${project.firm_name ? renderTeamBadges(project.firm_name) : '-'}</td>
                    <td>${project.professional_services_year || '-'}</td>
                    <td><span class="role-text">${project.role_in_contract || '-'}</span></td>
                    <td>${project.description_scope ? project.description_scope.substring(0, 100) + '...' : '-'}</td>
                </tr>
            `).join('');
        }

        function renderTeamsTable() {
            tableBody.innerHTML = filteredData.map(team => `
                <tr>
                    <td><span class="employee-name">${team.firm_name || '-'}</span></td>
                    <td>${team.location || '-'}</td>
                    <td>${team.total_employees || 0} employees</td>
                    <td>${team.avg_total_experience ? Math.round(team.avg_total_experience) + ' years' : '-'}</td>
                    <td>${team.total_projects || 0} projects</td>
                    <td>${team.earliest_project_year && team.latest_project_year ? 
                        `${team.earliest_project_year} - ${team.latest_project_year}` : '-'}</td>
                </tr>
            `).join('');
        }

        function updateResultsCount() {
            if (resultsCount) {
                resultsCount.textContent = `${filteredData.length} result${filteredData.length !== 1 ? 's' : ''}`;
            }
        }

        function showLoading() {
            if (loadingState) {
                loadingState.style.display = 'block';
            }
            if (emptyState) {
                emptyState.style.display = 'none';
            }
            if (dataTable) {
                dataTable.style.display = 'none';
            }
        }



        function showEmpty() {
            hideLoading();
            if (emptyState) {
                emptyState.style.display = 'block';
            }
            if (dataTable) {
                dataTable.style.display = 'none';
            }
        }

        function hideEmpty() {
            if (emptyState) {
                emptyState.style.display = 'none';
            }
        }

        function showTable() {
            if (dataTable) {
                dataTable.style.display = 'table';
            }
        }

        function showError(message) {
            if (loadingState) {
                loadingState.innerHTML = `
                    <i class="fas fa-exclamation-triangle" style="color: #ef4444;"></i>
                    <p><strong>Error</strong></p>
                    <p>${message}</p>
                `;
            } else {
                console.error('Error:', message);
            }
        }

        // Employee Detail Functions
        async function showEmployeeDetail(employeeName) {
            if (!employeeName) return;
            
            try {
                // Hide list view and show detail view
                document.getElementById('listView').style.display = 'none';
                document.getElementById('employeeDetailView').style.display = 'block';
                
                // Update header
                document.getElementById('employeeDetailName').textContent = `${employeeName} - Employee Details`;
                
                // Load employee details
                await loadEmployeeDetails(employeeName);
                
            } catch (error) {
                console.error('Error showing employee detail:', error);
                showError('Failed to load employee details');
            }
        }

        async function loadEmployeeDetails(employeeName) {
            try {
                let employeeData = null;
                let allEmployeeData = [];
                let projectsData = [];

                if (isDemoMode) {
                    // Demo mode - use local API
                    try {
                        const response = await fetch(`/api/employee/${encodeURIComponent(employeeName)}`);
                        if (response.ok) {
                            employeeData = await response.json();
                            allEmployeeData = [employeeData];
                            projectsData = employeeData.relevant_projects || [];
                        } else {
                            throw new Error(`API error: ${response.status}`);
                        }
                    } catch (apiError) {
                        console.warn('API call failed, using local data:', apiError);
                        // Fallback to existing local data if API fails
                        employeeData = allData.find(emp => emp.employee_name === employeeName);
                        allEmployeeData = allData.filter(emp => emp.employee_name === employeeName);
                    }
                } else {
                    // Real Supabase mode - fetch detailed data
                    const { data: employeeProfiles, error: empError } = await supabase
                        .from('employee_profiles')
                        .select('*')
                        .eq('employee_name', employeeName);
                    
                    if (empError) throw empError;
                    employeeData = employeeProfiles[0];

                    if (!employeeData) {
                        throw new Error('Employee not found');
                    }

                    // Fetch employee assignments using employee_id for more reliable filtering
                    const { data: assignments, error: assignError } = await supabase
                        .from('employee_assignments')
                        .select(`
                            *,
                            employees(*),
                            projects(*),
                            teams(*)
                        `)
                        .eq('employee_id', employeeData.employee_id);
                    
                    if (assignError) throw assignError;
                    allEmployeeData = assignments;

                    // Extract projects from assignments (projects are already joined)
                    projectsData = assignments
                        .filter(assignment => assignment.projects) // Only assignments with projects
                        .map(assignment => ({
                            ...assignment.projects, // Project data from join
                            role_in_contract: assignment.role_in_contract, // Role from assignment
                            assignment_id: assignment.assignment_id // Keep assignment reference
                        }));
                }

                // Populate the detail view
                populateEmployeeDetails(employeeData, allEmployeeData, projectsData);

            } catch (error) {
                console.error('Error loading employee details:', error);
                showDetailError('Failed to load employee data');
            }
        }

        function populateEmployeeDetails(employee, allData, projects) {
            if (!employee) {
                showDetailError('Employee not found');
                return;
            }

            // Store current employee data for editing
            currentEmployeeData = { ...employee };

            // Personal Information
            document.getElementById('detailName').textContent = employee.employee_name || '-';
            document.getElementById('detailExperience').textContent = 
                employee.total_years_experience ? `${employee.total_years_experience} years` : '-';
            document.getElementById('detailRole').textContent = deduplicateRoles(employee.role_in_contract) || '-';
            document.getElementById('detailFirm').textContent = employee.firm_name || '-';

            // Education
            populateEducation(employee);

            // Professional Qualifications & Registrations
            populateRegistrations(employee);

            // Teams & Firms
            populateTeams(allData);

            // Projects
            populateProjects(projects || allData);

            // Meta Information
            populateMeta(employee, allData);
        }

        function populateEducation(employee) {
            const educationDiv = document.getElementById('detailEducation');
            
            if (employee.education) {
                educationDiv.innerHTML = `<p>${employee.education}</p>`;
            } else {
                educationDiv.innerHTML = '<p class="text-gray">No education information available</p>';
            }
        }

        function populateRegistrations(employee) {
            const registrationsDiv = document.getElementById('detailRegistrations');
            
            if (employee.current_professional_registration || employee.other_professional_qualifications) {
                let html = '';
                
                if (employee.current_professional_registration) {
                    html += `<h4>Professional Registration:</h4><p>${employee.current_professional_registration}</p>`;
                }
                
                if (employee.other_professional_qualifications) {
                    html += `<h4>Other Professional Qualifications:</h4><p>${employee.other_professional_qualifications}</p>`;
                }
                
                registrationsDiv.innerHTML = html;
            } else {
                registrationsDiv.innerHTML = '<p class="text-gray">No professional qualifications information available</p>';
            }
        }

        function populateTeams(allData) {
            const teamsDiv = document.getElementById('detailTeams');
            
            // Extract unique teams and roles
            const teamRoleMap = new Map();
            
            // Handle demo mode vs real mode data structures
            if (isDemoMode) {
                // In demo mode, use the current employee data directly
                if (currentEmployeeData && currentEmployeeData.firm_name) {
                    const firms = currentEmployeeData.firm_name.split(',').map(f => f.trim());
                    const roles = currentEmployeeData.role_in_contract ? currentEmployeeData.role_in_contract.split(',').map(r => r.trim()) : [''];
                    
                    firms.forEach((firm, index) => {
                        const role = roles[index] || roles[0] || '';
                        if (!teamRoleMap.has(firm)) {
                            teamRoleMap.set(firm, new Set());
                        }
                        if (role) teamRoleMap.get(firm).add(role);
                    });
                }
            } else {
                // Real mode - handle assignment data from Supabase
                if (Array.isArray(allData)) {
                    allData.forEach(item => {
                        // Handle assignments with teams data
                        let firmName = '';
                        let roleName = '';
                        
                        if (item.teams && item.teams.firm_name) {
                            firmName = item.teams.firm_name;
                        } else if (item.firm_name) {
                            firmName = item.firm_name;
                        }
                        
                        if (item.role_in_contract) {
                            roleName = item.role_in_contract;
                        }
                        
                        if (firmName) {
                            const firms = firmName.split(',').map(f => f.trim());
                            const roles = roleName ? roleName.split(',').map(r => r.trim()) : [''];
                            
                            firms.forEach((firm, index) => {
                                const role = roles[index] || roles[0] || '';
                                if (!teamRoleMap.has(firm)) {
                                    teamRoleMap.set(firm, new Set());
                                }
                                if (role) teamRoleMap.get(firm).add(role);
                            });
                        }
                    });
                } else if (allData && allData.firm_name) {
                    // Fallback for single employee data
                    const firms = allData.firm_name.split(',').map(f => f.trim());
                    const roles = allData.role_in_contract ? allData.role_in_contract.split(',').map(r => r.trim()) : [''];
                    
                    firms.forEach((firm, index) => {
                        const role = roles[index] || roles[0] || '';
                        if (!teamRoleMap.has(firm)) {
                            teamRoleMap.set(firm, new Set());
                        }
                        if (role) teamRoleMap.get(firm).add(role);
                    });
                }
            }
            
            if (teamRoleMap.size > 0) {
                let html = '';
                teamRoleMap.forEach((roles, firm) => {
                    const rolesArray = Array.from(roles).filter(Boolean);
                    html += `
                        <div class="team-item">
                            <div>
                                <div class="team-name">${firm}</div>
                                <div class="team-roles">${rolesArray.length > 0 ? rolesArray.join(', ') : 'No specific role'}</div>
                            </div>
                        </div>
                    `;
                });
                teamsDiv.innerHTML = html;
            } else {
                teamsDiv.innerHTML = '<p class="text-gray">No team information available</p>';
            }
        }

        function populateProjects(projects) {
            const projectsDiv = document.getElementById('detailProjects');
            
            if (projects && projects.length > 0) {
                let html = '';
                projects.forEach(project => {
                    // Handle different data structures
                    const projectTitle = project.title_and_location || project.title || 'Untitled Project';
                    
                    // Handle year - could be in different formats
                    let year = 'Year not specified';
                    if (project.professional_services_year) {
                        year = project.professional_services_year;
                    } else if (project.year_completed) {
                        if (typeof project.year_completed === 'object') {
                            year = project.year_completed.professional_services || project.year_completed.construction || 'Year not specified';
                        } else {
                            year = project.year_completed;
                        }
                    }
                    
                    // Handle firm name
                    const firmName = project.firm_name || '';
                    
                    // Handle role - from project description or assignment
                    let role = project.role_in_contract || '';
                    if (project.description_role) {
                        role = project.description_role; // Supabase structure
                    } else if (project.description && project.description.role) {
                        role = project.description.role; // Local data structure
                    }
                    
                    // Handle description - for both Supabase and local data
                    let description = '';
                    if (project.description_scope) {
                        description = project.description_scope;
                        // Add cost and fee info if available (Supabase structure)
                        if (project.description_cost) {
                            description += ` Cost: ${project.description_cost}.`;
                        }
                        if (project.description_fee) {
                            description += ` Fee: ${project.description_fee}.`;
                        }
                    } else if (project.description) {
                        if (typeof project.description === 'object') {
                            description = project.description.scope || '';
                            // Add cost and fee info if available (local data structure)
                            if (project.description.cost) {
                                description += ` Cost: ${project.description.cost}.`;
                            }
                            if (project.description.fee) {
                                description += ` Fee: ${project.description.fee}.`;
                            }
                        } else {
                            description = project.description;
                        }
                    }
                    
                    // Create unique project ID for editing
                    const projectId = project.project_id || project.assignment_id || `project_${Math.random().toString(36).substr(2, 9)}`;
                    const hasRealProjectId = project.project_id ? true : false;
                    
                    html += `
                        <div class="project-item" data-project-id="${projectId}" data-has-real-id="${hasRealProjectId}">
                            <button class="project-edit-icon" onclick="editIndividualProject('${projectId}')" title="Edit Project">
                                <i class="fas fa-pencil-alt"></i>
                            </button>
                            ${hasRealProjectId ? 
                                `<button class="project-delete-icon" onclick="deleteIndividualProject('${projectId}')" title="Delete Project">
                                    <i class="fas fa-trash-alt"></i>
                                </button>` :
                                `<button class="project-delete-icon-disabled" title="Cannot delete: No valid project ID" disabled>
                                    <i class="fas fa-trash-alt"></i>
                                </button>`
                            }
                            <h4>${projectTitle}</h4>
                            <div class="project-meta">
                                <span><i class="fas fa-calendar"></i> ${year}</span>
                                ${firmName ? `<span><i class="fas fa-building"></i> ${firmName}</span>` : ''}
                                ${role ? `<span><i class="fas fa-user-tie"></i> ${role}</span>` : ''}
                            </div>
                            ${description ? `<div class="project-description">${description}</div>` : ''}
                        </div>
                    `;
                });
                projectsDiv.innerHTML = html;
            } else {
                projectsDiv.innerHTML = '<p class="text-gray">No projects information available</p>';
            }
        }

        function populateMeta(employee, allData) {
            // Use total_projects from employee_profiles view
            const totalProjects = employee.total_projects ? employee.total_projects.toString() : '0';
            
            document.getElementById('detailTotalProjects').textContent = totalProjects;
            document.getElementById('detailSourceFiles').textContent = employee.source_filename || 'N/A';
            
            // Handle date formatting
            let lastUpdated = 'N/A';
            if (employee.updated_at) {
                try {
                    lastUpdated = new Date(employee.updated_at).toLocaleDateString();
                } catch (e) {
                    lastUpdated = employee.updated_at;
                }
            } else if (employee.created_at) {
                try {
                    lastUpdated = new Date(employee.created_at).toLocaleDateString();
                } catch (e) {
                    lastUpdated = employee.created_at;
                }
            }
            
            document.getElementById('detailLastUpdated').textContent = lastUpdated;
            document.getElementById('detailId').textContent = employee.employee_id || 'N/A';
        }

        function showDetailError(message) {
            const sections = document.querySelectorAll('.detail-content');
            sections.forEach(section => {
                section.innerHTML = `<p style="color: #ef4444;">${message}</p>`;
            });
        }

        function backToList() {
            document.getElementById('employeeDetailView').style.display = 'none';
            document.getElementById('listView').style.display = 'block';
        }

        // Edit Functionality
        async function editField(fieldName, elementId, inputType) {
            if (!currentEmployeeData) return;

            const element = document.getElementById(elementId);
            const detailItem = element.closest('.detail-item');
            const currentValue = getCurrentFieldValue(fieldName);
            
            // Create input element
            const input = document.createElement('input');
            input.type = inputType;
            input.value = currentValue;
            input.className = 'edit-input';
            
            // Add edit mode class
            detailItem.classList.add('edit-mode');
            
            // Replace span with input
            element.style.display = 'none';
            element.parentNode.insertBefore(input, element.nextSibling);
            
            // Create action buttons
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'edit-actions';
            actionsDiv.innerHTML = `
                <button class="save-btn" onclick="saveFieldUpdate('${fieldName}', '${elementId}', '${inputType}')">
                    <i class="fas fa-check"></i> Save
                </button>
                <button class="cancel-btn" onclick="cancelEdit('${elementId}')">
                    <i class="fas fa-times"></i> Cancel
                </button>
            `;
            
            input.parentNode.insertBefore(actionsDiv, input.nextSibling);
            input.focus();
            
            // Handle Enter key
            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    saveFieldUpdate(fieldName, elementId, inputType);
                }
            });
        }

        async function editContentField(fieldName, elementId, inputType) {
            if (!currentEmployeeData) return;

            const element = document.getElementById(elementId);
            const wrapper = element.closest('.edit-content-wrapper');
            const currentValue = getCurrentFieldValue(fieldName);
            
            // Create textarea element
            const textarea = document.createElement('textarea');
            textarea.value = currentValue;
            textarea.className = 'edit-textarea';
            
            // Replace content with textarea
            element.style.display = 'none';
            element.parentNode.insertBefore(textarea, element.nextSibling);
            
            // Create action buttons
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'edit-actions';
            actionsDiv.innerHTML = `
                <button class="save-btn" onclick="saveContentFieldUpdate('${fieldName}', '${elementId}')">
                    <i class="fas fa-check"></i> Save
                </button>
                <button class="cancel-btn" onclick="cancelContentEdit('${elementId}')">
                    <i class="fas fa-times"></i> Cancel
                </button>
            `;
            
            textarea.parentNode.insertBefore(actionsDiv, textarea.nextSibling);
            textarea.focus();
        }

        async function editQualificationsField() {
            if (!currentEmployeeData) return;

            const element = document.getElementById('detailRegistrations');
            
            // Get current values
            const registration = currentEmployeeData.current_professional_registration || '';
            const qualifications = currentEmployeeData.other_professional_qualifications || '';
            
            // Create edit form
            const editForm = document.createElement('div');
            editForm.className = 'edit-qualifications-form';
            editForm.innerHTML = `
                <div class="qualification-field">
                    <label>Professional Registration:</label>
                    <textarea id="editRegistration" placeholder="Enter professional registration...">${registration}</textarea>
                </div>
                <div class="qualification-field">
                    <label>Other Professional Qualifications:</label>
                    <textarea id="editQualifications" placeholder="Enter other qualifications...">${qualifications}</textarea>
                </div>
                <div class="edit-actions">
                    <button class="save-btn" onclick="saveQualificationsUpdate()">
                        <i class="fas fa-check"></i> Save
                    </button>
                    <button class="cancel-btn" onclick="cancelQualificationsEdit()">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                </div>
            `;
            
            element.style.display = 'none';
            element.parentNode.insertBefore(editForm, element.nextSibling);
        }

        async function editTeamsField() {
            if (!currentEmployeeData) return;

            const element = document.getElementById('detailTeams');
            
            // Get current values
            const firmName = currentEmployeeData.firm_name || '';
            
            // Create edit form
            const editForm = document.createElement('div');
            editForm.className = 'edit-teams-form';
            editForm.innerHTML = `
                <div class="team-field">
                    <label>Firm Names (comma-separated):</label>
                    <textarea id="editTeams" placeholder="Enter firm names separated by commas...">${firmName}</textarea>
                </div>
                <div class="edit-actions">
                    <button class="save-btn" onclick="saveTeamsUpdate()">
                        <i class="fas fa-check"></i> Save
                    </button>
                    <button class="cancel-btn" onclick="cancelTeamsEdit()">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                </div>
            `;
            
            element.style.display = 'none';
            element.parentNode.insertBefore(editForm, element.nextSibling);
        }

        async function editProjectsField() {
            alert('Use the individual edit buttons on each project to edit specific projects.');
        }

        async function editIndividualProject(projectId) {
            if (!currentEmployeeData) return;

            // Find the project data
            const projectElement = document.querySelector(`[data-project-id="${projectId}"]`);
            if (!projectElement) {
                alert('Project not found');
                return;
            }

            // Extract current project data from the DOM
            const titleElement = projectElement.querySelector('h4');
            const metaElement = projectElement.querySelector('.project-meta');
            const descriptionElement = projectElement.querySelector('.project-description');

            const currentTitle = titleElement.textContent.trim();
            const currentDescription = descriptionElement ? descriptionElement.textContent.trim() : '';
            
                         // Extract role and year from meta
            let currentRole = '';
            let currentYear = '';
            if (metaElement) {
                const metaSpans = metaElement.querySelectorAll('span');
                metaSpans.forEach(span => {
                    const icon = span.querySelector('i');
                    const text = span.textContent.trim();
                    
                    if (icon && (icon.classList.contains('fa-calendar') || text.match(/\d{4}/))) {
                        const yearMatch = text.match(/(\d{4})/);
                        if (yearMatch) currentYear = yearMatch[1];
                    } else if (icon && icon.classList.contains('fa-user-tie')) {
                        // Extract text after the icon
                        const iconText = span.textContent.replace(icon.textContent || '', '').trim();
                        if (iconText) currentRole = iconText;
                    } else if (!icon && text && !text.match(/\d{4}/) && !currentRole) {
                        // Fallback: if no icon detected and not a year, treat as role
                        currentRole = text;
                    }
                });
            }

            // Create edit form
            const editForm = document.createElement('div');
            editForm.className = 'edit-project-form';
            editForm.innerHTML = `
                <div class="project-edit-header">
                    <h4>Edit Project</h4>
                    <button class="close-edit-btn" onclick="cancelProjectEdit('${projectId}')">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="project-field">
                    <label>Project Title & Location:</label>
                    <input type="text" id="editProjectTitle" value="${currentTitle}" placeholder="Enter project title and location...">
                </div>
                <div class="project-field">
                    <label>Year:</label>
                    <input type="number" id="editProjectYear" value="${currentYear}" placeholder="Enter year..." min="1950" max="2030">
                </div>
                <div class="project-field">
                    <label>Role in Project:</label>
                    <input type="text" id="editProjectRole" value="${currentRole}" placeholder="Enter your role in this project...">
                </div>
                <div class="project-field">
                    <label>Project Description:</label>
                    <textarea id="editProjectDescription" placeholder="Enter detailed project description...">${currentDescription}</textarea>
                </div>
                <div class="edit-actions">
                    <button class="save-btn" onclick="saveProjectUpdate('${projectId}')">
                        <i class="fas fa-check"></i> Save Changes
                    </button>
                    <button class="cancel-btn" onclick="cancelProjectEdit('${projectId}')">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                </div>
            `;
            
            // Hide original project and show edit form
            projectElement.style.display = 'none';
            projectElement.parentNode.insertBefore(editForm, projectElement.nextSibling);
        }

        async function saveProjectUpdate(projectId) {
            const titleValue = document.getElementById('editProjectTitle').value.trim();
            const yearValue = document.getElementById('editProjectYear').value.trim();
            const roleValue = document.getElementById('editProjectRole').value.trim();
            const descriptionValue = document.getElementById('editProjectDescription').value.trim();
            
            if (!titleValue) {
                alert('Please enter a project title');
                return;
            }

            const editForm = document.querySelector('.edit-project-form');
            showLoading(editForm);
            
            try {
                // Note: In demo mode, we only update the UI
                // In real mode, you would update the actual database
                if (!isDemoMode) {
                    // Update projects table (for project-specific fields)
                    const { error: projectError } = await supabase
                        .from('projects')
                        .update({
                            title_and_location: titleValue,
                            professional_services_year: yearValue ? parseInt(yearValue) : null,
                            description_scope: descriptionValue
                        })
                        .eq('project_id', projectId);
                    
                    if (projectError) throw projectError;
                    
                    // Update employee_assignments table (for role_in_contract)
                    if (roleValue && currentEmployeeData && currentEmployeeData.employee_id) {
                        const { error: assignmentError } = await supabase
                            .from('employee_assignments')
                            .update({
                                role_in_contract: roleValue
                            })
                            .eq('project_id', projectId)
                            .eq('employee_id', currentEmployeeData.employee_id);
                        
                        if (assignmentError) throw assignmentError;
                    }
                }
                
                // Update the UI
                const projectElement = document.querySelector(`[data-project-id="${projectId}"]`);
                if (projectElement) {
                    // Update title
                    const titleElement = projectElement.querySelector('h4');
                    if (titleElement) titleElement.textContent = titleValue;
                    
                    // Update meta info
                    const metaElement = projectElement.querySelector('.project-meta');
                    if (metaElement) {
                        let metaHTML = '';
                        if (yearValue) metaHTML += `<span><i class="fas fa-calendar"></i> ${yearValue}</span>`;
                        if (currentEmployeeData.firm_name) metaHTML += `<span><i class="fas fa-building"></i> ${currentEmployeeData.firm_name}</span>`;
                        if (roleValue) metaHTML += `<span><i class="fas fa-user-tie"></i> ${roleValue}</span>`;
                        metaElement.innerHTML = metaHTML;
                    }
                    
                    // Update description
                    let descriptionElement = projectElement.querySelector('.project-description');
                    if (descriptionValue) {
                        if (!descriptionElement) {
                            descriptionElement = document.createElement('div');
                            descriptionElement.className = 'project-description';
                            projectElement.appendChild(descriptionElement);
                        }
                        descriptionElement.textContent = descriptionValue;
                    } else if (descriptionElement) {
                        descriptionElement.remove();
                    }
                }
                
                // Reset UI
                cancelProjectEdit(projectId);
                
                // Show success message
                showSuccessMessage('Project updated successfully!');
                
            } catch (error) {
                console.error('Error updating project:', error);
                alert('Failed to update project. Please try again.');
            } finally {
                hideLoading(editForm);
            }
        }

        function cancelProjectEdit(projectId) {
            const projectElement = document.querySelector(`[data-project-id="${projectId}"]`);
            const editForm = document.querySelector('.edit-project-form');
            
            if (editForm) editForm.remove();
            if (projectElement) projectElement.style.display = '';
        }

        function getCurrentFieldValue(fieldName) {
            if (!currentEmployeeData) return '';
            
            switch(fieldName) {
                case 'employee_name':
                    return currentEmployeeData.employee_name || '';
                case 'total_years_experience':
                    return currentEmployeeData.total_years_experience || '';
                case 'role_in_contract':
                    return currentEmployeeData.role_in_contract || '';
                case 'firm_name':
                    return currentEmployeeData.firm_name || '';
                case 'education':
                    return currentEmployeeData.education || '';
                default:
                    return '';
            }
        }

        async function saveFieldUpdate(fieldName, elementId, inputType) {
            const detailItem = document.querySelector(`[data-field="${fieldName}"]`);
            const input = detailItem.querySelector('.edit-input');
            const newValue = input.value.trim();
            
            if (!currentEmployeeData || !newValue) {
                alert('Please enter a valid value');
                return;
            }

            // Show loading
            showLoading(detailItem);
            
            try {
                // Update Supabase
                const updateData = {};
                updateData[fieldName] = inputType === 'number' ? parseInt(newValue) : newValue;
                
                const { error } = await supabase
                    .from('employees')
                    .update(updateData)
                    .eq('employee_id', currentEmployeeData.employee_id);
                
                if (error) throw error;
                
                // Update local data
                currentEmployeeData[fieldName] = updateData[fieldName];
                
                // Update UI
                const element = document.getElementById(elementId);
                if (fieldName === 'total_years_experience') {
                    element.textContent = `${newValue} years`;
                } else {
                    element.textContent = newValue;
                }
                
                // If firm_name was updated, refresh the Teams section
                if (fieldName === 'firm_name') {
                    populateTeams([currentEmployeeData]);
                }
                
                // Reset UI
                cancelEdit(elementId);
                
                // Show success message
                showSuccessMessage('Field updated successfully!');
                
            } catch (error) {
                console.error('Error updating field:', error);
                alert('Failed to update field. Please try again.');
            } finally {
                hideLoading(detailItem);
            }
        }

        async function saveContentFieldUpdate(fieldName, elementId) {
            const wrapper = document.querySelector(`#${elementId}`).closest('.edit-content-wrapper');
            const textarea = wrapper.querySelector('.edit-textarea');
            const newValue = textarea.value.trim();
            
            if (!currentEmployeeData) {
                alert('No employee data available');
                return;
            }

            // Show loading
            showLoading(wrapper);
            
            try {
                // Update Supabase
                const updateData = {};
                updateData[fieldName] = newValue;
                
                const { error } = await supabase
                    .from('employees')
                    .update(updateData)
                    .eq('employee_id', currentEmployeeData.employee_id);
                
                if (error) throw error;
                
                // Update local data
                currentEmployeeData[fieldName] = newValue;
                
                // Update UI
                populateEducation(currentEmployeeData);
                
                // Reset UI
                cancelContentEdit(elementId);
                
                // Show success message
                showSuccessMessage('Education updated successfully!');
                
            } catch (error) {
                console.error('Error updating education:', error);
                alert('Failed to update education. Please try again.');
            } finally {
                hideLoading(wrapper);
            }
        }

        async function saveQualificationsUpdate() {
            const registrationValue = document.getElementById('editRegistration').value.trim();
            const qualificationsValue = document.getElementById('editQualifications').value.trim();
            
            if (!currentEmployeeData) {
                alert('No employee data available');
                return;
            }

            const wrapper = document.getElementById('detailRegistrations').closest('.edit-content-wrapper');
            showLoading(wrapper);
            
            try {
                // Update current_professional_registration in employees table
                const { error: empError } = await supabase
                    .from('employees')
                    .update({
                        current_professional_registration: registrationValue
                    })
                    .eq('employee_id', currentEmployeeData.employee_id);
                
                if (empError) throw empError;
                
                // Update other_professional_qualifications in employee_assignments table
                // First get existing assignments
                const { data: assignments, error: assignError } = await supabase
                    .from('employee_assignments')
                    .select('assignment_id')
                    .eq('employee_id', currentEmployeeData.employee_id);
                
                if (assignError) throw assignError;
                
                // Update all assignments with the new qualifications
                if (assignments && assignments.length > 0) {
                    const { error: qualError } = await supabase
                        .from('employee_assignments')
                        .update({
                            other_professional_qualifications: qualificationsValue
                        })
                        .eq('employee_id', currentEmployeeData.employee_id);
                    
                    if (qualError) throw qualError;
                } else {
                    // If no assignments exist, create a base assignment record
                    const { error: createError } = await supabase
                        .from('employee_assignments')
                        .insert({
                            employee_id: currentEmployeeData.employee_id,
                            other_professional_qualifications: qualificationsValue
                        });
                    
                    if (createError) throw createError;
                }
                
                // Update local data
                currentEmployeeData.current_professional_registration = registrationValue;
                currentEmployeeData.other_professional_qualifications = qualificationsValue;
                
                // Update UI
                populateRegistrations(currentEmployeeData);
                
                // Reset UI
                cancelQualificationsEdit();
                
                // Show success message
                showSuccessMessage('Qualifications updated successfully!');
                
            } catch (error) {
                console.error('Error updating qualifications:', error);
                alert('Failed to update qualifications. Please try again.');
            } finally {
                hideLoading(wrapper);
            }
        }

        async function saveTeamsUpdate() {
            const teamsValue = document.getElementById('editTeams').value.trim();
            
            if (!currentEmployeeData) {
                alert('No employee data available');
                return;
            }

            const wrapper = document.getElementById('detailTeams').closest('.edit-content-wrapper');
            showLoading(wrapper);
            
            try {
                // Update Supabase
                const { error } = await supabase
                    .from('employees')
                    .update({
                        firm_name: teamsValue
                    })
                    .eq('employee_id', currentEmployeeData.employee_id);
                
                if (error) throw error;
                
                // Update local data
                currentEmployeeData.firm_name = teamsValue;
                
                // Update UI - need to pass the updated employee data
                populateTeams([currentEmployeeData]);
                
                // Reset UI
                cancelTeamsEdit();
                
                // Show success message
                showSuccessMessage('Teams updated successfully!');
                
            } catch (error) {
                console.error('Error updating teams:', error);
                alert('Failed to update teams. Please try again.');
            } finally {
                hideLoading(wrapper);
            }
        }

        function cancelEdit(elementId) {
            const element = document.getElementById(elementId);
            const detailItem = element.closest('.detail-item');
            
            // Remove edit elements
            const input = detailItem.querySelector('.edit-input');
            const actions = detailItem.querySelector('.edit-actions');
            
            if (input) input.remove();
            if (actions) actions.remove();
            
            // Show original element
            element.style.display = '';
            detailItem.classList.remove('edit-mode');
        }

        function cancelContentEdit(elementId) {
            const element = document.getElementById(elementId);
            const wrapper = element.closest('.edit-content-wrapper');
            
            // Remove edit elements
            const textarea = wrapper.querySelector('.edit-textarea');
            const actions = wrapper.querySelector('.edit-actions');
            
            if (textarea) textarea.remove();
            if (actions) actions.remove();
            
            // Show original element
            element.style.display = '';
        }

        function cancelQualificationsEdit() {
            const element = document.getElementById('detailRegistrations');
            const wrapper = element.closest('.edit-content-wrapper');
            const editForm = wrapper.querySelector('.edit-qualifications-form');
            
            if (editForm) editForm.remove();
            element.style.display = '';
        }

        function cancelTeamsEdit() {
            const element = document.getElementById('detailTeams');
            const wrapper = element.closest('.edit-content-wrapper');
            const editForm = wrapper.querySelector('.edit-teams-form');
            
            if (editForm) editForm.remove();
            element.style.display = '';
        }

        function showLoading(container) {
            if (!container) {
                console.error('showLoading called with undefined container');
                return;
            }
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'loading-overlay';
            loadingDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Updating...';
            container.style.position = 'relative';
            container.appendChild(loadingDiv);
        }

        function hideLoading(container) {
            if (!container) {
                // Handle global loading state when no container provided
                if (loadingState) {
                    loadingState.style.display = 'none';
                }
                return;
            }
            const loadingDiv = container.querySelector('.loading-overlay');
            if (loadingDiv) loadingDiv.remove();
        }

        function showSuccessMessage(message) {
            // Create success notification
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #10b981;
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 8px;
                z-index: 10000;
                box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                font-weight: 500;
            `;
            notification.innerHTML = `<i class="fas fa-check"></i> ${message}`;
            
            document.body.appendChild(notification);
            
            // Remove after 3 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 3000);
        }

        // Event Listeners
        document.getElementById('backToListBtn').addEventListener('click', backToList);

        // Initialize the application after DOM is fully loaded
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            // DOM is already loaded
            init();
        }

        // Section E Resume Functions
        let sectionESelectedProjects = [];
        let sectionEAvailableProjects = [];
        let employeeRoles = [];
        let employeeFirms = [];
        let availableTemplates = [];
        let availableQualifications = [];
        let sectionESelectedQualifications = [];
        let tempSelectedQualifications = [];
        let sectionESelectedRegistration = null;
        let tempSelectedRegistration = null;

        async function openSectionEModal() {
            if (!currentEmployeeData) {
                alert('Please select an employee first');
                return;
            }

            // Populate form with current employee data
            document.getElementById('sectionE_employeeName').value = currentEmployeeData.employee_name || '';
            document.getElementById('sectionE_totalExperience').value = currentEmployeeData.total_years_experience || '';
            
            // Setup role and firm dropdowns/inputs based on available data (with location auto-population)
            await setupRoleAndFirmFields();
            
            // Education (readonly)
            document.getElementById('sectionE_education').value = currentEmployeeData.education || '';
            
            // Load qualifications data (for potential future use)
            await loadAvailableQualifications();

            // Reset selected projects, qualifications, and registration
            sectionESelectedProjects = [];
            sectionESelectedQualifications = [];
            sectionESelectedRegistration = null;
            
            // Load available projects for this employee
            loadAvailableProjects();
            
            // Load available templates
            loadAvailableTemplates();
            
            // Reset UI
            updateSelectedProjectsDisplay();
            updateSelectedQualificationsDisplay();
            updateSelectedRegistrationDisplay();
            updateProjectsCount();

            // Show modal
            document.getElementById('sectionEModal').style.display = 'block';
        }

        async function setupRoleAndFirmFields() {
            // Parse roles from employee data with deduplication
            const deduplicatedRole = deduplicateRoles(currentEmployeeData.role_in_contract);
            employeeRoles = deduplicatedRole ? 
                deduplicatedRole.split(',').map(r => r.trim()).filter(Boolean) : [];
            
            // Load firm and location data from database if available
            let employeeFirmsWithLocations = [];
            if (!isDemoMode && currentEmployeeData.employee_id) {
                try {
                    console.log('Loading firm and location data for employee:', currentEmployeeData.employee_name);
                    const { data: assignments, error } = await supabase
                        .from('employee_assignments')
                        .select(`
                            teams (
                                firm_name,
                                location
                            )
                        `)
                        .eq('employee_id', currentEmployeeData.employee_id)
                        .not('teams', 'is', null);
                    
                    if (!error && assignments) {
                        // Extract unique firm-location combinations
                        const firmLocationSet = new Set();
                        assignments.forEach(assignment => {
                            if (assignment.teams) {
                                const firmName = assignment.teams.firm_name || '';
                                const location = assignment.teams.location || '';
                                if (firmName) {
                                    firmLocationSet.add(JSON.stringify({ firmName, location }));
                                }
                            }
                        });
                        
                        employeeFirmsWithLocations = Array.from(firmLocationSet).map(str => JSON.parse(str));
                        console.log('Loaded firm-location data:', employeeFirmsWithLocations);
                    }
                } catch (dbError) {
                    console.warn('Failed to load firm-location data from database:', dbError);
                }
            }
            
            // Fallback to parsing from firm_name if no database data
            if (employeeFirmsWithLocations.length === 0 && currentEmployeeData.firm_name) {
                const firms = currentEmployeeData.firm_name.split(',').map(f => f.trim()).filter(Boolean);
                employeeFirmsWithLocations = firms.map(firmName => ({ firmName, location: '' }));
            }
            
            // Extract just firm names for dropdown/input population
            employeeFirms = employeeFirmsWithLocations.map(fl => fl.firmName);

            const roleSelect = document.getElementById('sectionE_roleInContract');
            const roleInput = document.getElementById('sectionE_roleInContract_input');
            const firmSelect = document.getElementById('sectionE_firmName');
            const firmInput = document.getElementById('sectionE_firmName_input');
            const locationInput = document.getElementById('sectionE_location');

            // Setup role field
            if (employeeRoles.length > 1) {
                // Multiple roles - use dropdown
                roleSelect.innerHTML = '<option value="">Select a role...</option>';
                employeeRoles.forEach(role => {
                    const option = document.createElement('option');
                    option.value = role;
                    option.textContent = role;
                    roleSelect.appendChild(option);
                });
                roleSelect.style.display = 'block';
                roleInput.style.display = 'none';
                roleSelect.value = employeeRoles[0]; // Default to first role
            } else {
                // Single or no role - use input
                roleSelect.style.display = 'none';
                roleInput.style.display = 'block';
                roleInput.value = employeeRoles[0] || '';
            }

            // Setup firm field
            if (employeeFirms.length > 1) {
                // Multiple firms - use dropdown
                firmSelect.innerHTML = '<option value="">Select a firm...</option>';
                employeeFirmsWithLocations.forEach(firmData => {
                    const option = document.createElement('option');
                    option.value = firmData.firmName;
                    option.textContent = firmData.firmName;
                    option.dataset.location = firmData.location; // Store location in data attribute
                    firmSelect.appendChild(option);
                });
                firmSelect.style.display = 'block';
                firmInput.style.display = 'none';
                firmSelect.value = employeeFirms[0]; // Default to first firm
                
                // Auto-populate location when firm is selected
                firmSelect.addEventListener('change', function() {
                    const selectedOption = this.options[this.selectedIndex];
                    if (selectedOption && selectedOption.dataset.location) {
                        locationInput.value = selectedOption.dataset.location;
                        console.log('Auto-populated location:', selectedOption.dataset.location);
                    } else {
                        locationInput.value = '';
                    }
                });
                
                // Set initial location if first firm is pre-selected
                if (employeeFirmsWithLocations.length > 0 && employeeFirmsWithLocations[0].location) {
                    locationInput.value = employeeFirmsWithLocations[0].location;
                }
            } else {
                // Single or no firm - use input
                firmSelect.style.display = 'none';
                firmInput.style.display = 'block';
                firmInput.value = employeeFirms[0] || '';
                
                // Set location for single firm if available
                if (employeeFirmsWithLocations.length > 0 && employeeFirmsWithLocations[0].location) {
                    locationInput.value = employeeFirmsWithLocations[0].location;
                    console.log('Set location for single firm:', employeeFirmsWithLocations[0].location);
                } else {
                    locationInput.value = ''; // Clear if no location data
                }
            }
        }

        async function loadAvailableQualifications() {
            availableQualifications = [];
            
            try {
                if (!isDemoMode && currentEmployeeData.employee_id) {
                    console.log('Loading qualifications for employee:', currentEmployeeData.employee_name);
                    console.log('Current employee data:', currentEmployeeData);
                    
                    // First try to load directly from employee_assignments for other_professional_qualifications
                    try {
                        const { data: assignments, error: assignError } = await supabase
                            .from('employee_assignments')
                            .select('other_professional_qualifications')
                            .eq('employee_id', currentEmployeeData.employee_id)
                            .not('other_professional_qualifications', 'is', null);
                        
                        if (!assignError && assignments) {
                            // Get unique qualifications from assignments
                            const uniqueQualifications = [...new Set(
                                assignments
                                    .map(a => a.other_professional_qualifications)
                                    .filter(q => q && q.trim())
                            )];
                            
                            console.log('Found qualifications in assignments:', uniqueQualifications);
                            
                            // Create qualification entries
                            uniqueQualifications.forEach((qual, index) => {
                                availableQualifications.push({
                                    qualification_id: `assignment_${index}`,
                                    current_professional_registration: currentEmployeeData.current_professional_registration || '',
                                    other_professional_qualifications: qual,
                                    source_filename: 'employee_assignments',
                                    is_primary: index === 0
                                });
                            });
                        }
                    } catch (dbError) {
                        console.warn('Failed to load from employee_assignments:', dbError);
                    }
                    
                    // Also try the API endpoint
                    try {
                        const response = await fetch(`/api/employee-qualifications/${currentEmployeeData.employee_id}`);
                        if (response.ok) {
                            const result = await response.json();
                            if (result.qualifications && result.qualifications.length > 0) {
                                availableQualifications = result.qualifications;
                                console.log('Loaded qualifications from API:', availableQualifications);
                            }
                        }
                    } catch (apiError) {
                        console.warn('API endpoint not available:', apiError);
                    }
                    
                    // Fallback to current employee data if nothing else worked
                    if (availableQualifications.length === 0) {
                        console.log('Using fallback data from currentEmployeeData');
                        if (currentEmployeeData.current_professional_registration || currentEmployeeData.other_professional_qualifications) {
                            availableQualifications = [{
                                qualification_id: 'current',
                                current_professional_registration: currentEmployeeData.current_professional_registration || '',
                                other_professional_qualifications: currentEmployeeData.other_professional_qualifications || '',
                                source_filename: 'current',
                                is_primary: true
                            }];
                        }
                    }
                } else {
                    // Demo mode - use current employee data if available
                    console.log('Demo mode - using current employee data');
                    if (currentEmployeeData.current_professional_registration || currentEmployeeData.other_professional_qualifications) {
                        availableQualifications = [{
                            qualification_id: 'demo',
                            current_professional_registration: currentEmployeeData.current_professional_registration || '',
                            other_professional_qualifications: currentEmployeeData.other_professional_qualifications || '',
                            source_filename: 'demo_data',
                            is_primary: true
                        }];
                    }
                }
                
                console.log('Final loaded qualifications:', availableQualifications);
            } catch (error) {
                console.error('Error loading qualifications:', error);
                availableQualifications = [];
            }
        }

        function setupQualificationFields() {
            console.log('Setting up qualification fields...');
            console.log('Available qualifications for setup:', availableQualifications);
            
            const registrationSelect = document.getElementById('sectionE_registration');
            const registrationInput = document.getElementById('sectionE_registration_input');
            const qualificationsSelect = document.getElementById('sectionE_qualifications');
            const qualificationsInput = document.getElementById('sectionE_qualifications_input');

            // Extract unique registration values
            const registrationOptions = availableQualifications
                .map(q => q.current_professional_registration)
                .filter(reg => reg && reg.trim())
                .filter((reg, index, array) => array.indexOf(reg) === index); // Remove duplicates

            // Extract unique other qualifications values
            const qualificationOptions = availableQualifications
                .map(q => q.other_professional_qualifications)
                .filter(qual => qual && qual.trim())
                .filter((qual, index, array) => array.indexOf(qual) === index); // Remove duplicates

            console.log('Registration options:', registrationOptions);
            console.log('Qualification options:', qualificationOptions);

            // Setup registration field
            if (registrationOptions.length > 1) {
                // Multiple registrations - use dropdown
                registrationSelect.innerHTML = '<option value="">Select a registration...</option>';
                registrationOptions.forEach(registration => {
                    const option = document.createElement('option');
                    option.value = registration;
                    option.textContent = registration;
                    registrationSelect.appendChild(option);
                });
                registrationSelect.style.display = 'block';
                registrationInput.style.display = 'none';
                
                // Set primary as default
                const primaryQual = availableQualifications.find(q => q.is_primary);
                if (primaryQual && primaryQual.current_professional_registration) {
                    registrationSelect.value = primaryQual.current_professional_registration;
                } else if (registrationOptions.length > 0) {
                    registrationSelect.value = registrationOptions[0];
                }
            } else {
                // Single or no registration - use input
                registrationSelect.style.display = 'none';
                registrationInput.style.display = 'block';
                
                // Set primary as default or first available
                const primaryQual = availableQualifications.find(q => q.is_primary);
                if (primaryQual && primaryQual.current_professional_registration) {
                    registrationInput.value = primaryQual.current_professional_registration;
                    console.log('Set registration input to primary:', primaryQual.current_professional_registration);
                } else if (registrationOptions.length > 0) {
                    registrationInput.value = registrationOptions[0];
                    console.log('Set registration input to first option:', registrationOptions[0]);
                } else {
                    registrationInput.value = '';
                    console.log('Set registration input to empty');
                }
            }

            // Setup qualifications field
            if (qualificationOptions.length > 1) {
                // Multiple qualifications - use dropdown
                qualificationsSelect.innerHTML = '<option value="">Select qualifications...</option>';
                qualificationOptions.forEach(qualification => {
                    const option = document.createElement('option');
                    option.value = qualification;
                    option.textContent = qualification;
                    qualificationsSelect.appendChild(option);
                });
                qualificationsSelect.style.display = 'block';
                qualificationsInput.style.display = 'none';
                
                // Set primary as default
                const primaryQual = availableQualifications.find(q => q.is_primary);
                if (primaryQual && primaryQual.other_professional_qualifications) {
                    qualificationsSelect.value = primaryQual.other_professional_qualifications;
                } else if (qualificationOptions.length > 0) {
                    qualificationsSelect.value = qualificationOptions[0];
                }
            } else {
                // Single or no qualifications - use input
                qualificationsSelect.style.display = 'none';
                qualificationsInput.style.display = 'block';
                
                // Set primary as default or first available
                const primaryQual = availableQualifications.find(q => q.is_primary);
                if (primaryQual && primaryQual.other_professional_qualifications) {
                    qualificationsInput.value = primaryQual.other_professional_qualifications;
                    console.log('Set qualifications input to primary:', primaryQual.other_professional_qualifications);
                } else if (qualificationOptions.length > 0) {
                    qualificationsInput.value = qualificationOptions[0];
                    console.log('Set qualifications input to first option:', qualificationOptions[0]);
                } else {
                    qualificationsInput.value = '';
                    console.log('Set qualifications input to empty');
                }
            }
            
            // Final verification
            console.log('Final field values:');
            console.log('Registration input value:', registrationInput.value);
            console.log('Registration select value:', registrationSelect.value);
            console.log('Qualifications input value:', qualificationsInput.value);
            console.log('Qualifications select value:', qualificationsSelect.value);
        }

        function closeSectionEModal() {
            document.getElementById('sectionEModal').style.display = 'none';
            sectionESelectedProjects = [];
            sectionEAvailableProjects = [];
            tempSelectedProjects = [];
            sectionESelectedQualifications = [];
            tempSelectedQualifications = [];
            sectionESelectedRegistration = null;
            tempSelectedRegistration = null;
        }

        async function loadAvailableProjects() {
            sectionEAvailableProjects = [];
            
            try {
                if (!isDemoMode && currentEmployeeData.employee_id) {
                    // Load from database using employee_assignments with joins
                    const { data, error } = await supabase
                        .from('employee_assignments')
                        .select(`
                            assignment_id,
                            role_in_contract,
                            project_order,
                            projects (
                                project_id,
                                title_and_location,
                                professional_services_year,
                                construction_year,
                                description_scope,
                                description_cost,
                                description_fee,
                                description_role
                            ),
                            teams (
                                firm_name,
                                location
                            )
                        `)
                        .eq('employee_id', currentEmployeeData.employee_id)
                        .not('projects', 'is', null)
                        .order('project_order');
                    
                    if (error) throw error;
                    
                    if (data && data.length > 0) {
                        sectionEAvailableProjects = data.map((assignment, index) => {
                            const project = assignment.projects;
                            const team = assignment.teams;
                            
                            return {
                                id: project.project_id || `project_${index}`,
                                title: project.title_and_location || '',
                                year: project.professional_services_year || project.construction_year || '',
                                professionalServicesYear: project.professional_services_year,
                                constructionYear: project.construction_year,
                                role: assignment.role_in_contract || project.description_role || '',
                                description: project.description_scope || '',
                                cost: project.description_cost || '',
                                fee: project.description_fee || '',
                                firm: team ? team.firm_name : '',
                                performedWithSameFirm: false,
                                isDatabase: true,
                                assignmentId: assignment.assignment_id
                            };
                        });
                    }
                } else {
                    // Demo mode - use sample projects
                    sectionEAvailableProjects = [
                        {
                            id: 'demo_1',
                            title: 'Highway Bridge Replacement - Denver, CO',
                            year: '2023',
                            professionalServicesYear: 2023,
                            constructionYear: 2024,
                            role: 'Project Engineer',
                            description: 'Complete bridge replacement including design, permitting, and construction oversight for a major interstate crossing.',
                            cost: '$12.5M',
                            fee: '$1.2M',
                            firm: 'Engineering Solutions Inc',
                            performedWithSameFirm: false,
                            isDatabase: false
                        },
                        {
                            id: 'demo_2',
                            title: 'Water Treatment Plant Upgrade - Boulder, CO',
                            year: '2022',
                            professionalServicesYear: 2022,
                            constructionYear: 2023,
                            role: 'Lead Engineer',
                            description: 'Major upgrades to municipal water treatment facility including new filtration systems and capacity expansion.',
                            cost: '$8.7M',
                            fee: '$850K',
                            firm: 'Engineering Solutions Inc',
                            performedWithSameFirm: false,
                            isDatabase: false
                        },
                        {
                            id: 'demo_3',
                            title: 'Downtown Infrastructure Revitalization - Fort Collins, CO',
                            year: '2021',
                            professionalServicesYear: 2021,
                            constructionYear: 2022,
                            role: 'Project Engineer',
                            description: 'Comprehensive infrastructure improvements including utilities, roadways, and pedestrian enhancements.',
                            cost: '$5.3M',
                            fee: '$520K',
                            firm: 'Engineering Solutions Inc',
                            performedWithSameFirm: false,
                            isDatabase: false
                        }
                    ];
                }
            } catch (error) {
                console.error('Error loading available projects:', error);
                sectionEAvailableProjects = [];
            }
        }

        function updateSelectedProjectsDisplay() {
            const selectedProjectsList = document.getElementById('sectionE_selectedProjectsList');
            const placeholder = document.getElementById('selectedProjectsPlaceholder');
            
            if (sectionESelectedProjects.length === 0) {
                placeholder.style.display = 'flex';
                // Remove all project items except placeholder
                const projectItems = selectedProjectsList.querySelectorAll('.selected-project-item');
                projectItems.forEach(item => item.remove());
            } else {
                placeholder.style.display = 'none';
                
                // Clear existing project items
                const projectItems = selectedProjectsList.querySelectorAll('.selected-project-item');
                projectItems.forEach(item => item.remove());
                
                // Add selected projects
                sectionESelectedProjects.forEach((project, index) => {
                    const projectDiv = document.createElement('div');
                    projectDiv.className = 'selected-project-item';
                    projectDiv.innerHTML = `
                        <div class="selected-project-content">
                            <!-- Project Title (Editable) -->
                            <div style="margin-bottom: 12px;">
                                <label style="display: block; font-size: 0.8rem; color: #374151; font-weight: 500; margin-bottom: 4px;">
                                    <i class="fas fa-project-diagram" style="color: #6b7280; margin-right: 4px;"></i>Project Title & Location
                                </label>
                                <input type="text" 
                                       id="projectTitle_${project.id}" 
                                       value="${project.title || ''}" 
                                       placeholder="Enter project title and location"
                                       onchange="updateProjectField('${project.id}', 'title', this.value)"
                                       style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.95rem; font-weight: 500;">
                            </div>

                            <!-- Project Description/Scope (Editable) -->
                            <div style="margin-bottom: 12px;">
                                <label style="display: block; font-size: 0.8rem; color: #374151; font-weight: 500; margin-bottom: 4px;">
                                    <i class="fas fa-file-text" style="color: #6b7280; margin-right: 4px;"></i>Project Description/Scope
                                </label>
                                <textarea 
                                       id="projectDescription_${project.id}" 
                                       placeholder="Enter project description and scope of work"
                                       onchange="updateProjectField('${project.id}', 'description', this.value)"
                                       style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.9rem; min-height: 80px; resize: vertical;">${project.description || ''}</textarea>
                            </div>

                            <!-- Role and Firm Fields -->
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
                                <div>
                                    <label style="display: block; font-size: 0.8rem; color: #374151; font-weight: 500; margin-bottom: 4px;">
                                        <i class="fas fa-user-tie" style="color: #6b7280; margin-right: 4px;"></i>Role in Project
                                    </label>
                                    <input type="text" 
                                           id="projectRole_${project.id}" 
                                           value="${project.role || ''}" 
                                           placeholder="e.g., Project Manager"
                                           onchange="updateProjectField('${project.id}', 'role', this.value)"
                                           style="width: 100%; padding: 6px 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.9rem;">
                                </div>
                                <div>
                                    <label style="display: block; font-size: 0.8rem; color: #374151; font-weight: 500; margin-bottom: 4px;">
                                        <i class="fas fa-building" style="color: #6b7280; margin-right: 4px;"></i>Firm Name
                                    </label>
                                    <input type="text" 
                                           id="projectFirm_${project.id}" 
                                           value="${project.firm || ''}" 
                                           placeholder="e.g., MSMM Engineering LLC"
                                           onchange="updateProjectField('${project.id}', 'firm', this.value)"
                                           style="width: 100%; padding: 6px 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.9rem;">
                                </div>
                            </div>

                            <!-- Project Cost and Fee -->
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
                                <div>
                                    <label style="display: block; font-size: 0.8rem; color: #374151; font-weight: 500; margin-bottom: 4px;">
                                        <i class="fas fa-dollar-sign" style="color: #6b7280; margin-right: 4px;"></i>Project Cost
                                    </label>
                                    <input type="text" 
                                           id="projectCost_${project.id}" 
                                           value="${project.cost || ''}" 
                                           placeholder="e.g., $2.5M"
                                           onchange="updateProjectField('${project.id}', 'cost', this.value)"
                                           style="width: 100%; padding: 6px 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.9rem;">
                                </div>
                                <div>
                                    <label style="display: block; font-size: 0.8rem; color: #374151; font-weight: 500; margin-bottom: 4px;">
                                        <i class="fas fa-receipt" style="color: #6b7280; margin-right: 4px;"></i>Professional Fee
                                    </label>
                                    <input type="text" 
                                           id="projectFee_${project.id}" 
                                           value="${project.fee || ''}" 
                                           placeholder="e.g., $250K"
                                           onchange="updateProjectField('${project.id}', 'fee', this.value)"
                                           style="width: 100%; padding: 6px 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.9rem;">
                                </div>
                            </div>

                            <!-- Year Fields -->
                            <div style="margin-bottom: 12px; padding: 8px; background: #f8fafc; border-radius: 6px; border: 1px solid #e2e8f0;">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                    <div>
                                        <label style="display: block; font-size: 0.8rem; color: #374151; font-weight: 500; margin-bottom: 4px;">
                                            <i class="fas fa-briefcase" style="color: #6b7280; margin-right: 4px;"></i>Professional Services Year
                                        </label>
                                        <input type="number" 
                                               id="profServicesYear_${project.id}" 
                                               value="${project.professionalServicesYear || ''}" 
                                               placeholder="e.g., 2023"
                                               min="1950" 
                                               max="2030"
                                               onchange="updateProjectYear('${project.id}', 'professional', this.value)"
                                               style="width: 100%; padding: 6px 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.9rem;">
                                    </div>
                                    <div>
                                        <label style="display: block; font-size: 0.8rem; color: #374151; font-weight: 500; margin-bottom: 4px;">
                                            <i class="fas fa-hammer" style="color: #6b7280; margin-right: 4px;"></i>Construction Year
                                        </label>
                                        <input type="number" 
                                               id="constructionYear_${project.id}" 
                                               value="${project.constructionYear || ''}" 
                                               placeholder="e.g., 2024"
                                               min="1950" 
                                               max="2030"
                                               onchange="updateProjectYear('${project.id}', 'construction', this.value)"
                                               style="width: 100%; padding: 6px 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.9rem;">
                                    </div>
                                </div>
                            </div>

                            <!-- Same Firm Checkbox -->
                            <div style="padding: 8px; background: #f8fafc; border-radius: 6px; border: 1px solid #e2e8f0;">
                                <label style="display: flex; align-items: center; gap: 8px; font-size: 0.9rem; color: #374151; cursor: pointer;">
                                    <input type="checkbox" 
                                           id="sameFireChkbox_${project.id}" 
                                           ${project.performedWithSameFirm ? 'checked' : ''} 
                                           onchange="updateProjectCheckbox('${project.id}', this.checked)"
                                           style="margin: 0;">
                                    <span><i class="fas fa-building" style="color: #6b7280; margin-right: 4px;"></i>Check if project performed with same firm</span>
                                </label>
                            </div>
                        </div>
                        <button type="button" class="remove-selected-project-btn" onclick="removeSelectedProject('${project.id}')">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    selectedProjectsList.appendChild(projectDiv);
                });
            }
        }

        function updateProjectsCount() {
            const countElement = document.getElementById('selectedProjectsCount');
            countElement.textContent = sectionESelectedProjects.length;
            
            // Update button states
            const addProjectsBtn = document.querySelector('.add-project-btn');
            const addCustomBtn = document.querySelector('.add-custom-project-btn');
            
            if (sectionESelectedProjects.length >= 5) {
                addProjectsBtn.disabled = true;
                addCustomBtn.disabled = true;
                addProjectsBtn.style.opacity = '0.5';
                addCustomBtn.style.opacity = '0.5';
            } else {
                addProjectsBtn.disabled = false;
                addCustomBtn.disabled = false;
                addProjectsBtn.style.opacity = '1';
                addCustomBtn.style.opacity = '1';
            }
        }

        function removeSelectedProject(projectId) {
            sectionESelectedProjects = sectionESelectedProjects.filter(project => project.id !== projectId);
            updateSelectedProjectsDisplay();
            updateProjectsCount();
        }

        function updateProjectCheckbox(projectId, isChecked) {
            const project = sectionESelectedProjects.find(p => p.id === projectId);
            if (project) {
                project.performedWithSameFirm = isChecked;
                console.log(`Project ${projectId} - Performed with same firm: ${isChecked}`);
            }
        }

        function updateProjectField(projectId, fieldName, value) {
            const project = sectionESelectedProjects.find(p => p.id === projectId);
            if (project) {
                project[fieldName] = value;
                console.log(`Project ${projectId} - ${fieldName}: ${value}`);
                
                // For title changes, also update the display title if needed
                if (fieldName === 'title') {
                    project.title = value;
                }
            }
        }

        async function updateProjectYear(projectId, yearType, yearValue) {
            const project = sectionESelectedProjects.find(p => p.id === projectId);
            if (!project) {
                console.error(`Project ${projectId} not found`);
                return;
            }

            // Update the local project data
            if (yearType === 'professional') {
                project.professionalServicesYear = yearValue ? parseInt(yearValue) : null;
                console.log(`Project ${projectId} - Professional services year: ${yearValue}`);
            } else if (yearType === 'construction') {
                project.constructionYear = yearValue ? parseInt(yearValue) : null;
                console.log(`Project ${projectId} - Construction year: ${yearValue}`);
            }

            // Update Supabase if not in demo mode and project is from database
            if (!isDemoMode && project.isDatabase && currentEmployeeData) {
                try {
                    const updateData = {};
                    if (yearType === 'professional') {
                        updateData.professional_services_year = yearValue ? parseInt(yearValue) : null;
                    } else if (yearType === 'construction') {
                        updateData.construction_year = yearValue ? parseInt(yearValue) : null;
                    }

                    const { error } = await supabase
                        .from('projects')
                        .update(updateData)
                        .eq('project_id', projectId);

                    if (error) {
                        console.error('Error updating project year:', error);
                        // Revert local change on error
                        if (yearType === 'professional') {
                            project.professionalServicesYear = null;
                            document.getElementById(`profServicesYear_${projectId}`).value = '';
                        } else if (yearType === 'construction') {
                            project.constructionYear = null;
                            document.getElementById(`constructionYear_${projectId}`).value = '';
                        }
                    } else {
                        console.log(`Successfully updated ${yearType} year in database`);
                    }
                } catch (error) {
                    console.error('Error updating project year:', error);
                }
            }
        }

        function openProjectSelectionModal() {
            console.log('Opening project selection modal...');
            
            if (sectionESelectedProjects.length >= 5) {
                alert('You can only select up to 5 projects.');
                return;
            }
            
            if (!currentEmployeeData) {
                alert('No employee data available.');
                return;
            }
            
            // Initialize temporary selection with currently selected projects
            tempSelectedProjects = [...sectionESelectedProjects];
            
            // Set employee name in modal
            const employeeNameElement = document.getElementById('employeeNameInModal');
            if (employeeNameElement) {
                employeeNameElement.textContent = currentEmployeeData.employee_name || 'this employee';
            }
            
            // Show loading message
            const availableProjectsList = document.getElementById('availableProjectsList');
            if (availableProjectsList) {
                availableProjectsList.innerHTML = '<div style="text-align: center; padding: 20px;"><i class="fas fa-spinner fa-spin"></i> Loading projects...</div>';
            }
            
            // Show modal first
            const modal = document.getElementById('projectSelectionModal');
            if (modal) {
                modal.style.display = 'block';
                console.log('Modal displayed');
            } else {
                console.error('Project selection modal not found!');
                return;
            }
            
            // Then populate available projects
            populateAvailableProjects();
        }

        function closeProjectSelectionModal() {
            document.getElementById('projectSelectionModal').style.display = 'none';
            tempSelectedProjects = [];
        }

        function populateAvailableProjects() {
            console.log('Populating available projects...', sectionEAvailableProjects);
            
            const availableProjectsList = document.getElementById('availableProjectsList');
            const modalSelectedCount = document.getElementById('modalSelectedCount');
            
            if (!availableProjectsList) {
                console.error('availableProjectsList element not found');
                return;
            }
            
            if (!modalSelectedCount) {
                console.error('modalSelectedCount element not found');
                return;
            }
            
            availableProjectsList.innerHTML = '';
            modalSelectedCount.textContent = tempSelectedProjects.length;
            
            if (sectionEAvailableProjects.length === 0) {
                availableProjectsList.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #6b7280;">
                        <i class="fas fa-project-diagram" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                        <p>No projects found for this employee.</p>
                        <p style="font-size: 0.875rem; margin-top: 10px;">
                            This employee may not have any projects assigned, or there may be a data loading issue.
                        </p>
                    </div>
                `;
                return;
            }
            
                         sectionEAvailableProjects.forEach(project => {
                const isSelected = tempSelectedProjects.some(selected => selected.id === project.id);
                const isDisabled = !isSelected && tempSelectedProjects.length >= 5;
                
                const projectDiv = document.createElement('div');
                projectDiv.className = `available-project-item ${isSelected ? 'selected' : ''} ${isDisabled ? 'disabled' : ''}`;
                projectDiv.onclick = isDisabled ? null : () => toggleProjectSelection(project);
                
                projectDiv.innerHTML = `
                    <input type="checkbox" class="project-checkbox" ${isSelected ? 'checked' : ''} ${isDisabled ? 'disabled' : ''}>
                    <div class="available-project-content">
                        <div class="available-project-title">${project.title}</div>
                        <div class="available-project-meta">
                            <span><i class="fas fa-calendar"></i> ${project.year || 'No year'}</span>
                            <span><i class="fas fa-user-tie"></i> ${project.role || 'No role'}</span>
                            ${project.firm ? `<span><i class="fas fa-building"></i> ${project.firm}</span>` : ''}
                        </div>
                        ${project.description ? `<div class="available-project-description">${project.description}</div>` : ''}
                    </div>
                `;
                
                availableProjectsList.appendChild(projectDiv);
            });
        }

        let tempSelectedProjects = [];

        function toggleProjectSelection(project) {
            const isCurrentlySelected = tempSelectedProjects.some(selected => selected.id === project.id);
            
            if (isCurrentlySelected) {
                tempSelectedProjects = tempSelectedProjects.filter(selected => selected.id !== project.id);
            } else {
                if (tempSelectedProjects.length < 5) {
                    tempSelectedProjects.push(project);
                }
            }
            
            populateAvailableProjects();
            document.getElementById('modalSelectedCount').textContent = tempSelectedProjects.length;
        }

        function addSelectedProjectsToResume() {
            // Replace selected projects with the new selection, ensuring each has required properties
            sectionESelectedProjects = tempSelectedProjects.map(project => ({
                ...project,
                performedWithSameFirm: project.performedWithSameFirm || false,
                professionalServicesYear: project.professionalServicesYear || null,
                constructionYear: project.constructionYear || null
            }));
            tempSelectedProjects = [];
            
            updateSelectedProjectsDisplay();
            updateProjectsCount();
            closeProjectSelectionModal();
        }

        function addNewCustomProject() {
            if (sectionESelectedProjects.length >= 5) {
                alert('You can only select up to 5 projects.');
                return;
            }
            
            const currentYear = new Date().getFullYear();
            const customProject = {
                id: `custom_${Date.now()}`,
                title: 'Custom Project Title',
                year: currentYear.toString(),
                professionalServicesYear: currentYear,
                constructionYear: null,
                role: employeeRoles[0] || 'Project Role',
                description: 'Project description...',
                cost: '',
                fee: '',
                firm: employeeFirms[0] || '',
                isDatabase: false,
                isCustom: true,
                performedWithSameFirm: false
            };
            
            sectionESelectedProjects.push(customProject);
            updateSelectedProjectsDisplay();
            updateProjectsCount();
            
            // Make the newly added project editable
            setTimeout(() => {
                const projectItems = document.querySelectorAll('.selected-project-item');
                const lastProject = projectItems[projectItems.length - 1];
                if (lastProject) {
                    makeProjectEditable(lastProject, customProject);
                }
            }, 100);
        }

        function makeProjectEditable(projectElement, project) {
            const titleElement = projectElement.querySelector('.selected-project-title');
            const metaElement = projectElement.querySelector('.selected-project-meta');
            
            // Create editable form
            const editForm = document.createElement('div');
            editForm.innerHTML = `
                <div class="section-e-form-group" style="margin-bottom: 10px;">
                    <input type="text" value="${project.title}" id="edit_title_${project.id}" style="width: 100%; margin-bottom: 5px;">
                </div>
                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                    <input type="number" value="${project.year}" id="edit_year_${project.id}" placeholder="Year" style="width: 80px;">
                    <input type="text" value="${project.role}" id="edit_role_${project.id}" placeholder="Role" style="flex: 1;">
                </div>
                <div style="display: flex; gap: 10px;">
                    <button onclick="saveProjectEdit('${project.id}')" style="background: #059669; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">Save</button>
                    <button onclick="cancelProjectEdit('${project.id}')" style="background: #6b7280; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">Cancel</button>
                </div>
            `;
            
            projectElement.querySelector('.selected-project-content').replaceWith(editForm);
        }

        function saveProjectEdit(projectId) {
            const project = sectionESelectedProjects.find(p => p.id === projectId);
            if (project) {
                project.title = document.getElementById(`edit_title_${projectId}`).value;
                project.year = document.getElementById(`edit_year_${projectId}`).value;
                project.role = document.getElementById(`edit_role_${projectId}`).value;
            }
            updateSelectedProjectsDisplay();
        }

        function cancelProjectEdit(projectId) {
            updateSelectedProjectsDisplay();
        }

        // Professional Qualifications Management Functions
        function updateSelectedQualificationsDisplay() {
            const selectedQualificationsList = document.getElementById('sectionE_selectedQualificationsList');
            const placeholder = document.getElementById('selectedQualificationsPlaceholder');
            const countElement = document.getElementById('selectedQualificationsCount');

            if (sectionESelectedQualifications.length === 0) {
                placeholder.style.display = 'flex';
                // Remove any existing qualification items
                const qualificationItems = selectedQualificationsList.querySelectorAll('.selected-qualification-item');
                qualificationItems.forEach(item => item.remove());
            } else {
                placeholder.style.display = 'none';
                // Remove any existing qualification items first
                const qualificationItems = selectedQualificationsList.querySelectorAll('.selected-qualification-item');
                qualificationItems.forEach(item => item.remove());

                // Add current qualifications
                sectionESelectedQualifications.forEach((qualification, index) => {
                    const qualificationDiv = document.createElement('div');
                    qualificationDiv.className = 'selected-qualification-item';
                    qualificationDiv.innerHTML = `
                        <div class="qualification-info">
                            <div class="qualification-text">${qualification.text}</div>
                        </div>
                        <button type="button" class="remove-qualification-btn" onclick="removeSelectedQualification('${qualification.id}')">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    selectedQualificationsList.appendChild(qualificationDiv);
                });
            }

            // Update count
            countElement.textContent = sectionESelectedQualifications.length;
        }

        function removeSelectedQualification(qualificationId) {
            sectionESelectedQualifications = sectionESelectedQualifications.filter(qual => qual.id !== qualificationId);
            updateSelectedQualificationsDisplay();
        }

        async function openQualificationsSelectionModal() {
            console.log('Opening qualifications selection modal...');
            
            if (!currentEmployeeData) {
                alert('No employee data available.');
                return;
            }
            
            // Initialize temporary selection with currently selected qualifications
            tempSelectedQualifications = [...sectionESelectedQualifications];
            
            // Set employee name in modal
            const employeeNameElement = document.getElementById('employeeNameInQualModal');
            if (employeeNameElement) {
                employeeNameElement.textContent = currentEmployeeData.employee_name || 'this employee';
            }
            
            // Show modal first
            const modal = document.getElementById('qualificationsSelectionModal');
            if (modal) {
                modal.style.display = 'block';
                console.log('Qualifications modal displayed');
            } else {
                console.error('Qualifications selection modal not found!');
                return;
            }
            
            // Then populate available qualifications
            await populateAvailableQualifications();
        }

        function closeQualificationsSelectionModal() {
            document.getElementById('qualificationsSelectionModal').style.display = 'none';
            tempSelectedQualifications = [];
        }

        async function populateAvailableQualifications() {
            console.log('Populating available qualifications...');
            
            const qualificationsGrid = document.getElementById('qualificationsGrid');
            
            if (!qualificationsGrid) {
                console.error('Qualifications grid not found');
                return;
            }
            
            qualificationsGrid.innerHTML = '<div style="text-align: center; padding: 20px;"><i class="fas fa-spinner fa-spin"></i> Loading qualifications...</div>';
            
            let availableQualifications = [];
            
            try {
                if (!isDemoMode && currentEmployeeData.employee_id) {
                    // Load actual qualifications from professional_qualifications table
                    console.log('Loading qualifications for employee:', currentEmployeeData.employee_name);
                    const { data: qualifications, error } = await supabase
                        .from('professional_qualifications')
                        .select('other_professional_qualifications')
                        .eq('employee_id', currentEmployeeData.employee_id)
                        .not('other_professional_qualifications', 'is', null);
                    
                    if (!error && qualifications) {
                        // Extract qualifications exactly as stored in database - no splitting or parsing
                        const allQualifications = [];
                        qualifications.forEach(q => {
                            if (q.other_professional_qualifications && q.other_professional_qualifications.trim()) {
                                // Add the qualification exactly as it appears in the database
                                allQualifications.push(q.other_professional_qualifications.trim());
                            }
                        });
                        
                        // Get unique qualifications (preserve exact text)
                        availableQualifications = [...new Set(allQualifications)];
                        console.log('Loaded qualifications from database (exact text):', availableQualifications);
                    } else if (error) {
                        console.error('Error loading qualifications:', error);
                    }
                } else {
                    // Demo mode - use sample data
                    availableQualifications = [
                        'OSHA 30-Hour Construction Safety',
                        'AutoCAD Certified User',
                        'Revit Architecture Certified'
                    ];
                }
            } catch (dbError) {
                console.error('Database error loading qualifications:', dbError);
                // Fallback to empty array
                availableQualifications = [];
            }
            
            // Populate qualifications
            qualificationsGrid.innerHTML = '';
            
            if (availableQualifications.length === 0) {
                qualificationsGrid.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #6b7280;">
                        <i class="fas fa-certificate" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                        <p>No existing qualifications found for this employee.</p>
                        <p style="font-size: 0.875rem; margin-top: 10px;">
                            Use the custom input below to add qualifications.
                        </p>
                    </div>
                `;
                return;
            }
            
            availableQualifications.forEach((qualification, index) => {
                const qualificationId = `qual_${index}`;
                const isSelected = tempSelectedQualifications.some(q => q.text === qualification);
                
                const optionDiv = document.createElement('div');
                optionDiv.className = `qualification-option ${isSelected ? 'selected' : ''}`;
                optionDiv.onclick = () => toggleQualificationSelection(qualificationId, qualification);
                
                optionDiv.innerHTML = `
                    <input type="checkbox" class="qualification-checkbox" ${isSelected ? 'checked' : ''}>
                    <div class="qualification-label">${qualification}</div>
                `;
                
                qualificationsGrid.appendChild(optionDiv);
            });
        }

        async function toggleQualificationSelection(id, text) {
            const isCurrentlySelected = tempSelectedQualifications.some(q => q.text === text);
            
            if (isCurrentlySelected) {
                tempSelectedQualifications = tempSelectedQualifications.filter(q => q.text !== text);
            } else {
                tempSelectedQualifications.push({
                    id: `qual_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                    text: text
                });
            }
            
            // Update visual selection
            await populateAvailableQualifications();
        }

        async function addCustomQualification() {
            const input = document.getElementById('customQualificationInput');
            const text = input.value.trim();
            
            if (!text) {
                alert('Please enter a qualification.');
                return;
            }
            
            // Check if already exists
            if (tempSelectedQualifications.some(q => q.text === text)) {
                alert('This qualification is already selected.');
                return;
            }
            
            tempSelectedQualifications.push({
                id: `qual_custom_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                text: text
            });
            
            input.value = '';
            await populateAvailableQualifications();
        }

        function addSelectedQualificationsToResume() {
            // Replace selected qualifications with the new selection
            sectionESelectedQualifications = [...tempSelectedQualifications];
            tempSelectedQualifications = [];
            
            updateSelectedQualificationsDisplay();
            closeQualificationsSelectionModal();
        }

        function addNewCustomQualification() {
            // Open the modal and focus on the qualification input
            openQualificationsSelectionModal();
            setTimeout(() => {
                const input = document.getElementById('customQualificationInput');
                if (input) {
                    input.focus();
                }
            }, 100);
        }

        // Professional Registration Management Functions
        function updateSelectedRegistrationDisplay() {
            const selectedRegistrationDisplay = document.getElementById('sectionE_selectedRegistrationDisplay');
            const placeholder = document.getElementById('selectedRegistrationPlaceholder');

            if (!sectionESelectedRegistration) {
                placeholder.style.display = 'flex';
                // Remove any existing registration items
                const registrationItems = selectedRegistrationDisplay.querySelectorAll('.selected-registration-item');
                registrationItems.forEach(item => item.remove());
            } else {
                placeholder.style.display = 'none';
                // Remove any existing registration items first
                const registrationItems = selectedRegistrationDisplay.querySelectorAll('.selected-registration-item');
                registrationItems.forEach(item => item.remove());

                // Add current registration
                const registrationDiv = document.createElement('div');
                registrationDiv.className = 'selected-registration-item';
                registrationDiv.innerHTML = `
                    <div class="registration-info">
                        <div class="registration-text">${sectionESelectedRegistration}</div>
                    </div>
                    <button type="button" class="remove-registration-btn" onclick="removeSelectedRegistration()">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                selectedRegistrationDisplay.appendChild(registrationDiv);
            }
        }

        function removeSelectedRegistration() {
            sectionESelectedRegistration = null;
            updateSelectedRegistrationDisplay();
        }

        async function openRegistrationSelectionModal() {
            console.log('Opening registration selection modal...');
            
            if (!currentEmployeeData) {
                alert('No employee data available.');
                return;
            }
            
            // Initialize temporary selection with currently selected registration
            tempSelectedRegistration = sectionESelectedRegistration;
            
            // Set employee name in modal
            const employeeNameElement = document.getElementById('employeeNameInRegModal');
            if (employeeNameElement) {
                employeeNameElement.textContent = currentEmployeeData.employee_name || 'this employee';
            }
            
            // Show modal first
            const modal = document.getElementById('registrationSelectionModal');
            if (modal) {
                modal.style.display = 'block';
                console.log('Registration modal displayed');
            } else {
                console.error('Registration selection modal not found!');
                return;
            }
            
            // Then populate available registrations
            await populateAvailableRegistrations();
        }

        function closeRegistrationSelectionModal() {
            document.getElementById('registrationSelectionModal').style.display = 'none';
            tempSelectedRegistration = null;
        }

        async function populateAvailableRegistrations() {
            console.log('Populating available registrations...');
            
            const registrationGrid = document.getElementById('availableRegistrationGrid');
            
            if (!registrationGrid) {
                console.error('Registration grid not found');
                return;
            }
            
            registrationGrid.innerHTML = '<div style="text-align: center; padding: 20px;"><i class="fas fa-spinner fa-spin"></i> Loading registrations...</div>';
            
            let availableRegistrations = [];
            
            try {
                if (!isDemoMode && currentEmployeeData.employee_id) {
                    // Load actual registrations from professional_qualifications table
                    console.log('Loading registrations for employee:', currentEmployeeData.employee_name);
                    const { data: qualifications, error } = await supabase
                        .from('professional_qualifications')
                        .select('current_professional_registration')
                        .eq('employee_id', currentEmployeeData.employee_id)
                        .not('current_professional_registration', 'is', null);
                    
                    if (!error && qualifications) {
                        // Extract unique registrations
                        const uniqueRegistrations = [...new Set(
                            qualifications
                                .map(q => q.current_professional_registration)
                                .filter(reg => reg && reg.trim())
                        )];
                        
                        availableRegistrations = uniqueRegistrations;
                        console.log('Loaded registrations from database:', availableRegistrations);
                    } else if (error) {
                        console.error('Error loading registrations:', error);
                    }
                } else {
                    // Demo mode - use sample data
                    availableRegistrations = [
                        'Professional Engineer (PE)',
                        'Registered Architect (RA)',
                        'LEED Accredited Professional'
                    ];
                }
            } catch (dbError) {
                console.error('Database error loading registrations:', dbError);
                // Fallback to empty array
                availableRegistrations = [];
            }
            
            // Populate registrations
            registrationGrid.innerHTML = '';
            
            if (availableRegistrations.length === 0) {
                registrationGrid.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #6b7280;">
                        <i class="fas fa-id-badge" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                        <p>No existing registrations found for this employee.</p>
                        <p style="font-size: 0.875rem; margin-top: 10px;">
                            Use the custom input below to add a registration.
                        </p>
                    </div>
                `;
                return;
            }
            
            availableRegistrations.forEach((registration, index) => {
                const registrationId = `reg_${index}`;
                const isSelected = tempSelectedRegistration === registration;
                
                const optionDiv = document.createElement('div');
                optionDiv.className = `qualification-option ${isSelected ? 'selected' : ''}`;
                optionDiv.onclick = () => selectRegistration(registration);
                
                optionDiv.innerHTML = `
                    <input type="radio" name="registration" class="qualification-checkbox" ${isSelected ? 'checked' : ''}>
                    <div class="qualification-label">${registration}</div>
                `;
                
                registrationGrid.appendChild(optionDiv);
            });
        }

        async function selectRegistration(registration) {
            tempSelectedRegistration = registration;
            // Update visual selection
            await populateAvailableRegistrations();
        }

        async function addCustomRegistrationFromModal() {
            const input = document.getElementById('customRegistrationModalInput');
            const text = input.value.trim();
            
            if (!text) {
                alert('Please enter a registration.');
                return;
            }
            
            tempSelectedRegistration = text;
            input.value = '';
            await populateAvailableRegistrations();
        }

        function saveSelectedRegistration() {
            // Save selected registration
            sectionESelectedRegistration = tempSelectedRegistration;
            tempSelectedRegistration = null;
            
            updateSelectedRegistrationDisplay();
            closeRegistrationSelectionModal();
        }

        async function loadAvailableTemplates() {
            try {
                const response = await fetch('/api/templates');
                if (response.ok) {
                    const data = await response.json();
                    availableTemplates = data.templates || [];
                    renderTemplateSelection();
                } else {
                    throw new Error('Failed to load templates');
                }
            } catch (error) {
                console.error('Error loading templates:', error);
                renderTemplateSelectionError();
            }
        }

        function renderTemplateSelection() {
            const container = document.getElementById('templateSelectionContainer');
            
            if (availableTemplates.length === 0) {
                container.innerHTML = `
                    <div class="template-error">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>No templates available</p>
                    </div>
                `;
                return;
            }

            const templateGrid = document.createElement('div');
            templateGrid.className = 'template-grid';

            availableTemplates.forEach(template => {
                const templateCard = document.createElement('div');
                const isDocxType = template.type === 'docx' || template.type === 'jinja_docx';
                templateCard.className = `template-card ${template.is_default ? 'selected' : ''} ${isDocxType ? 'docx-template' : ''}`;
                templateCard.onclick = () => selectTemplate(template.id);

                const typeIcon = isDocxType ? 'fa-file-word' : 'fa-file-pdf';
                const typeLabel = template.type === 'jinja_docx' ? 'JINJA' : (template.type === 'docx' ? 'DOCX' : 'PDF');
                const typeClass = isDocxType ? 'docx' : 'pdf';

                templateCard.innerHTML = `
                    <div class="template-preview" id="preview-${template.id}">
                        <div class="template-preview-placeholder">
                            <i class="fas ${typeIcon}"></i>
                            <div>Loading preview...</div>
                        </div>
                    </div>
                    <div class="template-info">
                        <div class="template-header">
                            <div class="template-name">
                                ${template.name}
                                ${template.is_default ? '<span class="template-default-badge">Default</span>' : ''}
                            </div>
                            <span class="template-type-badge ${typeClass}">
                                <i class="fas ${typeIcon}"></i> ${typeLabel}
                            </span>
                        </div>
                        <div class="template-description">${template.description}</div>
                        ${template.type === 'docx' ? '<div class="docx-features"><i class="fas fa-check"></i> Line breaks <i class="fas fa-check"></i> Text wrapping <i class="fas fa-check"></i> Better formatting</div>' : ''}
                        ${template.type === 'jinja_docx' ? '<div class="docx-features"><i class="fas fa-check"></i> Dynamic variables <i class="fas fa-check"></i> Flexible layout <i class="fas fa-check"></i> Case insensitive</div>' : ''}
                    </div>
                `;

                templateGrid.appendChild(templateCard);

                // Load preview image
                loadTemplatePreview(template.id);
            });

            container.innerHTML = '';
            container.appendChild(templateGrid);

            // Set default selection
            const defaultTemplate = availableTemplates.find(t => t.is_default);
            if (defaultTemplate) {
                document.getElementById('selectedTemplateId').value = defaultTemplate.id;
            }
        }

        function renderTemplateSelectionError() {
            const container = document.getElementById('templateSelectionContainer');
            container.innerHTML = `
                <div class="template-error">
                    <i class="fas fa-exclamation-triangle"></i>
                    <p>Error loading templates. Using default template.</p>
                </div>
            `;
        }

        async function loadTemplatePreview(templateId) {
            try {
                const response = await fetch(`/api/template-preview/${templateId}`);
                const previewElement = document.getElementById(`preview-${templateId}`);
                
                if (response.ok && response.headers.get('content-type')?.includes('image')) {
                    // Image preview available
                    const blob = await response.blob();
                    const imageUrl = URL.createObjectURL(blob);
                    
                    previewElement.innerHTML = `<img src="${imageUrl}" alt="Template Preview">`;
                } else {
                    // No image preview, show placeholder based on template type
                    const template = availableTemplates.find(t => t.id === templateId);
                    const isDocx = template?.type === 'docx' || template?.type === 'jinja_docx';
                    const isJinja = template?.type === 'jinja_docx';
                    
                    previewElement.innerHTML = `
                        <div class="template-preview-placeholder">
                            <i class="fas fa-file-${isDocx ? 'word' : 'pdf'}"></i>
                            <div>${isJinja ? 'Jinja Template' : (isDocx ? 'DOCX Template' : 'PDF Template')}</div>
                            ${isJinja ? '<small style="color: #2563eb;">Dynamic Variables</small>' : (isDocx ? '<small style="color: #2563eb;">Advanced Formatting</small>' : '')}
                        </div>
                    `;
                }
            } catch (error) {
                console.error(`Error loading preview for template ${templateId}:`, error);
                const previewElement = document.getElementById(`preview-${templateId}`);
                const template = availableTemplates.find(t => t.id === templateId);
                const isDocx = template?.type === 'docx' || template?.type === 'jinja_docx';
                previewElement.innerHTML = `
                    <div class="template-preview-placeholder">
                        <i class="fas fa-file-${isDocx ? 'word' : 'pdf'}"></i>
                        <div>Preview not available</div>
                    </div>
                `;
            }
        }

        function selectTemplate(templateId) {
            // Update visual selection
            document.querySelectorAll('.template-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
            
            // Update hidden input
            document.getElementById('selectedTemplateId').value = templateId;
            
            console.log('Selected template:', templateId);
        }

        function generateSectionEResume() {
            // Get role and firm values from the appropriate fields
            const roleSelect = document.getElementById('sectionE_roleInContract');
            const roleInput = document.getElementById('sectionE_roleInContract_input');
            const firmSelect = document.getElementById('sectionE_firmName');
            const firmInput = document.getElementById('sectionE_firmName_input');
            
            const roleInContract = (roleSelect.style.display !== 'none' ? roleSelect.value : roleInput.value).trim();
            const firmName = (firmSelect.style.display !== 'none' ? firmSelect.value : firmInput.value).trim();
            const location = document.getElementById('sectionE_location').value.trim();
            
            // Get registration and qualifications from separate selections
            const registration = sectionESelectedRegistration || '';
            const qualifications = sectionESelectedQualifications
                .map(q => q.text)
                .join(', ');

            if (!roleInContract || !firmName || !location) {
                alert('Please fill in all required fields (Role in Contract, Firm Name, and Location)');
                return;
            }

            if (sectionESelectedProjects.length === 0) {
                alert('Please add at least one project to the resume');
                return;
            }

            // Get selected template
            const selectedTemplateId = document.getElementById('selectedTemplateId').value;

            // Collect all form data
            const resumeData = {
                templateId: selectedTemplateId, // Include template selection
                personalInfo: {
                    name: document.getElementById('sectionE_employeeName').value,
                    totalExperience: document.getElementById('sectionE_totalExperience').value,
                    roleInContract: roleInContract,
                    firmName: firmName,
                    location: location
                },
                education: document.getElementById('sectionE_education').value,
                registration: registration,
                qualifications: qualifications,
                projects: sectionESelectedProjects.filter(p => p.title && p.title.trim()) // Only include projects with titles
            };

            // Generate and download the resume
            generatePDFResume(resumeData);
        }

        async function generatePDFResume(resumeData) {
            try {
                showSuccessMessage('Generating Section E Resume...');
                
                // Determine the endpoint based on template type
                let endpoint = '/api/generate-custom-pdf';
                if (resumeData.templateId) {
                    const selectedTemplate = availableTemplates.find(t => t.id === resumeData.templateId);
                    if (selectedTemplate?.type === 'docx' || selectedTemplate?.type === 'jinja_docx') {
                        endpoint = '/api/generate-custom-docx-with-template';
                    } else {
                        endpoint = '/api/generate-custom-pdf-with-template';
                    }
                }
                
                // Send the complete customized resume data to the backend
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(resumeData)
                });
                
                console.log('Sending customized resume data to backend...');
                console.log('Projects included:', resumeData.projects.length);
                console.log('Full resume data:', JSON.stringify(resumeData, null, 2));
                console.log('Project checkbox data:', resumeData.projects.map(p => ({
                    title: p.title,
                    performedWithSameFirm: p.performedWithSameFirm
                })));
                console.log('Project year data:', resumeData.projects.map(p => ({
                    title: p.title,
                    professionalServicesYear: p.professionalServicesYear,
                    constructionYear: p.constructionYear
                })));
                
                if (!response.ok) {
                    const errorText = await response.text();
                    let errorMessage;
                    try {
                        const errorJson = JSON.parse(errorText);
                        errorMessage = errorJson.error || errorJson.message || 'Unknown error occurred';
                    } catch {
                        errorMessage = errorText || `HTTP ${response.status}: ${response.statusText}`;
                    }
                    throw new Error(errorMessage);
                }
                
                // Check if response is PDF or DOCX
                const contentType = response.headers.get('content-type');
                const selectedTemplate = availableTemplates.find(t => t.id === resumeData.templateId);
                const isDocx = selectedTemplate?.type === 'docx' || selectedTemplate?.type === 'jinja_docx';
                
                if (contentType && (contentType.includes('application/pdf') || contentType.includes('application/vnd.openxmlformats-officedocument.wordprocessingml.document'))) {
                    // Get document blob and create preview
                    const docBlob = await response.blob();
                    const docUrl = window.URL.createObjectURL(docBlob);
                    
                    // Include template name in filename if template was selected
                    let filename = `SectionE_${resumeData.personalInfo.name.replace(/[^a-zA-Z0-9]/g, '_')}`;
                    if (resumeData.templateId && resumeData.templateId !== 'default') {
                        if (selectedTemplate) {
                            filename += `_${selectedTemplate.name.replace(/[^a-zA-Z0-9]/g, '_')}`;
                        }
                    }
                    filename += isDocx ? '.docx' : '.pdf';
                    
                    // Open in new tab for preview instead of direct download
                    const newWindow = window.open(docUrl, '_blank');
                    if (newWindow) {
                        // Set the document title in the new window
                        newWindow.document.title = filename;
                        
                        // For PDFs, the browser will show built-in PDF viewer with download option
                        // For DOCX files, provide a download option since browsers can't preview them
                        if (isDocx) {
                            // For DOCX, create a simple page with download option
                            setTimeout(() => {
                                newWindow.document.body.innerHTML = `
                                    <div style="font-family: Arial, sans-serif; padding: 40px; text-align: center;">
                                        <h2>Section E Resume Generated</h2>
                                        <p>Your DOCX file has been generated successfully.</p>
                                        <p><strong>Filename:</strong> ${filename}</p>
                                        <br>
                                        <a href="${docUrl}" download="${filename}" 
                                           style="background: #4CAF50; color: white; padding: 12px 24px; text-decoration: none; border-radius: 4px; font-size: 16px;">
                                            <i class="fas fa-download"></i> Download DOCX File
                                        </a>
                                        <br><br>
                                        <p style="color: #666; font-size: 14px;">You can also right-click the download button and select "Save link as..."</p>
                                    </div>
                                `;
                            }, 100);
                        }
                    } else {
                        // Fallback: direct download if popup blocked
                        const downloadLink = document.createElement('a');
                        downloadLink.href = docUrl;
                        downloadLink.download = filename;
                        document.body.appendChild(downloadLink);
                        downloadLink.click();
                        document.body.removeChild(downloadLink);
                    }
                    
                    // Show success message with template info
                    const templateInfo = selectedTemplate ? ` using ${selectedTemplate.name}` : '';
                    const fileType = isDocx ? 'DOCX' : 'PDF';
                    const previewText = isDocx ? 'generated and opened for download' : 'generated and opened for preview';
                    showSuccessMessage(`Section E Resume (${fileType}) ${previewText} successfully${templateInfo}!`);
                    
                    // Note: Don't clean up the blob URL immediately as the new tab needs it
                    // It will be cleaned up when the tab is closed
                } else {
                    // Handle text response (fallback case)
                    const responseText = await response.text();
                    console.log('PDF generation response:', responseText);
                    showSuccessMessage('PDF generation attempted. Check console for details.');
                }
                
                closeSectionEModal();
                
            } catch (error) {
                console.error('Error generating PDF:', error);
                alert(`Failed to generate PDF: ${error.message}`);
            }
        }

        // Fill HTML template with resume data
        function fillHTMLTemplate(templateHTML, resumeData) {
            const { personalInfo, education, registration, qualifications, projects } = resumeData;
            
            let filledHTML = templateHTML;
            
            // Insert content after specific div patterns in the PDF2HTML structure
            const insertAfterDiv = (labelPattern, content, style = '') => {
                const divPattern = new RegExp(`(<div[^>]*>.*?${labelPattern}.*?</div>)`, 'gi');
                const matches = [...filledHTML.matchAll(divPattern)];
                
                if (matches.length > 0) {
                    matches.forEach(match => {
                        const insertion = `${match[1]}<div style="position: absolute; left: ${getLeftPosition(labelPattern)}px; top: ${getTopPosition(match[0])}px; font-size: 8pt; ${style}">${content}</div>`;
                        filledHTML = filledHTML.replace(match[0], insertion);
                    });
                    return true;
                }
                return false;
            };
            
            // Helper function to determine left position based on field type
            const getLeftPosition = (pattern) => {
                if (pattern.includes('13\\. ROLE')) return 500; // Role field starts after name field
                if (pattern.includes('a\\. TOTAL')) return 750; // Experience total
                if (pattern.includes('b\\. WITH CURRENT FIRM')) return 780; // Experience with firm
                return 50; // Default left margin for most fields
            };
            
            // Helper function to calculate top position (adding some spacing below the label)
            const getTopPosition = (divContent) => {
                // Extract the y-position class and add offset
                const yMatch = divContent.match(/y([0-9a-f]+)/);
                if (yMatch) {
                    // Add approximately 20px below the label
                    return `calc(var(--y${yMatch[1]}) + 20px)`;
                }
                return '20px'; // Fallback
            };
            
            // Simpler approach: Insert content immediately after the label divs
            const insertAfterLabel = (labelText, content, offsetLeft = 0, offsetTop = 20) => {
                const pattern = new RegExp(`(<div[^>]*>.*?${labelText}.*?</div>)`, 'gi');
                let replaced = false;
                filledHTML = filledHTML.replace(pattern, (match, group1) => {
                    if (!replaced) {
                        replaced = true;
                        return `${group1}
                        <div style="position: absolute; margin-left: ${offsetLeft}px; margin-top: ${offsetTop}px; font-size: 9pt; font-weight: normal; color: #000; background: rgba(255,255,255,0.8); padding: 2px;">${content}</div>`;
                    }
                    return match;
                });
                return replaced;
            };
            
            // Fill personal information fields
            insertAfterLabel('12\\. NAME', personalInfo.name || '', 0, 25);
            insertAfterLabel('13\\. ROLE IN THIS CONTRACT', personalInfo.roleInContract || '', 0, 25);
            insertAfterLabel('a\\. TOTAL', personalInfo.totalExperience || '', 10, 25);
            insertAfterLabel('b\\. WITH CURRENT FIRM', personalInfo.totalExperience || '', 10, 25);
            insertAfterLabel('15\\. FIRM NAME AND LOCATION', `${personalInfo.firmName || ''}, ${personalInfo.location || ''}`, 0, 25);
            insertAfterLabel('16\\. EDUCATION', education || '', 0, 25);
            insertAfterLabel('17\\. CURRENT PROFESSIONAL REGISTRATION', registration || '', 0, 25);
            insertAfterLabel('18\\. OTHER PROFESSIONAL QUALIFICATIONS', qualifications || '', 0, 25);
            
            // Fill project information
            projects.forEach((project, index) => {
                if (!project) return;
                
                const letter = String.fromCharCode(97 + index); // a, b, c, d, e
                
                // Project title
                insertAfterLabel(`${letter}\\.[\\s\\S]*?\\(1\\) TITLE AND LOCATION`, project.title || '', 0, 25);
                
                // Project year - match PROFESSIONAL SERVICES by index
                const yearPattern = 'PROFESSIONAL SERVICES';
                const yearMatches = filledHTML.match(new RegExp(`(<div[^>]*>.*?${yearPattern}.*?</div>)`, 'g'));
                if (yearMatches && yearMatches[index]) {
                    const specificYearDiv = yearMatches[index];
                    filledHTML = filledHTML.replace(specificYearDiv, 
                        `${specificYearDiv}
                        <div style="position: absolute; margin-left: 10px; margin-top: 25px; font-size: 9pt; text-align: center; color: #000; background: rgba(255,255,255,0.8); padding: 2px;">${project.year || ''}</div>`
                    );
                }
                
                // Project description
                let descriptionText = '';
                if (project.role) {
                    descriptionText += `<strong>Role:</strong> ${project.role}<br/>`;
                }
                if (project.description) {
                    descriptionText += project.description;
                }
                
                if (descriptionText) {
                    const descPattern = '\\(3\\) BRIEF DESCRIPTION[\\s\\S]*?AND SPECIFIC ROLE';
                    const descMatches = filledHTML.match(new RegExp(`(<div[^>]*>.*?${descPattern}.*?</div>)`, 'g'));
                    if (descMatches && descMatches[index]) {
                        const specificDescDiv = descMatches[index];
                        filledHTML = filledHTML.replace(specificDescDiv, 
                            `${specificDescDiv}
                            <div style="position: absolute; margin-left: 0px; margin-top: 25px; font-size: 8pt; color: #000; background: rgba(255,255,255,0.8); padding: 2px; max-width: 400px;">${descriptionText}</div>`
                        );
                    }
                }
            });
            
            console.log('Template filled successfully');
            return filledHTML;
        }

        // Generate PDF from filled HTML
        function generatePDFFromHTML(filledHTML, employeeName) {
            // Create a new window with the filled HTML
            const printWindow = window.open('', '_blank', 'width=800,height=600');
            
            // Add print-specific styles to force single page
            const printHTML = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Section E Resume - ${employeeName}</title>
                    <style>
                        @page { 
                            margin: 0.3in; 
                            size: letter;
                        }
                        @media print {
                            body { 
                                margin: 0;
                                padding: 0;
                                -webkit-print-color-adjust: exact;
                                color-adjust: exact;
                                transform: scale(0.85); /* Scale down to fit better */
                                transform-origin: top left;
                                width: 118%; /* Compensate for scaling */
                            }
                            table {
                                page-break-inside: avoid !important;
                                break-inside: avoid !important;
                            }
                            tr {
                                page-break-inside: avoid !important;
                                break-inside: avoid !important;
                            }
                            td {
                                page-break-inside: avoid !important;
                                break-inside: avoid !important;
                            }
                        }
                        body {
                            font-family: Arial, sans-serif;
                            font-size: 7pt; /* Reduced font size */
                            line-height: 1.1; /* Tighter line height */
                            margin: 0;
                            padding: 0;
                        }
                        table {
                            border-collapse: collapse;
                            width: 100%;
                            table-layout: fixed; /* Fixed layout for better control */
                        }
                        td, th {
                            border: 1px solid black;
                            padding: 1pt; /* Reduced padding */
                            vertical-align: top;
                            overflow: hidden; /* Prevent overflow */
                        }
                        h2 {
                            font-size: 8pt; /* Reduced header size */
                            margin: 2pt 0;
                        }
                        h1 {
                            font-size: 8pt; /* Reduced footer size */
                            margin: 2pt 0;
                        }
                        p {
                            margin: 1pt 0; /* Reduced margins */
                            font-size: 6pt; /* Smaller paragraph text */
                        }
                        .s1, .s2, .s3, .s4, .s5, .s7, .s8 {
                            font-size: 6pt !important; /* Override all font sizes */
                            line-height: 1.1 !important;
                        }
                        div {
                            font-size: 6pt !important;
                            line-height: 1.1 !important;
                            padding: 1pt !important;
                            margin: 0 !important;
                            max-height: none !important; /* Remove height restrictions */
                            overflow: hidden !important;
                        }
                        ol, li {
                            margin: 1pt 0 !important;
                            padding: 1pt !important;
                            font-size: 6pt !important;
                        }
                        .print-instructions {
                            position: fixed;
                            top: 10px;
                            right: 10px;
                            background: #f0f0f0;
                            border: 1px solid #ccc;
                            padding: 10px;
                            border-radius: 5px;
                            font-family: Arial, sans-serif;
                            font-size: 12px;
                            z-index: 1000;
                        }
                        @media print {
                            .print-instructions {
                                display: none;
                            }
                        }
                        /* Force table rows to specific heights */
                        tr {
                            height: auto !important;
                        }
                        /* Specific adjustments for project rows */
                        tr[style*="height:58pt"], tr[style*="height:59pt"] {
                            height: 40pt !important; /* Reduce project description row height */
                        }
                        tr[style*="height:23pt"] {
                            height: 18pt !important; /* Reduce header row height */
                        }
                        tr[style*="height:12pt"], tr[style*="height:11pt"] {
                            height: 8pt !important; /* Reduce small row height */
                        }
                    </style>
                </head>
                <body>
                    <div class="print-instructions">
                        <strong>Instructions:</strong><br/>
                        1. Press Ctrl+P (Cmd+P on Mac)<br/>
                        2. Choose "Save as PDF"<br/>
                        3. Click Save<br/>
                        <em>(Content scaled to fit one page)</em>
                    </div>
                    ${filledHTML.replace(/<html[^>]*>[\s\S]*?<body[^>]*>/i, '').replace(/<\/body>[\s\S]*?<\/html>/i, '')}
                </body>
                </html>
            `;
            
            printWindow.document.write(printHTML);
            printWindow.document.close();
            
            // Auto-trigger print dialog after a short delay
            setTimeout(() => {
                printWindow.focus();
                printWindow.print();
            }, 1000);
        }

        // Helper function to wrap text to fit within specified character limit
        function wrapText(text, maxCharsPerLine) {
            const words = text.split(' ');
            const lines = [];
            let currentLine = '';
            
            words.forEach(word => {
                if ((currentLine + word).length <= maxCharsPerLine) {
                    currentLine += (currentLine ? ' ' : '') + word;
                } else {
                    if (currentLine) {
                        lines.push(currentLine);
                        currentLine = word;
                    } else {
                        // Word is longer than maxCharsPerLine, split it
                        lines.push(word.substring(0, maxCharsPerLine));
                        currentLine = word.substring(maxCharsPerLine);
                    }
                }
            });
            
            if (currentLine) {
                lines.push(currentLine);
            }
            
            return lines;
        }



        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('sectionEModal');
            if (event.target === modal) {
                closeSectionEModal();
            }
        }

        // Solicitation Analysis Functions
        let extractedKeywords = [];
        let selectedKeywords = [];
        let suggestedProjects = [];
        let selectedSuggestedProjects = [];

        function openSolicitationAnalysisModal() {
            if (sectionESelectedProjects.length >= 5) {
                alert('You can only select up to 5 projects.');
                return;
            }
            
            if (!currentEmployeeData) {
                alert('No employee data available.');
                return;
            }

            // Reset modal state
            resetSolicitationModal();
            
            // Show modal
            document.getElementById('solicitationAnalysisModal').style.display = 'block';
        }

        function closeSolicitationAnalysisModal() {
            document.getElementById('solicitationAnalysisModal').style.display = 'none';
            resetSolicitationModal();
        }

        function resetSolicitationModal() {
            // Reset all sections
            document.getElementById('uploadSection').style.display = 'block';
            document.getElementById('analysisProgress').style.display = 'none';
            document.getElementById('keywordsSection').style.display = 'none';
            document.getElementById('suggestedProjectsSection').style.display = 'none';
            document.getElementById('addSuggestedBtn').style.display = 'none';
            
            // Reset data
            extractedKeywords = [];
            selectedKeywords = [];
            suggestedProjects = [];
            selectedSuggestedProjects = [];
            customKeywords = [];
            
            // Reset custom keyword input
            document.getElementById('customKeywordInput').value = '';
            document.getElementById('customKeywordCategory').value = 'skill';
            displayCustomKeywords();
            
            // Reset file input
            document.getElementById('solicitationFileInput').value = '';
            
            // Reset upload area
            const uploadArea = document.getElementById('uploadArea');
            uploadArea.classList.remove('drag-over');
        }

        // File upload handling
        function handleFileUpload(file) {
            if (!file) return;
            
            if (file.type !== 'application/pdf') {
                alert('Please upload a PDF file.');
                return;
            }
            
            if (file.size > 10 * 1024 * 1024) { // 10MB limit
                alert('File size must be less than 10MB.');
                return;
            }
            
            analyzeSolicitationPDF(file);
        }

        // Drag and drop functionality
        function setupDragAndDrop() {
            const uploadArea = document.getElementById('uploadArea');
            
            if (!uploadArea) return; // Guard against missing element
            
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('drag-over');
            });
            
            uploadArea.addEventListener('dragleave', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('drag-over');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('drag-over');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileUpload(files[0]);
                }
            });
        }

        async function analyzeSolicitationPDF(file) {
            // Show analysis progress
            document.getElementById('uploadSection').style.display = 'none';
            document.getElementById('analysisProgress').style.display = 'block';
            
            try {
                // Create FormData to send file
                const formData = new FormData();
                formData.append('pdf_file', file);
                
                // Make API call to analyze PDF
                const response = await fetch('/api/analyze-solicitation', {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                
                if (result.error) {
                    throw new Error(result.error);
                }
                
                // Process extracted keywords
                extractedKeywords = result.keywords || [];
                
                if (extractedKeywords.length === 0) {
                    throw new Error('No keywords extracted from the document');
                }
                
                // Show keywords section
                displayExtractedKeywords();
                
            } catch (error) {
                console.error('Error analyzing PDF:', error);
                
                // Parse error response for better user feedback
                let errorMessage = error.message;
                let suggestion = '';
                
                if (error.message.includes('Document too large')) {
                    errorMessage = 'Document Too Large for Analysis';
                    suggestion = '\n\nSuggestion: Try uploading a smaller document (under 50 pages) or just the technical requirements section.';
                } else if (error.message.includes('OpenAI API configuration')) {
                    errorMessage = 'API Configuration Issue';
                    suggestion = '\n\nPlease check your OpenAI API key in the .env file.';
                }
                
                alert(`${errorMessage}${suggestion}`);
                
                // Reset to upload section
                document.getElementById('analysisProgress').style.display = 'none';
                document.getElementById('uploadSection').style.display = 'block';
            }
        }

        function displayExtractedKeywords() {
            // Hide progress, show keywords section
            document.getElementById('analysisProgress').style.display = 'none';
            document.getElementById('keywordsSection').style.display = 'block';
            
            // Reset custom keywords for new analysis
            customKeywords = [];
            displayCustomKeywords();
            
            // Use the refresh function to display all keywords
            refreshKeywordsDisplay();
            
            // Reset selected keywords
            selectedKeywords = [];
            updateFindProjectsButton();
        }

        function toggleKeyword(index) {
            const keywordItem = document.querySelectorAll('.keyword-item')[index];
            const checkbox = document.getElementById(`keyword_${index}`);
            const keyword = extractedKeywords[index];
            
            if (selectedKeywords.includes(keyword)) {
                // Remove from selection
                selectedKeywords = selectedKeywords.filter(k => k !== keyword);
                keywordItem.classList.remove('selected');
                checkbox.checked = false;
            } else {
                // Add to selection
                selectedKeywords.push(keyword);
                keywordItem.classList.add('selected');
                checkbox.checked = true;
            }
            
            updateFindProjectsButton();
        }

        function updateFindProjectsButton() {
            const findBtn = document.getElementById('findProjectsBtn');
            findBtn.disabled = selectedKeywords.length === 0;
        }

        async function findMatchingProjects() {
            if (selectedKeywords.length === 0) {
                alert('Please select at least one keyword.');
                return;
            }
            
            try {
                // Get available projects for this employee
                await loadAvailableProjects();
                
                // Calculate similarity scores
                suggestedProjects = calculateProjectMatches();
                
                // Display suggested projects
                displaySuggestedProjects();
                
            } catch (error) {
                console.error('Error finding matching projects:', error);
                alert(`Failed to find matching projects: ${error.message}`);
            }
        }

        function calculateProjectMatches() {
            const matches = [];
            
            // Get keywords as lowercase strings for matching
            const searchKeywords = selectedKeywords.map(k => k.text.toLowerCase());
            
            sectionEAvailableProjects.forEach(project => {
                const matchScore = calculateSimilarity(project, searchKeywords);
                
                if (matchScore.score > 0) {
                    matches.push({
                        ...project,
                        matchScore: matchScore.score,
                        matchedKeywords: matchScore.matchedKeywords
                    });
                }
            });
            
            // Sort by match score (highest first) and take top 5
            return matches
                .sort((a, b) => b.matchScore - a.matchScore)
                .slice(0, 5);
        }

        function calculateSimilarity(project, searchKeywords) {
            const projectText = `
                ${project.title || ''} 
                ${project.description || ''} 
                ${project.role || ''} 
                ${project.firm || ''}
            `.toLowerCase();
            
            let score = 0;
            const matchedKeywords = [];
            
            searchKeywords.forEach(keyword => {
                const keywordWords = keyword.split(/\s+/);
                let keywordScore = 0;
                
                keywordWords.forEach(word => {
                    if (word.length > 2 && projectText.includes(word)) {
                        keywordScore += 1;
                    }
                });
                
                // If any part of the keyword matches, add to score
                if (keywordScore > 0) {
                    score += keywordScore;
                    matchedKeywords.push(keyword);
                }
            });
            
            // Normalize score (percentage of keywords that matched)
            const normalizedScore = Math.min(100, (score / searchKeywords.length) * 50);
            
            return {
                score: Math.round(normalizedScore),
                matchedKeywords: matchedKeywords
            };
        }

        function displaySuggestedProjects() {
            // Show suggested projects section
            document.getElementById('suggestedProjectsSection').style.display = 'block';
            document.getElementById('addSuggestedBtn').style.display = 'inline-flex';
            
            const suggestedList = document.getElementById('suggestedProjectsList');
            suggestedList.innerHTML = '';
            
            if (suggestedProjects.length === 0) {
                suggestedList.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #6b7280;">
                        <i class="fas fa-search" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                        <p>No matching projects found for the selected keywords.</p>
                        <p style="font-size: 0.875rem; margin-top: 10px;">
                            Try selecting different keywords or check if this employee has relevant project experience.
                        </p>
                    </div>
                `;
                return;
            }
            
            // Reset selected suggested projects
            selectedSuggestedProjects = [];
            
            suggestedProjects.forEach((project, index) => {
                const projectDiv = document.createElement('div');
                projectDiv.className = 'suggested-project-item';
                
                projectDiv.innerHTML = `
                    <div class="suggested-project-header">
                        <div>
                            <div class="suggested-project-title">${project.title}</div>
                            <div class="suggested-project-meta">
                                <span><i class="fas fa-calendar"></i> ${project.year || 'No year'}</span>
                                <span><i class="fas fa-user-tie"></i> ${project.role || 'No role'}</span>
                                ${project.firm ? `<span><i class="fas fa-building"></i> ${project.firm}</span>` : ''}
                            </div>
                        </div>
                        <div class="match-score">${project.matchScore}% match</div>
                    </div>
                    
                    ${project.description ? `
                        <div style="margin-bottom: 8px; font-size: 0.875rem; color: #374151;">
                            ${project.description.substring(0, 150)}${project.description.length > 150 ? '...' : ''}
                        </div>
                    ` : ''}
                    
                    <div class="matched-keywords">
                        <strong>Matched keywords:</strong>
                        ${project.matchedKeywords.map(keyword => 
                            `<span class="matched-keyword-tag">${keyword}</span>`
                        ).join('')}
                    </div>
                    
                    <div style="margin-top: 12px;">
                        <button class="add-suggested-project-btn" onclick="toggleSuggestedProject(${index})" id="suggestedBtn_${index}">
                            <i class="fas fa-plus"></i> Add to Resume
                        </button>
                    </div>
                `;
                
                suggestedList.appendChild(projectDiv);
            });
        }

        function toggleSuggestedProject(index) {
            const project = suggestedProjects[index];
            const btn = document.getElementById(`suggestedBtn_${index}`);
            
            if (selectedSuggestedProjects.includes(project)) {
                // Remove from selection
                selectedSuggestedProjects = selectedSuggestedProjects.filter(p => p !== project);
                btn.innerHTML = '<i class="fas fa-plus"></i> Add to Resume';
                btn.style.background = '#059669';
            } else {
                // Check if we can add more projects
                const totalSelected = sectionESelectedProjects.length + selectedSuggestedProjects.length;
                if (totalSelected >= 5) {
                    alert('You can only select up to 5 projects total.');
                    return;
                }
                
                // Add to selection
                selectedSuggestedProjects.push(project);
                btn.innerHTML = '<i class="fas fa-check"></i> Selected';
                btn.style.background = '#059669';
            }
        }

        function addSuggestedProjects() {
            if (selectedSuggestedProjects.length === 0) {
                alert('Please select at least one project to add.');
                return;
            }
            
            // Add selected projects to the resume
            selectedSuggestedProjects.forEach(project => {
                // Create a project object in the expected format
                const resumeProject = {
                    id: project.id || `suggested_${Date.now()}_${Math.random()}`,
                    title: project.title,
                    year: project.year,
                    role: project.role,
                    description: project.description,
                    firm: project.firm,
                    isDatabase: project.isDatabase || false,
                    isSuggested: true
                };
                
                sectionESelectedProjects.push(resumeProject);
            });
            
            // Update the main Section E modal
            updateSelectedProjectsDisplay();
            updateProjectsCount();
            
            // Close solicitation modal
            closeSolicitationAnalysisModal();
            
            // Show success message
            showSuccessMessage(`Added ${selectedSuggestedProjects.length} suggested project(s) to the resume!`);
        }

        // Custom Keywords Functions
        let customKeywords = []; // Array to track custom keywords
        
        function addCustomKeyword() {
            const input = document.getElementById('customKeywordInput');
            const categorySelect = document.getElementById('customKeywordCategory');
            
            const text = input.value.trim();
            const category = categorySelect.value;
            
            if (!text) {
                alert('Please enter a keyword.');
                return;
            }
            
            // Check if keyword already exists (case insensitive)
            const existingKeyword = extractedKeywords.find(k => 
                k.text.toLowerCase() === text.toLowerCase()
            );
            
            if (existingKeyword) {
                alert('This keyword already exists in the extracted keywords list.');
                return;
            }
            
            // Create custom keyword object
            const customKeyword = {
                text: text,
                category: category,
                isCustom: true
            };
            
            // Add to extracted keywords array so it appears in the main grid
            extractedKeywords.push(customKeyword);
            customKeywords.push(customKeyword);
            
            // Clear input
            input.value = '';
            
            // Refresh the keywords display
            refreshKeywordsDisplay();
            
            // Show the custom keywords display section
            displayCustomKeywords();
        }
        
        function handleCustomKeywordEnter(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                addCustomKeyword();
            }
        }
        
        function displayCustomKeywords() {
            const customKeywordsDisplay = document.getElementById('customKeywordsDisplay');
            const customKeywordsList = document.getElementById('customKeywordsList');
            
            if (customKeywords.length > 0) {
                customKeywordsDisplay.style.display = 'block';
                
                customKeywordsList.innerHTML = '';
                customKeywords.forEach((keyword, index) => {
                    const keywordTag = document.createElement('div');
                    keywordTag.className = 'custom-keyword-tag';
                    keywordTag.style.cssText = `
                        display: inline-flex; 
                        align-items: center; 
                        gap: 0.5rem; 
                        background: #e0e7ff; 
                        color: #3730a3; 
                        padding: 0.25rem 0.5rem; 
                        border-radius: 4px; 
                        font-size: 0.75rem;
                    `;
                    
                    keywordTag.innerHTML = `
                        <span>${keyword.text} (${keyword.category})</span>
                        <button onclick="removeCustomKeyword(${index})" 
                                style="background: none; border: none; color: #3730a3; cursor: pointer; padding: 0; margin: 0; font-size: 0.75rem;">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    
                    customKeywordsList.appendChild(keywordTag);
                });
            } else {
                customKeywordsDisplay.style.display = 'none';
            }
        }
        
        function removeCustomKeyword(index) {
            const customKeyword = customKeywords[index];
            
            // Remove from extracted keywords array
            extractedKeywords = extractedKeywords.filter(k => k !== customKeyword);
            
            // Remove from selected keywords if it was selected
            selectedKeywords = selectedKeywords.filter(k => k !== customKeyword);
            
            // Remove from custom keywords array
            customKeywords.splice(index, 1);
            
            // Refresh displays
            refreshKeywordsDisplay();
            displayCustomKeywords();
            updateFindProjectsButton();
        }
        
        function refreshKeywordsDisplay() {
            // Re-render the keywords grid to include custom keywords
            const keywordsGrid = document.getElementById('keywordsGrid');
            keywordsGrid.innerHTML = '';
            
            // Create keyword items for all keywords (extracted + custom)
            extractedKeywords.forEach((keyword, index) => {
                const keywordDiv = document.createElement('div');
                keywordDiv.className = 'keyword-item';
                
                // Add special styling for custom keywords
                if (keyword.isCustom) {
                    keywordDiv.style.border = '2px solid #667eea';
                    keywordDiv.style.background = '#f0f4ff';
                }
                
                keywordDiv.onclick = () => toggleKeyword(index);
                
                keywordDiv.innerHTML = `
                    <input type="checkbox" class="keyword-checkbox" id="keyword_${index}" ${selectedKeywords.includes(keyword) ? 'checked' : ''}>
                    <div class="keyword-text">${keyword.text}${keyword.isCustom ? ' (custom)' : ''}</div>
                `;
                
                // Mark as selected if it was previously selected
                if (selectedKeywords.includes(keyword)) {
                    keywordDiv.classList.add('selected');
                }
                
                keywordsGrid.appendChild(keywordDiv);
            });
        }

        // Initialize drag and drop when page loads
        document.addEventListener('DOMContentLoaded', function() {
            setupDragAndDrop();
        });

        // AI Writeup Functions
        let allProjects = [];
        let selectedAIProject = null;

        async function openAIWriteupModal() {
            if (sectionESelectedProjects.length >= 5) {
                alert('You can only select up to 5 projects.');
                return;
            }
            
            if (!currentEmployeeData) {
                alert('No employee data available.');
                return;
            }

            // Show modal first
            document.getElementById('aiWriteupModal').style.display = 'block';
            
            // Load all projects
            await loadAllProjects();
        }

        function closeAIWriteupModal() {
            document.getElementById('aiWriteupModal').style.display = 'none';
            // Reset the selected project when closing the main modal
            selectedAIProject = null;
        }

        async function loadAllProjects() {
            try {
                const response = await fetch('/api/all-projects');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                allProjects = data.projects || [];
                
                populateAllProjectsList();
            } catch (error) {
                console.error('Error loading all projects:', error);
                const allProjectsList = document.getElementById('allProjectsList');
                allProjectsList.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #ef4444;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                        <p>Failed to load projects.</p>
                        <p style="font-size: 0.875rem; margin-top: 10px;">Error: ${error.message}</p>
                    </div>
                `;
            }
        }

        function populateAllProjectsList() {
            const allProjectsList = document.getElementById('allProjectsList');
            
            if (allProjects.length === 0) {
                allProjectsList.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #6b7280;">
                        <i class="fas fa-project-diagram" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                        <p>No projects found in the database.</p>
                    </div>
                `;
                return;
            }

            allProjectsList.innerHTML = '';
            
            allProjects.forEach(project => {
                const projectDiv = document.createElement('div');
                projectDiv.className = 'available-project-item';
                projectDiv.style.cssText = `
                    border: 1px solid #e1e5e9;
                    border-radius: 8px;
                    padding: 1rem;
                    margin-bottom: 1rem;
                    cursor: pointer;
                    transition: all 0.2s ease;
                `;
                
                projectDiv.onmouseover = () => {
                    projectDiv.style.borderColor = '#667eea';
                    projectDiv.style.backgroundColor = '#f8fafc';
                };
                
                projectDiv.onmouseout = () => {
                    projectDiv.style.borderColor = '#e1e5e9';
                    projectDiv.style.backgroundColor = 'white';
                };
                
                projectDiv.onclick = () => selectProject(project);
                
                const title = project.title_and_location || 'Untitled Project';
                const scope = project.description_scope || 'No scope description available';
                const employeeName = project.employee_name || 'Unknown Employee';
                
                projectDiv.innerHTML = `
                    <div style="font-weight: 600; color: #374151; margin-bottom: 0.5rem;">
                        ${title}
                    </div>
                    <div style="color: #6b7280; font-size: 0.875rem; margin-bottom: 0.5rem;">
                        Employee: ${employeeName}
                    </div>
                    <div style="color: #4b5563; font-size: 0.875rem; line-height: 1.4;">
                        <strong>Scope:</strong> ${scope.length > 150 ? scope.substring(0, 150) + '...' : scope}
                    </div>
                `;
                
                allProjectsList.appendChild(projectDiv);
            });
        }

        function selectProject(project) {
            selectedAIProject = project;
            
            // Show project details in action modal
            const selectedProjectDetails = document.getElementById('selectedProjectDetails');
            const title = project.title_and_location || 'Untitled Project';
            const scope = project.description_scope || 'No scope description available';
            const employeeName = project.employee_name || 'Unknown Employee';
            
            selectedProjectDetails.innerHTML = `
                <div style="background: #f9fafb; padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem;">
                    <h3 style="margin: 0 0 1rem 0; color: #374151;">${title}</h3>
                    <div style="margin-bottom: 1rem;">
                        <strong>Employee:</strong> <span style="color: #6b7280;">${employeeName}</span>
                    </div>
                    <div>
                        <strong>Scope:</strong>
                        <div style="background: white; padding: 1rem; border-radius: 4px; margin-top: 0.5rem; color: #4b5563; line-height: 1.5;">
                            ${scope}
                        </div>
                    </div>
                </div>
            `;
            
            // Close first modal and show action modal (but keep selectedAIProject)
            document.getElementById('aiWriteupModal').style.display = 'none';
            document.getElementById('aiProjectActionModal').style.display = 'block';
        }

        function closeAIProjectActionModal() {
            document.getElementById('aiProjectActionModal').style.display = 'none';
            // Don't reset selectedAIProject here - keep it for the rewrite workflow
        }

        function cancelAIWorkflow() {
            // Cancel the entire AI workflow and reset everything
            document.getElementById('aiProjectActionModal').style.display = 'none';
            document.getElementById('aiRewriteModal').style.display = 'none';
            document.getElementById('aiRewriteResultsModal').style.display = 'none';
            selectedAIProject = null;
        }

        function useProjectAsIs() {
            if (!selectedAIProject) {
                alert('No project selected.');
                return;
            }
            
            // Add project to Section E resume with original scope
            const projectForResume = {
                id: selectedAIProject.project_id || `ai_selected_${Date.now()}`,
                title: selectedAIProject.title_and_location || '',
                description: selectedAIProject.description_scope || '',
                year: '',
                role: '',
                firm: '',
                cost: '',
                fee: '',
                professionalServicesYear: null,
                constructionYear: null,
                performedWithSameFirm: false,
                isAISelected: true,
                originalEmployeeName: selectedAIProject.employee_name
            };
            
            sectionESelectedProjects.push(projectForResume);
            updateSelectedProjectsDisplay();
            updateProjectsCount();
            
            closeAIProjectActionModal();
            showSuccessMessage(`Project "${selectedAIProject.title_and_location}" added to Section E resume!`);
            selectedAIProject = null; // Reset after use
        }

        function openAIRewriteModal() {
            if (!selectedAIProject) {
                alert('No project selected.');
                return;
            }
            
            // Pre-populate current employee name
            document.getElementById('aiRewritePersonName').value = currentEmployeeData.employee_name || '';
            
            // Close action modal and show rewrite modal
            closeAIProjectActionModal();
            document.getElementById('aiRewriteModal').style.display = 'block';
        }

        function closeAIRewriteModal() {
            document.getElementById('aiRewriteModal').style.display = 'none';
            // Clear form
            document.getElementById('aiRewriteRole').value = '';
            document.getElementById('aiRewritePersonName').value = '';
            document.getElementById('aiRewriteKeywords').value = '';
            // Don't reset selectedAIProject here - we might need it for the results
        }

        async function generateAIRewrites() {
            if (!selectedAIProject) {
                alert('No project selected.');
                return;
            }
            
            const role = document.getElementById('aiRewriteRole').value.trim();
            const personName = document.getElementById('aiRewritePersonName').value.trim();
            const keywords = document.getElementById('aiRewriteKeywords').value.trim();
            
            if (!role && !personName && !keywords) {
                alert('Please enter at least one keyword or role.');
                return;
            }
            
            const keywordsList = [role, personName, keywords].filter(k => k).join(', ');
            
            try {
                // Show loading
                showSuccessMessage('Generating AI rewrites...');
                
                const response = await fetch('/api/ai-rewrite', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        original_scope: selectedAIProject.description_scope,
                        keywords: keywordsList
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                // Display the 3 rewritten versions
                displayAIRewriteResults(data.rewritten_versions || []);
                
            } catch (error) {
                console.error('Error generating AI rewrites:', error);
                alert(`Failed to generate AI rewrites: ${error.message}`);
            }
        }

        function displayAIRewriteResults(versions) {
            const rewriteResults = document.getElementById('rewriteResults');
            
            if (!versions || versions.length === 0) {
                rewriteResults.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #ef4444;">
                        <p>No rewrite versions were generated.</p>
                    </div>
                `;
                closeAIRewriteModal();
                document.getElementById('aiRewriteResultsModal').style.display = 'block';
                return;
            }
            
            rewriteResults.innerHTML = '';
            
            versions.forEach((version, index) => {
                const versionDiv = document.createElement('div');
                versionDiv.style.cssText = `
                    border: 1px solid #e1e5e9;
                    border-radius: 8px;
                    padding: 1.5rem;
                    margin-bottom: 1rem;
                    cursor: pointer;
                    transition: all 0.2s ease;
                `;
                
                versionDiv.onmouseover = () => {
                    versionDiv.style.borderColor = '#667eea';
                    versionDiv.style.backgroundColor = '#f8fafc';
                };
                
                versionDiv.onmouseout = () => {
                    versionDiv.style.borderColor = '#e1e5e9';
                    versionDiv.style.backgroundColor = 'white';
                };
                
                versionDiv.onclick = () => selectAIRewriteVersion(version);
                
                versionDiv.innerHTML = `
                    <div style="font-weight: 600; color: #374151; margin-bottom: 1rem;">
                        Version ${index + 1}
                    </div>
                    <div style="background: #f9fafb; padding: 1rem; border-radius: 4px; color: #4b5563; line-height: 1.5;">
                        ${version}
                    </div>
                    <div style="text-align: center; margin-top: 1rem;">
                        <button style="background: #667eea; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">
                            <i class="fas fa-check"></i> Select This Version
                        </button>
                    </div>
                `;
                
                rewriteResults.appendChild(versionDiv);
            });
            
            closeAIRewriteModal();
            document.getElementById('aiRewriteResultsModal').style.display = 'block';
        }

        function selectAIRewriteVersion(rewrittenScope) {
            if (!selectedAIProject) {
                alert('No project selected.');
                return;
            }
            
            // Add project to Section E resume with rewritten scope
            const projectForResume = {
                id: selectedAIProject.project_id || `ai_rewritten_${Date.now()}`,
                title: selectedAIProject.title_and_location || '',
                description: rewrittenScope,
                year: '',
                role: '',
                firm: '',
                cost: '',
                fee: '',
                professionalServicesYear: null,
                constructionYear: null,
                performedWithSameFirm: false,
                isAIRewritten: true,
                originalEmployeeName: selectedAIProject.employee_name,
                originalScope: selectedAIProject.description_scope
            };
            
            sectionESelectedProjects.push(projectForResume);
            updateSelectedProjectsDisplay();
            updateProjectsCount();
            
            const projectTitle = selectedAIProject.title_and_location; // Store before reset
            closeAIRewriteResultsModal();
            showSuccessMessage(`AI-rewritten project "${projectTitle}" added to Section E resume!`);
        }

        function closeAIRewriteResultsModal() {
            document.getElementById('aiRewriteResultsModal').style.display = 'none';
            selectedAIProject = null;
        }
    </script>

    <!-- AI Writeup Modal -->
    <div id="aiWriteupModal" class="modal-overlay" style="display: none;">
        <div class="project-selection-modal">
            <div class="project-selection-header">
                <h2><i class="fas fa-magic"></i> AI Writeup - Select Project</h2>
                <button class="close-modal-btn" onclick="closeAIWriteupModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="project-selection-content">
                <div class="project-selection-info">
                    <p>Select a project from across all employees to use or rewrite with AI:</p>
                </div>
                
                <div class="all-projects-list" id="allProjectsList">
                    <div style="text-align: center; padding: 20px;">
                        <i class="fas fa-spinner fa-spin"></i> Loading all projects...
                    </div>
                </div>
            </div>
            
            <div class="project-selection-footer">
                <button class="project-selection-cancel-btn" onclick="closeAIWriteupModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- AI Project Action Modal -->
    <div id="aiProjectActionModal" class="modal-overlay" style="display: none;">
        <div class="project-selection-modal">
            <div class="project-selection-header">
                <h2><i class="fas fa-cog"></i> Project Selected</h2>
                <button class="close-modal-btn" onclick="cancelAIWorkflow()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="project-selection-content">
                <div class="selected-project-details" id="selectedProjectDetails">
                    <!-- Project details will be populated here -->
                </div>
                
                <div class="ai-action-buttons" style="text-align: center; margin-top: 2rem;">
                    <button class="use-this-btn" onclick="useProjectAsIs()">
                        <i class="fas fa-check"></i> Use This
                    </button>
                    <button class="ai-rewrite-btn" onclick="openAIRewriteModal()">
                        <i class="fas fa-magic"></i> AI Rewrite
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Rewrite Keywords Modal -->
    <div id="aiRewriteModal" class="modal-overlay" style="display: none;">
        <div class="project-selection-modal">
            <div class="project-selection-header">
                <h2><i class="fas fa-edit"></i> AI Rewrite - Enter Keywords</h2>
                <button class="close-modal-btn" onclick="cancelAIWorkflow()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="project-selection-content">
                <div class="rewrite-instructions">
                    <p>Enter keywords to customize the project scope rewrite:</p>
                </div>
                
                <div class="keyword-inputs">
                    <div class="section-e-form-group">
                        <label>Role (e.g., "Project Manager")</label>
                        <input type="text" id="aiRewriteRole" placeholder="Enter role...">
                    </div>
                    <div class="section-e-form-group">
                        <label>Person's Name (e.g., "John Smith")</label>
                        <input type="text" id="aiRewritePersonName" placeholder="Enter person's name...">
                    </div>
                    <div class="section-e-form-group">
                        <label>Other Keywords (comma-separated)</label>
                        <textarea id="aiRewriteKeywords" rows="3" placeholder="Enter other relevant keywords..."></textarea>
                    </div>
                </div>
            </div>
            
            <div class="project-selection-footer">
                <button class="project-selection-cancel-btn" onclick="cancelAIWorkflow()">Cancel</button>
                <button class="ai-generate-btn" onclick="generateAIRewrites()">
                    <i class="fas fa-magic"></i> Generate Rewrites
                </button>
            </div>
        </div>
    </div>

    <!-- AI Rewrite Results Modal -->
    <div id="aiRewriteResultsModal" class="modal-overlay" style="display: none;">
        <div class="project-selection-modal" style="max-width: 1000px;">
            <div class="project-selection-header">
                <h2><i class="fas fa-list"></i> AI Rewrite Results - Choose Version</h2>
                <button class="close-modal-btn" onclick="cancelAIWorkflow()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="project-selection-content">
                <div class="rewrite-results" id="rewriteResults">
                    <!-- AI rewrite results will be populated here -->
                </div>
            </div>
            
            <div class="project-selection-footer">
                <button class="project-selection-cancel-btn" onclick="cancelAIWorkflow()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Upload Resumes Modal -->
    <div id="uploadModal" class="upload-modal">
        <div class="upload-modal-content">
            <div class="upload-modal-header">
                <h2 class="upload-modal-title">Upload Resume Files</h2>
                <button class="upload-modal-close" onclick="closeUploadModal()">&times;</button>
            </div>

            <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
                <i class="fas fa-cloud-upload-alt"></i>
                <div class="upload-area-text">Click to select files or drag and drop</div>
                <div class="upload-area-subtext">Support for PDF, DOCX, and DOC files (max 10MB each)</div>
            </div>

            <input type="file" id="fileInput" multiple accept=".pdf,.docx,.doc" style="display: none;" onchange="handleFileSelection(event)">

            <div class="selected-files" id="selectedFilesSection" style="display: none;">
                <h4>Selected Files</h4>
                <div class="file-list" id="fileList"></div>
            </div>

            <div class="upload-progress" id="uploadProgress">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="upload-status" id="uploadStatus">Uploading...</div>
            </div>

            <div class="upload-actions">
                <button class="cancel-btn" onclick="closeUploadModal()">Cancel</button>
                <button class="upload-btn" id="uploadBtn" onclick="uploadFiles()" disabled>Upload Files</button>
            </div>
        </div>
    </div>

    <!-- Upload Template Modal -->
    <div id="templateUploadModal" class="upload-modal">
        <div class="upload-modal-content">
            <div class="upload-modal-header">
                <h2 class="upload-modal-title">Upload Template</h2>
                <button class="upload-modal-close" onclick="closeTemplateUploadModal()">&times;</button>
            </div>

            <div class="template-upload-form">
                <div class="section-e-form-section">
                    <h3><i class="fas fa-info-circle"></i> Template Information</h3>
                    <div class="section-e-form-group">
                        <label for="templateName">Template Name *</label>
                        <input type="text" id="templateName" placeholder="e.g., Modern Section E Template" required>
                    </div>
                    <div class="section-e-form-group">
                        <label for="templateDescription">Description</label>
                        <textarea id="templateDescription" placeholder="Describe the template design and purpose..." rows="3"></textarea>
                    </div>
                    <div class="section-e-form-group">
                        <label for="templateType">Template Type *</label>
                        <select id="templateType" required>
                            <option value="">Select template type...</option>
                            <option value="pdf">PDF Template</option>
                            <option value="docx">DOCX Template (Advanced Formatting)</option>
                            <option value="jinja_docx">Jinja DOCX Template (Dynamic Content)</option>
                        </select>
                    </div>
                </div>

                <div class="upload-area" id="templateUploadArea" onclick="document.getElementById('templateFileInput').click()">
                    <i class="fas fa-file-upload"></i>
                    <div class="upload-area-text">Click to select template file</div>
                    <div class="upload-area-subtext">Support for PDF and DOCX files (max 25MB)</div>
                </div>

                <input type="file" id="templateFileInput" accept=".pdf,.docx" style="display: none;" onchange="handleTemplateFileSelection(event)">

                <div class="selected-files" id="templateSelectedFilesSection" style="display: none;">
                    <h4>Selected Template</h4>
                    <div class="file-list" id="templateFileList"></div>
                </div>

                <div class="upload-progress" id="templateUploadProgress" style="display: none;">
                    <div class="progress-bar">
                        <div class="progress-fill" id="templateProgressFill"></div>
                    </div>
                    <div class="upload-status" id="templateUploadStatus">Uploading...</div>
                </div>
            </div>

            <div class="upload-actions">
                <button class="cancel-btn" onclick="closeTemplateUploadModal()">Cancel</button>
                <button class="upload-btn" id="templateUploadBtn" onclick="uploadTemplate()" disabled>Upload Template</button>
            </div>
        </div>
    </div>

    <script>
        let selectedFiles = [];

        // Upload Modal Functions
        function openUploadModal() {
            if (isDemoMode) {
                alert('File upload is not available in demo mode. Please configure Supabase credentials to enable this feature.');
                return;
            }
            document.getElementById('uploadModal').style.display = 'block';
        }

        function closeUploadModal() {
            document.getElementById('uploadModal').style.display = 'none';
            resetUploadModal();
        }

        function resetUploadModal() {
            selectedFiles = [];
            document.getElementById('fileInput').value = '';
            document.getElementById('selectedFilesSection').style.display = 'none';
            document.getElementById('uploadProgress').style.display = 'none';
            document.getElementById('uploadBtn').disabled = true;
            updateFileList();
        }

        function handleFileSelection(event) {
            const files = Array.from(event.target.files);
            addFiles(files);
        }

        function addFiles(files) {
            const validTypes = ['.pdf', '.docx', '.doc'];
            const maxSize = 10 * 1024 * 1024; // 10MB

            files.forEach(file => {
                // Check file type
                const extension = '.' + file.name.split('.').pop().toLowerCase();
                if (!validTypes.includes(extension)) {
                    alert(`File "${file.name}" is not a supported type. Please upload PDF, DOCX, or DOC files.`);
                    return;
                }

                // Check file size
                if (file.size > maxSize) {
                    alert(`File "${file.name}" is too large. Maximum size is 10MB.`);
                    return;
                }

                // Check for duplicates
                if (selectedFiles.some(f => f.name === file.name && f.size === file.size)) {
                    alert(`File "${file.name}" is already selected.`);
                    return;
                }

                selectedFiles.push(file);
            });

            updateFileList();
            updateUploadButton();
        }

        function removeFile(index) {
            selectedFiles.splice(index, 1);
            updateFileList();
            updateUploadButton();
        }

        function updateFileList() {
            const fileList = document.getElementById('fileList');
            const selectedFilesSection = document.getElementById('selectedFilesSection');

            if (selectedFiles.length === 0) {
                selectedFilesSection.style.display = 'none';
                return;
            }

            selectedFilesSection.style.display = 'block';
            fileList.innerHTML = '';

            selectedFiles.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `
                    <div class="file-name">${file.name}</div>
                    <div class="file-size">${formatFileSize(file.size)}</div>
                    <button class="file-remove" onclick="removeFile(${index})" title="Remove file">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                fileList.appendChild(fileItem);
            });
        }

        function updateUploadButton() {
            const uploadBtn = document.getElementById('uploadBtn');
            uploadBtn.disabled = selectedFiles.length === 0;
            uploadBtn.textContent = selectedFiles.length === 0 ? 'Upload Files' : `Upload ${selectedFiles.length} File${selectedFiles.length > 1 ? 's' : ''}`;
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        async function uploadFiles() {
            if (selectedFiles.length === 0) return;

            const uploadBtn = document.getElementById('uploadBtn');
            const uploadProgress = document.getElementById('uploadProgress');
            const uploadStatus = document.getElementById('uploadStatus');
            const progressFill = document.getElementById('progressFill');

            // Disable upload button and show progress
            uploadBtn.disabled = true;
            uploadProgress.style.display = 'block';

            try {
                let uploadedCount = 0;
                let failedUploads = [];

                let uploadedFileNames = []; // Track actual uploaded filenames
                
                for (let i = 0; i < selectedFiles.length; i++) {
                    const file = selectedFiles[i];
                    const progress = ((i + 1) / selectedFiles.length) * 100;

                    uploadStatus.textContent = `Uploading ${file.name}... (${i + 1}/${selectedFiles.length})`;
                    progressFill.style.width = `${progress}%`;

                    try {
                        // Upload to Supabase bucket
                        const fileName = `${Date.now()}_${file.name}`;
                        const { data, error } = await supabase.storage
                            .from('msmm-resumes')
                            .upload(fileName, file);

                        if (error) {
                            throw error;
                        }

                        uploadedCount++;
                        uploadedFileNames.push(fileName); // Store the actual uploaded filename
                    } catch (error) {
                        console.error(`Failed to upload ${file.name}:`, error);
                        failedUploads.push({ fileName: file.name, error: error.message });
                    }
                }

                // Show completion status
                progressFill.style.width = '100%';
                
                if (uploadedCount === selectedFiles.length) {
                    uploadStatus.textContent = ` Successfully uploaded ${uploadedCount} file${uploadedCount > 1 ? 's' : ''} to bucket!`;
                    uploadStatus.style.color = '#059669';
                    
                    // Try to trigger immediate processing if watcher API is available
                    const triggerResults = await tryTriggerImmediateProcessing(uploadedFileNames);
                    
                    // Auto-close modal after success
                    setTimeout(() => {
                        closeUploadModal();
                        
                        // Show enhanced success message based on trigger results
                        showUploadSuccessMessage(uploadedCount, triggerResults);
                    }, 2000);
                } else {
                    uploadStatus.innerHTML = ` Uploaded ${uploadedCount}/${selectedFiles.length} files. ${failedUploads.length} failed.`;
                    uploadStatus.style.color = '#f59e0b';
                    
                    // Show details of failed uploads
                    if (failedUploads.length > 0) {
                        const errorDetails = failedUploads.map(f => ` ${f.fileName}: ${f.error}`).join('\n');
                        setTimeout(() => {
                            alert(`Some uploads failed:\n\n${errorDetails}`);
                        }, 2000);
                    }
                }

            } catch (error) {
                console.error('Upload error:', error);
                uploadStatus.textContent = ` Upload failed: ${error.message}`;
                uploadStatus.style.color = '#dc2626';
            } finally {
                uploadBtn.disabled = false;
            }
        }

        // Setup drag and drop for upload area
        function setupUploadDragAndDrop() {
            const uploadArea = document.getElementById('uploadArea');
            
            if (!uploadArea) return;
            
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('drag-over');
            });
            
            uploadArea.addEventListener('dragleave', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('drag-over');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('drag-over');
                
                const files = Array.from(e.dataTransfer.files);
                addFiles(files);
            });
        }

        // Add upload button event listener
        document.addEventListener('DOMContentLoaded', function() {
            const uploadBtn = document.getElementById('uploadResumesBtn');
            if (uploadBtn) {
                uploadBtn.addEventListener('click', openUploadModal);
            }
            setupUploadDragAndDrop();
        });

        // Try to trigger immediate processing for uploaded files
        async function tryTriggerImmediateProcessing(uploadedFileNames) {
            const results = [];
            
            try {
                // Try to call a trigger endpoint for immediate processing
                for (const fileName of uploadedFileNames) {
                    try {
                        const response = await fetch('/api/trigger-processing', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ filename: fileName })
                        });
                        
                        const result = await response.json();
                        
                        if (response.ok && result.success) {
                            console.log(` Successfully triggered immediate processing for: ${fileName}`);
                            results.push({
                                filename: fileName,
                                success: true,
                                message: result.message
                            });
                        } else {
                            console.log(` Failed to trigger processing for ${fileName}: ${result.error || 'Unknown error'}`);
                            results.push({
                                filename: fileName,
                                success: false,
                                error: result.error || 'Unknown error'
                            });
                        }
                    } catch (e) {
                        console.log(` Immediate processing trigger not available for: ${fileName}`);
                        results.push({
                            filename: fileName,
                            success: false,
                            error: 'API not available'
                        });
                    }
                }
                
                return results;
            } catch (error) {
                console.log(' Immediate processing trigger not available');
                return null;
            }
        }

        // Show enhanced success message based on trigger results
        function showUploadSuccessMessage(uploadedCount, triggerResults) {
            let message = ` Successfully uploaded ${uploadedCount} resume file${uploadedCount > 1 ? 's' : ''} to the "msmm-resumes" bucket!\n\n`;

            if (triggerResults && triggerResults.length > 0) {
                const successCount = triggerResults.filter(r => r.success).length;
                const failedCount = triggerResults.length - successCount;

                if (successCount > 0) {
                    message += ` ${successCount} file${successCount !== 1 ? 's were' : ' was'} triggered for immediate processing!\n`;
                    if (successCount === uploadedCount) {
                        message += ` Files will be processed automatically if the bucket watcher is running.\n\n`;
                        message += ` Processing time: 1-3 minutes per file\n`;
                        message += ` Refresh this page in a few minutes to see new data!\n\n`;
                    }
                }
                
                if (failedCount > 0) {
                    message += ` ${failedCount} trigger${failedCount !== 1 ? 's failed' : ' failed'} - watcher may not be running.\n\n`;
                }
            } else {
                message += ` Immediate processing trigger not available - watcher may not be running.\n\n`;
            }

            // Add manual processing instructions for fallback
            if (!triggerResults || triggerResults.some(r => !r.success)) {
                message += ` Manual processing options:\n`;
                message += `1. Start watcher: python3 src/automation/supabase_bucket_watcher.py\n`;
                message += `2. Process existing: python3 src/automation/supabase_bucket_watcher.py --scan-existing\n`;
                message += `3. Then refresh this page!\n\n`;
            }

            message += ` Files are uploaded to: msmm-resumes bucket`;

            alert(message);
        }

        // Close modal when clicking outside
        document.getElementById('uploadModal').addEventListener('click', function(event) {
            if (event.target === this) {
                closeUploadModal();
            }
        });

        // =====================================================================
        // TEMPLATE UPLOAD FUNCTIONALITY
        // =====================================================================

        let selectedTemplateFile = null;

        // Template Upload Modal Functions
        function openTemplateUploadModal() {
            if (isDemoMode) {
                alert('Template upload is not available in demo mode. Please configure Supabase credentials to enable this feature.');
                return;
            }
            document.getElementById('templateUploadModal').style.display = 'block';
        }

        function closeTemplateUploadModal() {
            document.getElementById('templateUploadModal').style.display = 'none';
            resetTemplateUploadModal();
        }

        function resetTemplateUploadModal() {
            selectedTemplateFile = null;
            document.getElementById('templateFileInput').value = '';
            document.getElementById('templateName').value = '';
            document.getElementById('templateDescription').value = '';
            document.getElementById('templateType').value = '';
            document.getElementById('templateSelectedFilesSection').style.display = 'none';
            document.getElementById('templateUploadProgress').style.display = 'none';
            document.getElementById('templateUploadBtn').disabled = true;
            updateTemplateFileList();
        }

        function handleTemplateFileSelection(event) {
            const file = event.target.files[0];
            if (file) {
                addTemplateFile(file);
            }
        }

        function addTemplateFile(file) {
            const validTypes = ['.pdf', '.docx'];
            const maxSize = 25 * 1024 * 1024; // 25MB

            // Check file type
            const extension = '.' + file.name.split('.').pop().toLowerCase();
            if (!validTypes.includes(extension)) {
                alert('Please upload a PDF or DOCX file.');
                return;
            }

            // Check file size
            if (file.size > maxSize) {
                alert('File is too large. Maximum size is 25MB.');
                return;
            }

            selectedTemplateFile = file;
            updateTemplateFileList();
            updateTemplateUploadButton();
        }

        function removeTemplateFile() {
            selectedTemplateFile = null;
            document.getElementById('templateFileInput').value = '';
            updateTemplateFileList();
            updateTemplateUploadButton();
        }

        function updateTemplateFileList() {
            const fileList = document.getElementById('templateFileList');
            const selectedFilesSection = document.getElementById('templateSelectedFilesSection');

            if (!selectedTemplateFile) {
                selectedFilesSection.style.display = 'none';
                return;
            }

            selectedFilesSection.style.display = 'block';
            fileList.innerHTML = `
                <div class="file-item">
                    <div class="file-name">${selectedTemplateFile.name}</div>
                    <div class="file-size">${formatFileSize(selectedTemplateFile.size)}</div>
                    <button class="file-remove" onclick="removeTemplateFile()" title="Remove file">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
        }

        function updateTemplateUploadButton() {
            const uploadBtn = document.getElementById('templateUploadBtn');
            const templateName = document.getElementById('templateName').value.trim();
            const templateType = document.getElementById('templateType').value;
            
            const isValid = selectedTemplateFile && templateName && templateType;
            uploadBtn.disabled = !isValid;
            uploadBtn.textContent = isValid ? 'Upload Template' : 'Upload Template';
        }

        // Add event listeners for form validation
        document.addEventListener('DOMContentLoaded', function() {
            const templateName = document.getElementById('templateName');
            const templateType = document.getElementById('templateType');
            
            if (templateName) {
                templateName.addEventListener('input', updateTemplateUploadButton);
            }
            if (templateType) {
                templateType.addEventListener('change', updateTemplateUploadButton);
            }
        });

        async function uploadTemplate() {
            if (!selectedTemplateFile) return;

            const templateName = document.getElementById('templateName').value.trim();
            const templateDescription = document.getElementById('templateDescription').value.trim();
            const templateType = document.getElementById('templateType').value;

            if (!templateName || !templateType) {
                alert('Please fill in all required fields.');
                return;
            }

            const uploadBtn = document.getElementById('templateUploadBtn');
            const uploadProgress = document.getElementById('templateUploadProgress');
            const uploadStatus = document.getElementById('templateUploadStatus');
            const progressFill = document.getElementById('templateProgressFill');

            // Disable upload button and show progress
            uploadBtn.disabled = true;
            uploadProgress.style.display = 'block';

            try {
                uploadStatus.textContent = 'Uploading template...';
                progressFill.style.width = '50%';

                // Generate unique filename
                const fileName = `${Date.now()}_${selectedTemplateFile.name}`;

                // Upload to Supabase bucket
                const { data, error } = await supabase.storage
                    .from('resume-templates')
                    .upload(fileName, selectedTemplateFile);

                if (error) {
                    throw error;
                }

                // Update progress
                progressFill.style.width = '75%';
                uploadStatus.textContent = 'Updating template registry...';

                // Call backend API to update templates.json
                const templateData = {
                    name: templateName,
                    description: templateDescription,
                    filename: fileName,
                    originalFilename: selectedTemplateFile.name,
                    type: templateType,
                    size: selectedTemplateFile.size
                };

                const response = await fetch('/api/upload-template', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(templateData)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to register template');
                }

                const result = await response.json();

                // Complete progress
                progressFill.style.width = '100%';
                uploadStatus.textContent = ' Template uploaded successfully!';
                uploadStatus.style.color = '#059669';

                // Auto-close modal after success
                setTimeout(() => {
                    closeTemplateUploadModal();
                    showTemplateUploadSuccessMessage(templateName);
                    
                    // Refresh templates in Create Section E modal if it's open
                    if (document.getElementById('sectionEModal').style.display === 'block') {
                        loadAvailableTemplates();
                    }
                }, 2000);

            } catch (error) {
                console.error('Template upload error:', error);
                uploadStatus.textContent = ` Upload failed: ${error.message}`;
                uploadStatus.style.color = '#dc2626';
                progressFill.style.width = '0%';
            } finally {
                uploadBtn.disabled = false;
            }
        }

        function showTemplateUploadSuccessMessage(templateName) {
            alert(` Template "${templateName}" uploaded successfully!\n\n Template is now available in the Create Section E Resume dialog.\n Template files are stored in: resume-templates bucket`);
        }

        // Close template modal when clicking outside
        document.addEventListener('DOMContentLoaded', function() {
            const templateModal = document.getElementById('templateUploadModal');
            if (templateModal) {
                templateModal.addEventListener('click', function(event) {
                    if (event.target === this) {
                        closeTemplateUploadModal();
                    }
                });
            }
        });

        // Setup drag and drop for template upload area
        function setupTemplateUploadDragAndDrop() {
            const uploadArea = document.getElementById('templateUploadArea');
            
            if (!uploadArea) return;
            
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('drag-over');
            });
            
            uploadArea.addEventListener('dragleave', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('drag-over');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('drag-over');
                
                const files = Array.from(e.dataTransfer.files);
                if (files.length > 0) {
                    addTemplateFile(files[0]); // Only take the first file
                }
            });
        }

        // Initialize template upload drag and drop
        document.addEventListener('DOMContentLoaded', function() {
            setupTemplateUploadDragAndDrop();
        });

        // Wrapper function for template refresh
        function loadTemplatesForModal() {
            return loadAvailableTemplates();
        }
    </script>

    <!-- Merge Employees Modal -->
    <div id="mergeModal" class="merge-modal">
        <div class="merge-modal-content">
            <div class="merge-modal-header">
                <h2 class="merge-modal-title">Merge Employees</h2>
                <button class="merge-modal-close" onclick="closeMergeModal()">&times;</button>
            </div>

            <div class="merge-modal-body">
                <!-- Step 1: Find and Select Employees -->
                <div id="mergeStep1" class="merge-step">
                    <h3><i class="fas fa-search"></i> Find Potential Duplicates</h3>
                    <p>Search for employees that might be duplicates based on name similarity and shared projects.</p>
                    
                    <div class="merge-actions">
                        <button class="find-duplicates-btn" id="findDuplicatesBtn" onclick="findPotentialDuplicates()">
                            <i class="fas fa-search"></i> Find Potential Duplicates
                        </button>
                        <button class="manual-select-btn" id="manualSelectBtn" onclick="showManualSelection()">
                            <i class="fas fa-hand-pointer"></i> Manual Selection
                        </button>
                    </div>

                    <!-- Loading state -->
                    <div id="mergeFindingLoading" class="merge-loading" style="display: none;">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Searching for potential duplicates...</p>
                    </div>

                    <!-- Auto-detected duplicates -->
                    <div id="duplicatesResults" class="duplicates-results" style="display: none;">
                        <h4>Potential Duplicates Found</h4>
                        <div id="duplicatesList" class="duplicates-list"></div>
                    </div>

                    <!-- Manual selection -->
                    <div id="manualSelection" class="manual-selection" style="display: none;">
                        <h4>Select Two Employees to Merge</h4>
                        <div class="employee-selection-grid">
                            <div class="employee-selector">
                                <label>Primary Employee (will be kept)</label>
                                <select id="primaryEmployeeSelect" onchange="updateMergePreview()">
                                    <option value="">Select primary employee...</option>
                                </select>
                            </div>
                            <div class="employee-selector">
                                <label>Secondary Employee (will be merged and removed)</label>
                                <select id="secondaryEmployeeSelect" onchange="updateMergePreview()">
                                    <option value="">Select secondary employee...</option>
                                </select>
                            </div>
                        </div>
                        <div class="manual-actions">
                            <button class="preview-merge-btn" id="previewMergeBtn" onclick="previewMerge()" disabled>
                                <i class="fas fa-eye"></i> Preview Merge
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Step 2: Preview Merge -->
                <div id="mergeStep2" class="merge-step" style="display: none;">
                    <h3><i class="fas fa-eye"></i> Merge Preview</h3>
                    <p>Review the merge operation before proceeding. You can choose which data to keep for each field.</p>

                    <!-- Loading state -->
                    <div id="mergePreviewLoading" class="merge-loading" style="display: none;">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Loading merge preview...</p>
                    </div>

                    <!-- Preview content -->
                    <div id="mergePreviewContent" class="merge-preview-content" style="display: none;">
                        <div class="merge-comparison">
                            <div class="comparison-section">
                                <h4>Employee Information</h4>
                                <div class="employee-comparison">
                                    <div class="employee-column primary-column">
                                        <h5><i class="fas fa-star"></i> Primary Employee (Will be kept)</h5>
                                        <div id="primaryEmployeeInfo" class="employee-info"></div>
                                    </div>
                                    <div class="employee-column secondary-column">
                                        <h5><i class="fas fa-user-minus"></i> Secondary Employee (Will be merged)</h5>
                                        <div id="secondaryEmployeeInfo" class="employee-info"></div>
                                    </div>
                                </div>
                            </div>

                            <div class="comparison-section">
                                <h4>Field Selection</h4>
                                <p>Choose which data to keep for conflicting fields:</p>
                                <div id="fieldSelectionOptions" class="field-selection-options"></div>
                            </div>

                            <div class="comparison-section">
                                <h4>Merge Impact</h4>
                                <div id="mergeImpactSummary" class="merge-impact-summary"></div>
                            </div>
                        </div>

                        <div class="merge-preview-actions">
                            <button class="back-to-selection-btn" onclick="backToSelection()">
                                <i class="fas fa-arrow-left"></i> Back to Selection
                            </button>
                            <button class="confirm-merge-btn" id="confirmMergeBtn" onclick="confirmMerge()">
                                <i class="fas fa-users"></i> Confirm Merge
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Step 3: Merge Results -->
                <div id="mergeStep3" class="merge-step" style="display: none;">
                    <h3><i class="fas fa-check-circle"></i> Merge Complete</h3>
                    
                    <!-- Loading state -->
                    <div id="mergeExecutionLoading" class="merge-loading" style="display: none;">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Merging employees...</p>
                    </div>

                    <!-- Results -->
                    <div id="mergeResults" class="merge-results" style="display: none;">
                        <div id="mergeResultsContent"></div>
                        <div class="merge-completion-actions">
                            <button class="close-merge-btn" onclick="closeMergeModal()">
                                <i class="fas fa-times"></i> Close
                            </button>
                            <button class="refresh-data-btn" onclick="refreshAfterMerge()">
                                <i class="fas fa-sync"></i> Refresh Data
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Merge Teams Modal -->
    <div id="mergeTeamsModal" class="merge-modal">
        <div class="merge-modal-content">
            <div class="merge-modal-header">
                <h2 class="merge-modal-title">Merge Teams</h2>
                <button class="merge-modal-close" onclick="closeTeamMergeModal()">&times;</button>
            </div>

            <div class="merge-modal-body">
                <!-- Step 1: Find and Select Teams -->
                <div id="teamMergeStep1" class="merge-step">
                    <h3><i class="fas fa-search"></i> Find Potential Duplicate Teams</h3>
                    <p>Search for teams that might be duplicates based on firm name similarity and shared employees/projects.</p>
                    
                    <div class="merge-actions">
                        <button class="find-duplicates-btn" id="findDuplicateTeamsBtn" onclick="findPotentialDuplicateTeams()">
                            <i class="fas fa-search"></i> Find Potential Duplicates
                        </button>
                        <button class="manual-select-btn" id="manualSelectTeamsBtn" onclick="showManualTeamSelection()">
                            <i class="fas fa-hand-pointer"></i> Manual Selection
                        </button>
                    </div>

                    <!-- Loading state -->
                    <div id="teamMergeFindingLoading" class="merge-loading" style="display: none;">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Searching for potential duplicate teams...</p>
                    </div>

                    <!-- Auto-detected duplicates -->
                    <div id="teamDuplicatesResults" class="duplicates-results" style="display: none;">
                        <h4>Potential Team Duplicates Found</h4>
                        <div id="teamDuplicatesList" class="duplicates-list"></div>
                    </div>

                    <!-- Manual selection -->
                    <div id="manualTeamSelection" class="manual-selection" style="display: none;">
                        <h4>Select Two Teams to Merge</h4>
                        <div class="employee-selection-grid">
                            <div class="employee-selector">
                                <label>Primary Team (will be kept)</label>
                                <select id="primaryTeamSelect" onchange="updateTeamMergePreview()">
                                    <option value="">Select primary team...</option>
                                </select>
                            </div>
                            <div class="employee-selector">
                                <label>Secondary Team (will be merged and removed)</label>
                                <select id="secondaryTeamSelect" onchange="updateTeamMergePreview()">
                                    <option value="">Select secondary team...</option>
                                </select>
                            </div>
                        </div>
                        <div class="manual-actions">
                            <button class="preview-merge-btn" id="previewTeamMergeBtn" onclick="previewTeamMerge()" disabled>
                                <i class="fas fa-eye"></i> Preview Merge
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Step 2: Preview Team Merge -->
                <div id="teamMergeStep2" class="merge-step" style="display: none;">
                    <h3><i class="fas fa-eye"></i> Team Merge Preview</h3>
                    <p>Review the team merge operation before proceeding. You can choose which data to keep for each field.</p>

                    <!-- Loading state -->
                    <div id="teamMergePreviewLoading" class="merge-loading" style="display: none;">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Loading team merge preview...</p>
                    </div>

                    <!-- Preview content -->
                    <div id="teamMergePreviewContent" class="merge-preview-content" style="display: none;">
                        <div class="merge-comparison">
                            <div class="comparison-section">
                                <h4>Team Information</h4>
                                <div class="employee-comparison">
                                    <div class="employee-column primary-column">
                                        <h5><i class="fas fa-star"></i> Primary Team (Will be kept)</h5>
                                        <div id="primaryTeamInfo" class="employee-info"></div>
                                    </div>
                                    <div class="employee-column secondary-column">
                                        <h5><i class="fas fa-building-minus"></i> Secondary Team (Will be merged)</h5>
                                        <div id="secondaryTeamInfo" class="employee-info"></div>
                                    </div>
                                </div>
                            </div>

                            <div class="comparison-section">
                                <h4>Field Selection</h4>
                                <p>Choose which data to keep for conflicting fields:</p>
                                <div id="teamFieldSelectionOptions" class="field-selection-options"></div>
                            </div>

                            <div class="comparison-section">
                                <h4>Merge Impact</h4>
                                <div id="teamMergeImpactSummary" class="merge-impact-summary"></div>
                            </div>
                        </div>

                        <div class="merge-preview-actions">
                            <button class="back-to-selection-btn" onclick="backToTeamSelection()">
                                <i class="fas fa-arrow-left"></i> Back to Selection
                            </button>
                            <button class="confirm-merge-btn" id="confirmTeamMergeBtn" onclick="confirmTeamMerge()">
                                <i class="fas fa-building"></i> Confirm Team Merge
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Step 3: Team Merge Results -->
                <div id="teamMergeStep3" class="merge-step" style="display: none;">
                    <h3><i class="fas fa-check-circle"></i> Team Merge Complete</h3>
                    
                    <!-- Loading state -->
                    <div id="teamMergeExecutionLoading" class="merge-loading" style="display: none;">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Merging teams...</p>
                    </div>

                    <!-- Results -->
                    <div id="teamMergeResults" class="merge-results" style="display: none;">
                        <div id="teamMergeResultsContent"></div>
                        <div class="merge-completion-actions">
                            <button class="close-merge-btn" onclick="closeTeamMergeModal()">
                                <i class="fas fa-times"></i> Close
                            </button>
                            <button class="refresh-data-btn" onclick="refreshAfterTeamMerge()">
                                <i class="fas fa-sync"></i> Refresh Data
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Split Roles Output Modal -->
    <div id="splitRolesOutputModal" class="merge-modal">
        <div class="merge-modal-content">
            <div class="merge-modal-header">
                <h2 class="merge-modal-title">Role Separator Normalization</h2>
                <button class="merge-modal-close" onclick="closeSplitRolesOutputModal()">&times;</button>
            </div>
            <div class="merge-modal-body">
                <div id="splitRolesOutputContent" class="script-output-content">
                    <div id="splitRolesLoading" class="merge-loading" style="display: none;">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Executing role separator normalization script...</p>
                    </div>
                    <div id="splitRolesOutput" style="display: none;">
                        <pre id="splitRolesOutputText"></pre>
                        <div class="script-output-actions">
                            <button class="refresh-data-btn" onclick="refreshAfterSplitRoles()">
                                <i class="fas fa-sync"></i> Refresh Data
                            </button>
                            <button class="close-output-btn" onclick="closeSplitRolesOutputModal()">
                                <i class="fas fa-times"></i> Close
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Original Merge Roles Modal (Hidden) -->
    <div id="mergeRolesModal" class="merge-modal" style="display: none !important;">
        <div class="merge-modal-content">
            <div class="merge-modal-header">
                <h2 class="merge-modal-title">Merge Roles</h2>
                <button class="merge-modal-close" onclick="closeRoleMergeModal()">&times;</button>
            </div>

            <div class="merge-modal-body">
                <!-- Step 1: Find and Select Roles -->
                <div id="roleMergeStep1" class="merge-step">
                    <h3><i class="fas fa-search"></i> Find Potential Duplicate Roles</h3>
                    <p>Search for roles that might be duplicates based on name similarity. You can also split compound roles like "Civil Engineer/Engineering Manager" into separate roles.</p>
                    
                    <div class="merge-actions">
                        <button class="find-duplicates-btn" id="findDuplicateRolesBtn" onclick="findPotentialDuplicateRoles()">
                            <i class="fas fa-search"></i> Find Potential Duplicates
                        </button>
                        <button class="manual-select-btn" id="manualSelectRolesBtn" onclick="showManualRoleSelection()">
                            <i class="fas fa-hand-pointer"></i> Manual Selection
                        </button>
                        <button class="split-roles-btn" id="splitRolesBtn" onclick="showRoleSplitOptions()">
                            <i class="fas fa-code-branch"></i> Split Compound Roles
                        </button>
                        <button class="normalize-roles-btn" id="normalizeRolesBtn" onclick="normalizeAllRoles()">
                            <i class="fas fa-magic"></i> Normalize All Roles
                        </button>
                    </div>

                    <!-- Loading state -->
                    <div id="roleMergeFindingLoading" class="merge-loading" style="display: none;">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Searching for potential duplicate roles...</p>
                    </div>

                    <!-- Auto-detected duplicates -->
                    <div id="roleDuplicatesResults" class="duplicates-results" style="display: none;">
                        <h4>Potential Role Duplicates Found</h4>
                        <div id="roleDuplicatesList" class="duplicates-list"></div>
                    </div>

                    <!-- Manual selection -->
                    <div id="manualRoleSelection" class="manual-selection" style="display: none;">
                        <h4>Select Two Roles to Merge</h4>
                        <div class="employee-selection-grid">
                            <div class="employee-selector">
                                <label>Primary Role (will be kept)</label>
                                <select id="primaryRoleSelect" onchange="updateRoleMergePreview()">
                                    <option value="">Select primary role...</option>
                                </select>
                            </div>
                            <div class="employee-selector">
                                <label>Secondary Role (will be merged and removed)</label>
                                <select id="secondaryRoleSelect" onchange="updateRoleMergePreview()">
                                    <option value="">Select secondary role...</option>
                                </select>
                            </div>
                        </div>
                        <div class="manual-actions">
                            <button class="preview-merge-btn" id="previewRoleMergeBtn" onclick="previewRoleMerge()" disabled>
                                <i class="fas fa-eye"></i> Preview Merge
                            </button>
                        </div>
                    </div>

                    <!-- Role Split Options -->
                    <div id="roleSplitOptions" class="manual-selection" style="display: none;">
                        <h4>Split Compound Roles</h4>
                        <div class="role-split-grid">
                            <div class="role-split-selector">
                                <label>Select compound role to split</label>
                                <select id="compoundRoleSelect">
                                    <option value="">Select compound role...</option>
                                </select>
                            </div>
                        </div>
                        <div class="manual-actions">
                            <button class="split-role-btn" id="executeSplitBtn" onclick="executeRoleSplit()" disabled>
                                <i class="fas fa-code-branch"></i> Split Role
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Step 2: Preview Merge -->
                <div id="roleMergeStep2" class="merge-step" style="display: none;">
                    <h3><i class="fas fa-eye"></i> Role Merge Preview</h3>
                    <p>Review the role merge operation before proceeding. This will update all employee records that contain these roles.</p>

                    <!-- Loading state -->
                    <div id="roleMergePreviewLoading" class="merge-loading" style="display: none;">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Loading role merge preview...</p>
                    </div>

                    <!-- Preview content -->
                    <div id="roleMergePreviewContent" class="merge-preview-content" style="display: none;">
                        <div class="merge-comparison">
                            <div class="comparison-section">
                                <h4>Role Information</h4>
                                <div class="employee-comparison">
                                    <div class="employee-column primary-column">
                                        <h5><i class="fas fa-star"></i> Primary Role (Will be kept)</h5>
                                        <div id="primaryRoleInfo" class="employee-info"></div>
                                    </div>
                                    <div class="employee-column secondary-column">
                                        <h5><i class="fas fa-user-minus"></i> Secondary Role (Will be merged)</h5>
                                        <div id="secondaryRoleInfo" class="employee-info"></div>
                                    </div>
                                </div>
                            </div>

                            <div class="comparison-section">
                                <h4>Merge Impact</h4>
                                <div id="roleMergeImpactSummary" class="merge-impact-summary"></div>
                            </div>
                        </div>

                        <div class="merge-preview-actions">
                            <button class="back-to-selection-btn" onclick="backToRoleSelection()">
                                <i class="fas fa-arrow-left"></i> Back to Selection
                            </button>
                            <button class="confirm-merge-btn" id="confirmRoleMergeBtn" onclick="confirmRoleMerge()">
                                <i class="fas fa-user-tag"></i> Confirm Role Merge
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Step 3: Merge Results -->
                <div id="roleMergeStep3" class="merge-step" style="display: none;">
                    <h3><i class="fas fa-check-circle"></i> Role Merge Complete</h3>
                    
                    <!-- Loading state -->
                    <div id="roleMergeExecutionLoading" class="merge-loading" style="display: none;">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Merging roles...</p>
                    </div>

                    <!-- Results -->
                    <div id="roleMergeResults" class="merge-results" style="display: none;">
                        <div id="roleMergeResultsContent"></div>
                        <div class="merge-completion-actions">
                            <button class="close-merge-btn" onclick="closeRoleMergeModal()">
                                <i class="fas fa-times"></i> Close
                            </button>
                            <button class="refresh-data-btn" onclick="refreshAfterRoleMerge()">
                                <i class="fas fa-sync"></i> Refresh Data
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Merge Employees Functionality
        let potentialDuplicates = [];
        let selectedPrimaryEmployee = null;
        let selectedSecondaryEmployee = null;
        let mergePreviewData = null;
        let mergeOptions = {};

        // Main merge modal functions
        function openMergeModal() {
            if (isDemoMode) {
                alert('Employee merge is not available in demo mode. Please configure Supabase credentials to enable this feature.');
                return;
            }
            document.getElementById('mergeModal').style.display = 'block';
            resetMergeModal();
            loadEmployeesForMerge();
        }

        function closeMergeModal() {
            document.getElementById('mergeModal').style.display = 'none';
            resetMergeModal();
        }

        function resetMergeModal() {
            // Reset all state
            potentialDuplicates = [];
            selectedPrimaryEmployee = null;
            selectedSecondaryEmployee = null;
            mergePreviewData = null;
            mergeOptions = {};

            // Show step 1, hide others
            document.getElementById('mergeStep1').style.display = 'block';
            document.getElementById('mergeStep2').style.display = 'none';
            document.getElementById('mergeStep3').style.display = 'none';

            // Hide all result sections
            document.getElementById('duplicatesResults').style.display = 'none';
            document.getElementById('manualSelection').style.display = 'none';
            document.getElementById('mergePreviewContent').style.display = 'none';

            // Reset loading states
            document.getElementById('mergeFindingLoading').style.display = 'none';
            document.getElementById('mergePreviewLoading').style.display = 'none';
            document.getElementById('mergeExecutionLoading').style.display = 'none';
        }

        async function loadEmployeesForMerge() {
            try {
                const response = await fetch('/api/employees-for-merge');
                if (!response.ok) throw new Error('Failed to load employees');
                
                const data = await response.json();
                const employees = data.employees || [];
                
                const primarySelect = document.getElementById('primaryEmployeeSelect');
                const secondarySelect = document.getElementById('secondaryEmployeeSelect');
                
                // Clear existing options
                primarySelect.innerHTML = '<option value="">Select primary employee...</option>';
                secondarySelect.innerHTML = '<option value="">Select secondary employee...</option>';
                
                if (employees.length === 0) {
                    const message = data.message || 'No employees found';
                    console.warn('No employees available for merge:', message);
                    
                    const disabledOption1 = new Option(`No employees available (${message})`, '');
                    const disabledOption2 = new Option(`No employees available (${message})`, '');
                    disabledOption1.disabled = true;
                    disabledOption2.disabled = true;
                    primarySelect.add(disabledOption1);
                    secondarySelect.add(disabledOption2);
                    return;
                }
                
                // Add employee options using database employee_id as value
                employees.forEach(employee => {
                    const displayName = `${employee.employee_name} (${employee.source_filename || 'Unknown source'})`;
                    const option1 = new Option(displayName, employee.employee_id);
                    const option2 = new Option(displayName, employee.employee_id);
                    primarySelect.add(option1);
                    secondarySelect.add(option2);
                });
                
                console.log(`Loaded ${employees.length} employees for merge functionality`);
                
            } catch (error) {
                console.error('Error loading employees for merge:', error);
                alert('Failed to load employees. Please try again.');
            }
        }

        async function findPotentialDuplicates() {
            const button = document.getElementById('findDuplicatesBtn');
            const loading = document.getElementById('mergeFindingLoading');
            const results = document.getElementById('duplicatesResults');
            
            button.disabled = true;
            loading.style.display = 'block';
            results.style.display = 'none';
            
            try {
                const response = await fetch('/api/potential-duplicates');
                if (!response.ok) throw new Error('Failed to find duplicates');
                
                const data = await response.json();
                potentialDuplicates = data.duplicates || [];
                
                loading.style.display = 'none';
                
                if (potentialDuplicates.length === 0) {
                    results.innerHTML = '<div class="no-duplicates-message"><i class="fas fa-check-circle"></i> No potential duplicates found! All employees appear to be unique.</div>';
                    results.style.display = 'block';
                } else {
                    displayPotentialDuplicates();
                    results.style.display = 'block';
                }
                
            } catch (error) {
                console.error('Error finding duplicates:', error);
                loading.style.display = 'none';
                alert('Failed to find potential duplicates. Please try again.');
            } finally {
                button.disabled = false;
            }
        }

        function displayPotentialDuplicates() {
            const list = document.getElementById('duplicatesList');
            list.innerHTML = '';
            
            potentialDuplicates.forEach((duplicate, index) => {
                const duplicateItem = document.createElement('div');
                duplicateItem.className = 'duplicate-item';
                duplicateItem.innerHTML = `
                    <div class="duplicate-info">
                        <div class="duplicate-employees">
                            <div class="employee-info">
                                <strong>${duplicate.employee1_name}</strong>
                                <span class="similarity-badge">Primary Candidate</span>
                            </div>
                            <div class="merge-arrow"><i class="fas fa-arrow-right"></i></div>
                            <div class="employee-info">
                                <strong>${duplicate.employee2_name}</strong>
                                <span class="similarity-badge">Secondary</span>
                            </div>
                        </div>
                        <div class="duplicate-stats">
                            <span class="stat">Similarity: ${Math.round(duplicate.similarity_score * 100)}%</span>
                            <span class="stat">Shared Projects: ${duplicate.common_projects}</span>
                        </div>
                    </div>
                    <div class="duplicate-actions">
                        <button class="select-duplicate-btn" onclick="selectDuplicate('${duplicate.employee1_id}', '${duplicate.employee2_id}', '${duplicate.employee1_name}', '${duplicate.employee2_name}')">
                            <i class="fas fa-hand-pointer"></i> Select for Merge
                        </button>
                    </div>
                `;
                list.appendChild(duplicateItem);
            });
        }

        function showManualSelection() {
            document.getElementById('manualSelection').style.display = 'block';
        }

        function selectDuplicate(primaryId, secondaryId, primaryName, secondaryName) {
            selectedPrimaryEmployee = { id: primaryId, name: primaryName };
            selectedSecondaryEmployee = { id: secondaryId, name: secondaryName };
            previewMerge();
        }

        function updateMergePreview() {
            const primarySelect = document.getElementById('primaryEmployeeSelect');
            const secondarySelect = document.getElementById('secondaryEmployeeSelect');
            const previewBtn = document.getElementById('previewMergeBtn');
            
            const primaryValue = primarySelect.value;
            const secondaryValue = secondarySelect.value;
            const primaryText = primarySelect.options[primarySelect.selectedIndex]?.text || '';
            const secondaryText = secondarySelect.options[secondarySelect.selectedIndex]?.text || '';
            
            // Enable preview button if both employees are selected and different
            previewBtn.disabled = !primaryValue || !secondaryValue || primaryValue === secondaryValue;
            
            if (primaryValue && secondaryValue && primaryValue !== secondaryValue) {
                selectedPrimaryEmployee = { id: primaryValue, name: primaryText };
                selectedSecondaryEmployee = { id: secondaryValue, name: secondaryText };
            }
        }

        async function previewMerge() {
            if (!selectedPrimaryEmployee || !selectedSecondaryEmployee) {
                alert('Please select both employees to merge.');
                return;
            }
            
            // Hide step 1, show step 2
            document.getElementById('mergeStep1').style.display = 'none';
            document.getElementById('mergeStep2').style.display = 'block';
            
            const loading = document.getElementById('mergePreviewLoading');
            const content = document.getElementById('mergePreviewContent');
            
            loading.style.display = 'block';
            content.style.display = 'none';
            
            try {
                const response = await fetch(`/api/merge-preview/${encodeURIComponent(selectedPrimaryEmployee.id)}/${encodeURIComponent(selectedSecondaryEmployee.id)}`);
                if (!response.ok) throw new Error('Failed to get merge preview');
                
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                mergePreviewData = data;
                displayMergePreview(data);
                
                loading.style.display = 'none';
                content.style.display = 'block';
                
            } catch (error) {
                console.error('Error getting merge preview:', error);
                alert('Failed to get merge preview: ' + error.message);
                backToSelection();
            }
        }

        function displayMergePreview(data) {
            // Display primary employee info
            const primaryInfo = document.getElementById('primaryEmployeeInfo');
            const primary = data.primary_employee;
            primaryInfo.innerHTML = `
                <div class="employee-details">
                    <h6>${primary.employee_name}</h6>
                    <p><strong>Experience:</strong> ${primary.total_years_experience || 'N/A'} years total, ${primary.current_firm_years_experience || 'N/A'} with current firm</p>
                    <p><strong>Education:</strong> ${primary.education || 'N/A'}</p>
                    <p><strong>Source:</strong> ${primary.source_filename || 'N/A'}</p>
                    <p><strong>Qualifications:</strong> ${primary.qualifications?.length || 0}</p>
                    <p><strong>Assignments:</strong> ${primary.assignments_count || 0}</p>
                </div>
            `;
            
            // Display secondary employee info
            const secondaryInfo = document.getElementById('secondaryEmployeeInfo');
            const secondary = data.secondary_employee;
            secondaryInfo.innerHTML = `
                <div class="employee-details">
                    <h6>${secondary.employee_name}</h6>
                    <p><strong>Experience:</strong> ${secondary.total_years_experience || 'N/A'} years total, ${secondary.current_firm_years_experience || 'N/A'} with current firm</p>
                    <p><strong>Education:</strong> ${secondary.education || 'N/A'}</p>
                    <p><strong>Source:</strong> ${secondary.source_filename || 'N/A'}</p>
                    <p><strong>Qualifications:</strong> ${secondary.qualifications?.length || 0}</p>
                    <p><strong>Assignments:</strong> ${secondary.assignments_count || 0}</p>
                </div>
            `;
            
            // Display field selection options
            const fieldOptions = document.getElementById('fieldSelectionOptions');
            fieldOptions.innerHTML = `
                <div class="field-option">
                    <label>Employee Name:</label>
                    <div class="radio-group">
                        <label><input type="radio" name="keep_name" value="primary" checked> Keep "${primary.employee_name}"</label>
                        <label><input type="radio" name="keep_name" value="secondary"> Keep "${secondary.employee_name}"</label>
                    </div>
                </div>
                <div class="field-option">
                    <label>Total Experience:</label>
                    <div class="radio-group">
                        <label><input type="radio" name="keep_experience" value="higher" checked> Keep Higher (${Math.max(primary.total_years_experience || 0, secondary.total_years_experience || 0)} years)</label>
                        <label><input type="radio" name="keep_experience" value="primary"> Keep Primary (${primary.total_years_experience || 0} years)</label>
                        <label><input type="radio" name="keep_experience" value="secondary"> Keep Secondary (${secondary.total_years_experience || 0} years)</label>
                    </div>
                </div>
                <div class="field-option">
                    <label>Education:</label>
                    <div class="radio-group">
                        <label><input type="radio" name="keep_education" value="longer" checked> Keep Longer Description</label>
                        <label><input type="radio" name="keep_education" value="primary"> Keep Primary</label>
                        <label><input type="radio" name="keep_education" value="secondary"> Keep Secondary</label>
                    </div>
                </div>
            `;
            
            // Display merge impact
            const impact = document.getElementById('mergeImpactSummary');
            const mergeImpact = data.merge_impact;
            impact.innerHTML = `
                <div class="impact-stats">
                    <div class="impact-stat">
                        <strong>Total Qualifications After Merge:</strong> ${mergeImpact.total_qualifications_after_merge}
                    </div>
                    <div class="impact-stat">
                        <strong>Total Assignments After Merge:</strong> ${mergeImpact.total_assignments_after_merge}
                    </div>
                    <div class="impact-stat warning">
                        <strong>Will Delete Employee:</strong> ${secondary.employee_name} (ID: ${mergeImpact.will_delete_employee_id})
                    </div>
                </div>
            `;
        }

        function backToSelection() {
            document.getElementById('mergeStep1').style.display = 'block';
            document.getElementById('mergeStep2').style.display = 'none';
        }

        async function confirmMerge() {
            if (!mergePreviewData) {
                alert('No merge preview data available.');
                return;
            }
            
            // Collect merge options from radio buttons
            mergeOptions = {};
            const radioGroups = ['keep_name', 'keep_experience', 'keep_education'];
            radioGroups.forEach(group => {
                const selected = document.querySelector(`input[name="${group}"]:checked`);
                if (selected) {
                    mergeOptions[group] = selected.value;
                }
            });
            
            // Show step 3
            document.getElementById('mergeStep2').style.display = 'none';
            document.getElementById('mergeStep3').style.display = 'block';
            
            const loading = document.getElementById('mergeExecutionLoading');
            const results = document.getElementById('mergeResults');
            
            loading.style.display = 'block';
            results.style.display = 'none';
            
            try {
                console.log('Starting merge operation:', {
                    primary_employee_id: selectedPrimaryEmployee.id,
                    secondary_employee_id: selectedSecondaryEmployee.id,
                    merge_options: mergeOptions
                });
                
                const response = await fetch('/api/merge-employees', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        primary_employee_id: selectedPrimaryEmployee.id,
                        secondary_employee_id: selectedSecondaryEmployee.id,
                        merge_options: mergeOptions
                    })
                });
                
                console.log('Merge response status:', response.status, response.statusText);
                
                const result = await response.json();
                console.log('Merge result:', result);
                
                if (!response.ok) {
                    const errorMessage = result.error || `Server returned ${response.status}: ${response.statusText}`;
                    throw new Error(`Failed to merge employees: ${errorMessage}`);
                }
                
                loading.style.display = 'none';
                
                if (result.success) {
                    displayMergeSuccess(result);
                } else {
                    displayMergeError(result.error || 'Unknown error occurred during merge');
                }
                
                results.style.display = 'block';
                
            } catch (error) {
                console.error('Error merging employees:', error);
                loading.style.display = 'none';
                displayMergeError(error.message);
                results.style.display = 'block';
            }
        }

        function displayMergeSuccess(result) {
            const content = document.getElementById('mergeResultsContent');
            content.innerHTML = `
                <div class="merge-success">
                    <div class="success-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <h4>Merge Completed Successfully!</h4>
                    <div class="merge-summary">
                        <p><strong>${result.secondary_employee_name}</strong> has been successfully merged into <strong>${result.primary_employee_name}</strong></p>
                        <div class="merge-stats">
                            <div class="stat">
                                <span class="stat-number">${result.qualifications_moved}</span>
                                <span class="stat-label">Qualifications Moved</span>
                            </div>
                            <div class="stat">
                                <span class="stat-number">${result.assignments_moved}</span>
                                <span class="stat-label">Assignments Moved</span>
                            </div>
                            ${result.duplicate_assignments_removed > 0 ? `
                            <div class="stat">
                                <span class="stat-number">${result.duplicate_assignments_removed}</span>
                                <span class="stat-label">Duplicates Removed</span>
                            </div>
                            ` : ''}
                        </div>
                        <p class="merge-time">Completed at: ${new Date(result.merged_at).toLocaleString()}</p>
                    </div>
                </div>
            `;
        }

        function displayMergeError(error) {
            const content = document.getElementById('mergeResultsContent');
            content.innerHTML = `
                <div class="merge-error">
                    <div class="error-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <h4>Merge Failed</h4>
                    <p>The merge operation could not be completed:</p>
                    <div class="error-message">${error}</div>
                    <p>Please try again or contact support if the problem persists.</p>
                </div>
            `;
        }

        function refreshAfterMerge() {
            // Refresh the page to show updated data
            window.location.reload();
        }

        // Add merge button event listener
        document.addEventListener('DOMContentLoaded', function() {
            const mergeBtn = document.getElementById('mergeEmployeesBtn');
            if (mergeBtn) {
                mergeBtn.addEventListener('click', openMergeModal);
            }
        });

        // Close modal when clicking outside
        document.addEventListener('DOMContentLoaded', function() {
            const mergeModal = document.getElementById('mergeModal');
            if (mergeModal) {
                mergeModal.addEventListener('click', function(event) {
                    if (event.target === this) {
                        closeMergeModal();
                    }
                });
            }
        });

        // Merge Teams Functionality
        let potentialTeamDuplicates = [];
        let selectedPrimaryTeam = null;
        let selectedSecondaryTeam = null;
        let teamMergePreviewData = null;
        let teamMergeOptions = {};

        // Main team merge modal functions
        function openTeamMergeModal() {
            if (isDemoMode) {
                alert('Team merge is not available in demo mode. Please configure Supabase credentials to enable this feature.');
                return;
            }
            document.getElementById('mergeTeamsModal').style.display = 'block';
            resetTeamMergeModal();
            loadTeamsForMerge();
        }

        function closeTeamMergeModal() {
            document.getElementById('mergeTeamsModal').style.display = 'none';
            resetTeamMergeModal();
        }

        function resetTeamMergeModal() {
            // Reset all state
            potentialTeamDuplicates = [];
            selectedPrimaryTeam = null;
            selectedSecondaryTeam = null;
            teamMergePreviewData = null;
            teamMergeOptions = {};

            // Show step 1, hide others
            document.getElementById('teamMergeStep1').style.display = 'block';
            document.getElementById('teamMergeStep2').style.display = 'none';
            document.getElementById('teamMergeStep3').style.display = 'none';

            // Hide all result sections
            document.getElementById('teamDuplicatesResults').style.display = 'none';
            document.getElementById('manualTeamSelection').style.display = 'none';
            document.getElementById('teamMergePreviewContent').style.display = 'none';

            // Reset loading states
            document.getElementById('teamMergeFindingLoading').style.display = 'none';
            document.getElementById('teamMergePreviewLoading').style.display = 'none';
            document.getElementById('teamMergeExecutionLoading').style.display = 'none';
        }

        async function loadTeamsForMerge() {
            try {
                const response = await fetch('/api/teams-for-merge');
                if (!response.ok) throw new Error('Failed to load teams');
                
                const data = await response.json();
                const teams = data.teams || [];
                
                const primarySelect = document.getElementById('primaryTeamSelect');
                const secondarySelect = document.getElementById('secondaryTeamSelect');
                
                // Clear existing options
                primarySelect.innerHTML = '<option value="">Select primary team...</option>';
                secondarySelect.innerHTML = '<option value="">Select secondary team...</option>';
                
                if (teams.length === 0) {
                    const message = data.message || 'No teams found';
                    console.warn('No teams available for merge:', message);
                    
                    const disabledOption1 = new Option(`No teams available (${message})`, '');
                    const disabledOption2 = new Option(`No teams available (${message})`, '');
                    disabledOption1.disabled = true;
                    disabledOption2.disabled = true;
                    primarySelect.add(disabledOption1);
                    secondarySelect.add(disabledOption2);
                    return;
                }
                
                // Add team options using database team_id as value
                teams.forEach(team => {
                    const displayName = `${team.firm_name}${team.location ? ' (' + team.location + ')' : ''}`;
                    const option1 = new Option(displayName, team.team_id);
                    const option2 = new Option(displayName, team.team_id);
                    primarySelect.add(option1);
                    secondarySelect.add(option2);
                });
                
                console.log(`Loaded ${teams.length} teams for merge functionality`);
                
            } catch (error) {
                console.error('Error loading teams for merge:', error);
                alert('Failed to load teams. Please try again.');
            }
        }

        async function findPotentialDuplicateTeams() {
            const button = document.getElementById('findDuplicateTeamsBtn');
            const loading = document.getElementById('teamMergeFindingLoading');
            const results = document.getElementById('teamDuplicatesResults');
            
            button.disabled = true;
            loading.style.display = 'block';
            results.style.display = 'none';
            
            try {
                const response = await fetch('/api/potential-duplicate-teams');
                if (!response.ok) throw new Error('Failed to find duplicate teams');
                
                const data = await response.json();
                potentialTeamDuplicates = data.duplicates || [];
                
                loading.style.display = 'none';
                
                if (potentialTeamDuplicates.length === 0) {
                    results.innerHTML = '<div class="no-duplicates-message"><i class="fas fa-check-circle"></i> No potential duplicate teams found! All teams appear to be unique.</div>';
                    results.style.display = 'block';
                } else {
                    displayPotentialTeamDuplicates();
                    results.style.display = 'block';
                }
                
            } catch (error) {
                console.error('Error finding duplicate teams:', error);
                loading.style.display = 'none';
                alert('Failed to find potential duplicate teams. Please try again.');
            } finally {
                button.disabled = false;
            }
        }

        function displayPotentialTeamDuplicates() {
            const list = document.getElementById('teamDuplicatesList');
            list.innerHTML = '';
            
            potentialTeamDuplicates.forEach((duplicate, index) => {
                const duplicateItem = document.createElement('div');
                duplicateItem.className = 'duplicate-item';
                duplicateItem.innerHTML = `
                    <div class="duplicate-info">
                        <div class="duplicate-employees">
                            <div class="employee-info">
                                <strong>${duplicate.team1_name}</strong>
                                ${duplicate.team1_location ? `<br><small>${duplicate.team1_location}</small>` : ''}
                                <span class="similarity-badge">Primary Candidate</span>
                            </div>
                            <div class="merge-arrow"><i class="fas fa-arrow-right"></i></div>
                            <div class="employee-info">
                                <strong>${duplicate.team2_name}</strong>
                                ${duplicate.team2_location ? `<br><small>${duplicate.team2_location}</small>` : ''}
                                <span class="similarity-badge">Secondary</span>
                            </div>
                        </div>
                        <div class="duplicate-stats">
                            <span class="stat">Similarity: ${Math.round(duplicate.similarity_score * 100)}%</span>
                            <span class="stat">Shared Employees: ${duplicate.common_employees}</span>
                            <span class="stat">Shared Projects: ${duplicate.common_projects}</span>
                        </div>
                    </div>
                    <div class="duplicate-actions">
                        <button class="select-duplicate-btn" onclick="selectTeamDuplicate('${duplicate.team1_id}', '${duplicate.team2_id}', '${duplicate.team1_name}', '${duplicate.team2_name}')">
                            <i class="fas fa-hand-pointer"></i> Select for Merge
                        </button>
                    </div>
                `;
                list.appendChild(duplicateItem);
            });
        }

        function showManualTeamSelection() {
            document.getElementById('manualTeamSelection').style.display = 'block';
        }

        function selectTeamDuplicate(primaryId, secondaryId, primaryName, secondaryName) {
            selectedPrimaryTeam = { id: primaryId, name: primaryName };
            selectedSecondaryTeam = { id: secondaryId, name: secondaryName };
            previewTeamMerge();
        }

        function updateTeamMergePreview() {
            const primarySelect = document.getElementById('primaryTeamSelect');
            const secondarySelect = document.getElementById('secondaryTeamSelect');
            const previewBtn = document.getElementById('previewTeamMergeBtn');
            
            const primaryValue = primarySelect.value;
            const secondaryValue = secondarySelect.value;
            const primaryText = primarySelect.options[primarySelect.selectedIndex]?.text || '';
            const secondaryText = secondarySelect.options[secondarySelect.selectedIndex]?.text || '';
            
            // Enable preview button if both teams are selected and different
            previewBtn.disabled = !primaryValue || !secondaryValue || primaryValue === secondaryValue;
            
            if (primaryValue && secondaryValue && primaryValue !== secondaryValue) {
                selectedPrimaryTeam = { id: primaryValue, name: primaryText };
                selectedSecondaryTeam = { id: secondaryValue, name: secondaryText };
            }
        }

        async function previewTeamMerge() {
            if (!selectedPrimaryTeam || !selectedSecondaryTeam) {
                alert('Please select both teams to merge.');
                return;
            }
            
            // Hide step 1, show step 2
            document.getElementById('teamMergeStep1').style.display = 'none';
            document.getElementById('teamMergeStep2').style.display = 'block';
            
            const loading = document.getElementById('teamMergePreviewLoading');
            const content = document.getElementById('teamMergePreviewContent');
            
            loading.style.display = 'block';
            content.style.display = 'none';
            
            try {
                const response = await fetch(`/api/team-merge-preview/${encodeURIComponent(selectedPrimaryTeam.id)}/${encodeURIComponent(selectedSecondaryTeam.id)}`);
                if (!response.ok) throw new Error('Failed to get team merge preview');
                
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                teamMergePreviewData = data;
                displayTeamMergePreview(data);
                
                loading.style.display = 'none';
                content.style.display = 'block';
                
            } catch (error) {
                console.error('Error getting team merge preview:', error);
                alert('Failed to get team merge preview: ' + error.message);
                backToTeamSelection();
            }
        }

        function displayTeamMergePreview(data) {
            const primary = data.primary_team;
            const secondary = data.secondary_team;
            
            // Display team information
            const primaryInfo = document.getElementById('primaryTeamInfo');
            const secondaryInfo = document.getElementById('secondaryTeamInfo');
            
            primaryInfo.innerHTML = `
                <div class="team-info">
                    <p><strong>Team ID:</strong> ${primary.team_id}</p>
                    <p><strong>Firm Name:</strong> ${primary.firm_name || 'Not specified'}</p>
                    <p><strong>Location:</strong> ${primary.location || 'Not specified'}</p>
                    <p><strong>Employees:</strong> ${primary.employees_count}</p>
                    <p><strong>Projects:</strong> ${primary.projects_count}</p>
                    <p><strong>Created:</strong> ${new Date(primary.created_at).toLocaleDateString()}</p>
                </div>
            `;
            
            secondaryInfo.innerHTML = `
                <div class="team-info">
                    <p><strong>Team ID:</strong> ${secondary.team_id}</p>
                    <p><strong>Firm Name:</strong> ${secondary.firm_name || 'Not specified'}</p>
                    <p><strong>Location:</strong> ${secondary.location || 'Not specified'}</p>
                    <p><strong>Employees:</strong> ${secondary.employees_count}</p>
                    <p><strong>Projects:</strong> ${secondary.projects_count}</p>
                    <p><strong>Created:</strong> ${new Date(secondary.created_at).toLocaleDateString()}</p>
                </div>
            `;
            
            // Display field selection options
            const fieldOptions = document.getElementById('teamFieldSelectionOptions');
            fieldOptions.innerHTML = `
                <div class="field-option">
                    <label>Firm Name:</label>
                    <div class="field-choice">
                        <input type="radio" name="firm_name" value="primary" checked onchange="updateTeamMergeOption('keep_firm_name', 'primary')">
                        <span>Keep "${primary.firm_name || 'Not specified'}"</span>
                    </div>
                    <div class="field-choice">
                        <input type="radio" name="firm_name" value="secondary" onchange="updateTeamMergeOption('keep_firm_name', 'secondary')">
                        <span>Keep "${secondary.firm_name || 'Not specified'}"</span>
                    </div>
                </div>
                <div class="field-option">
                    <label>Location:</label>
                    <div class="field-choice">
                        <input type="radio" name="location" value="primary" checked onchange="updateTeamMergeOption('keep_location', 'primary')">
                        <span>Keep "${primary.location || 'Not specified'}"</span>
                    </div>
                    <div class="field-choice">
                        <input type="radio" name="location" value="secondary" onchange="updateTeamMergeOption('keep_location', 'secondary')">
                        <span>Keep "${secondary.location || 'Not specified'}"</span>
                    </div>
                </div>
            `;
            
            // Display merge impact
            const impact = document.getElementById('teamMergeImpactSummary');
            const mergeImpact = data.merge_impact;
            impact.innerHTML = `
                <div class="impact-stats">
                    <div class="impact-stat">
                        <strong>Total Employees After Merge:</strong> ${mergeImpact.total_employees_after_merge}
                    </div>
                    <div class="impact-stat">
                        <strong>Total Projects After Merge:</strong> ${mergeImpact.total_projects_after_merge}
                    </div>
                    <div class="impact-stat warning">
                        <strong>Will Delete Team:</strong> ${secondary.firm_name} (ID: ${mergeImpact.will_delete_team_id})
                    </div>
                </div>
            `;
        }

        function updateTeamMergeOption(key, value) {
            teamMergeOptions[key] = value;
        }

        function backToTeamSelection() {
            document.getElementById('teamMergeStep1').style.display = 'block';
            document.getElementById('teamMergeStep2').style.display = 'none';
        }

        async function confirmTeamMerge() {
            if (!selectedPrimaryTeam || !selectedSecondaryTeam) {
                alert('Invalid team selection.');
                return;
            }
            
            // Hide step 2, show step 3
            document.getElementById('teamMergeStep2').style.display = 'none';
            document.getElementById('teamMergeStep3').style.display = 'block';
            
            const loading = document.getElementById('teamMergeExecutionLoading');
            const results = document.getElementById('teamMergeResults');
            
            loading.style.display = 'block';
            results.style.display = 'none';
            
            try {
                console.log('Starting team merge operation:', {
                    primary_team_id: selectedPrimaryTeam.id,
                    secondary_team_id: selectedSecondaryTeam.id,
                    merge_options: teamMergeOptions
                });
                
                const response = await fetch('/api/merge-teams', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        primary_team_id: selectedPrimaryTeam.id,
                        secondary_team_id: selectedSecondaryTeam.id,
                        merge_options: teamMergeOptions
                    })
                });
                
                console.log('Team merge response status:', response.status, response.statusText);
                
                const result = await response.json();
                console.log('Team merge result:', result);
                
                if (!response.ok) {
                    const errorMessage = result.error || `Server returned ${response.status}: ${response.statusText}`;
                    throw new Error(`Failed to merge teams: ${errorMessage}`);
                }
                
                loading.style.display = 'none';
                
                if (result.success) {
                    displayTeamMergeSuccess(result);
                } else {
                    displayTeamMergeError(result.error || 'Unknown error occurred during team merge');
                }
                
                results.style.display = 'block';
                
            } catch (error) {
                console.error('Error merging teams:', error);
                loading.style.display = 'none';
                displayTeamMergeError(error.message);
                results.style.display = 'block';
            }
        }

        function displayTeamMergeSuccess(result) {
            const content = document.getElementById('teamMergeResultsContent');
            content.innerHTML = `
                <div class="merge-success">
                    <div class="success-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <h4>Teams Successfully Merged!</h4>
                    <div class="merge-summary">
                        <p><strong>Primary Team:</strong> ${result.primary_team_name} (kept)</p>
                        <p><strong>Secondary Team:</strong> ${result.secondary_team_name} (merged and removed)</p>
                        <p><strong>Assignments Moved:</strong> ${result.assignments_moved}</p>
                        <p><strong>Duplicate Assignments Removed:</strong> ${result.duplicate_assignments_removed}</p>
                        <p><strong>Merge Completed:</strong> ${new Date(result.merged_at).toLocaleString()}</p>
                    </div>
                    <p>The team data has been successfully consolidated. All employees and projects from the secondary team have been moved to the primary team.</p>
                </div>
            `;
        }

        function displayTeamMergeError(error) {
            const content = document.getElementById('teamMergeResultsContent');
            content.innerHTML = `
                <div class="merge-error">
                    <div class="error-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <h4>Team Merge Failed</h4>
                    <p>The team merge operation could not be completed:</p>
                    <div class="error-message">${error}</div>
                    <p>Please try again or contact support if the problem persists.</p>
                </div>
            `;
        }

        function refreshAfterTeamMerge() {
            // Refresh the page to show updated data
            window.location.reload();
        }

        // =====================================================================
        // ROLE MERGE FUNCTIONALITY
        // =====================================================================
        let potentialRoleDuplicates = [];
        let selectedPrimaryRole = null;
        let selectedSecondaryRole = null;
        let roleMergePreviewData = null;
        let roleMergeOptions = {};

        // Main role merge modal functions
        // =====================================================================
        // DEPRECATED ROLE MERGE MODAL FUNCTIONS (Now using split_roles.py)
        // =====================================================================
        
        async function loadRolesForMerge() {
            try {
                const response = await fetch('/api/roles-for-merge');
                if (!response.ok) throw new Error('Failed to load roles');
                
                const roles = await response.json();
                
                const primarySelect = document.getElementById('primaryRoleSelect');
                const secondarySelect = document.getElementById('secondaryRoleSelect');
                const compoundSelect = document.getElementById('compoundRoleSelect');
                
                // Clear existing options
                primarySelect.innerHTML = '<option value="">Select primary role...</option>';
                secondarySelect.innerHTML = '<option value="">Select secondary role...</option>';
                compoundSelect.innerHTML = '<option value="">Select compound role...</option>';
                
                if (roles.length === 0) {
                    const disabledOption1 = new Option('No roles available', '');
                    const disabledOption2 = new Option('No roles available', '');
                    const disabledOption3 = new Option('No roles available', '');
                    disabledOption1.disabled = true;
                    disabledOption2.disabled = true;
                    disabledOption3.disabled = true;
                    primarySelect.add(disabledOption1);
                    secondarySelect.add(disabledOption2);
                    compoundSelect.add(disabledOption3);
                    return;
                }
                
                // Add role options
                roles.forEach(role => {
                    // Skip roles with missing or invalid data
                    if (!role.role_name || role.employee_count === undefined || role.employee_count === null) {
                        console.warn('Skipping role with missing data:', JSON.stringify(role, null, 2));
                        return;
                    }
                    
                    const displayName = `${role.role_name} (${role.employee_count} employees)`;
                    const option1 = new Option(displayName, role.role_name);
                    const option2 = new Option(displayName, role.role_name);
                    primarySelect.add(option1);
                    secondarySelect.add(option2);
                    
                    // Add to compound select if it looks like a compound role
                    if (role.role_name.includes('/') || role.role_name.includes('&') || role.role_name.includes(',')) {
                        const option3 = new Option(displayName, role.role_name);
                        compoundSelect.add(option3);
                    }
                });
                
                // Enable split button when compound role is selected
                compoundSelect.addEventListener('change', function() {
                    document.getElementById('executeSplitBtn').disabled = !this.value;
                });
                
                console.log(`Loaded ${roles.length} roles for merge functionality`);
                
            } catch (error) {
                console.error('Error loading roles for merge:', error);
                alert('Failed to load roles. Please try again.');
            }
        }

        async function findPotentialDuplicateRoles() {
            const button = document.getElementById('findDuplicateRolesBtn');
            const loading = document.getElementById('roleMergeFindingLoading');
            const results = document.getElementById('roleDuplicatesResults');
            
            button.disabled = true;
            loading.style.display = 'block';
            results.style.display = 'none';
            
            try {
                const response = await fetch('/api/potential-duplicate-roles');
                if (!response.ok) throw new Error('Failed to find duplicate roles');
                
                const duplicates = await response.json();
                potentialRoleDuplicates = duplicates || [];
                
                loading.style.display = 'none';
                
                if (potentialRoleDuplicates.length === 0) {
                    results.innerHTML = '<div class="no-duplicates-message"><i class="fas fa-check-circle"></i> No potential duplicate roles found! All roles appear to be unique.</div>';
                    results.style.display = 'block';
                } else {
                    displayPotentialRoleDuplicates();
                    results.style.display = 'block';
                }
                
            } catch (error) {
                console.error('Error finding duplicate roles:', error);
                loading.style.display = 'none';
                alert('Failed to find potential duplicate roles. Please try again.');
            } finally {
                button.disabled = false;
            }
        }

        function displayPotentialRoleDuplicates() {
            const list = document.getElementById('roleDuplicatesList');
            list.innerHTML = '';
            
            potentialRoleDuplicates.forEach((duplicate, index) => {
                const duplicateItem = document.createElement('div');
                duplicateItem.className = 'duplicate-item';
                duplicateItem.innerHTML = `
                    <div class="duplicate-info">
                        <div class="duplicate-employees">
                            <div class="employee-info">
                                <strong>${duplicate.role1_name}</strong>
                                <span class="similarity-badge">${duplicate.role1_count} employees</span>
                            </div>
                            <div class="merge-arrow"><i class="fas fa-arrow-right"></i></div>
                            <div class="employee-info">
                                <strong>${duplicate.role2_name}</strong>
                                <span class="similarity-badge">${duplicate.role2_count} employees</span>
                            </div>
                        </div>
                        <div class="duplicate-stats">
                            <span class="stat">Similarity: ${Math.round(duplicate.similarity_score * 100)}%</span>
                            <span class="stat">Suggested: ${duplicate.suggested_primary}</span>
                            <span class="stat">Impact: ${duplicate.merge_impact} employees</span>
                        </div>
                    </div>
                    <div class="duplicate-actions">
                        <button class="select-duplicate-btn" onclick="selectRoleDuplicate('${duplicate.role1_name}', '${duplicate.role2_name}')">
                            <i class="fas fa-hand-pointer"></i> Select for Merge
                        </button>
                    </div>
                `;
                list.appendChild(duplicateItem);
            });
        }

        function showManualRoleSelection() {
            document.getElementById('manualRoleSelection').style.display = 'block';
        }

        function showRoleSplitOptions() {
            document.getElementById('roleSplitOptions').style.display = 'block';
        }

        function selectRoleDuplicate(role1, role2) {
            selectedPrimaryRole = role1;
            selectedSecondaryRole = role2;
            previewRoleMerge();
        }

        function updateRoleMergePreview() {
            const primarySelect = document.getElementById('primaryRoleSelect');
            const secondarySelect = document.getElementById('secondaryRoleSelect');
            const previewBtn = document.getElementById('previewRoleMergeBtn');
            
            const primaryValue = primarySelect.value;
            const secondaryValue = secondarySelect.value;
            
            // Enable preview button if both roles are selected and different
            previewBtn.disabled = !primaryValue || !secondaryValue || primaryValue === secondaryValue;
            
            if (primaryValue && secondaryValue && primaryValue !== secondaryValue) {
                selectedPrimaryRole = primaryValue;
                selectedSecondaryRole = secondaryValue;
            }
        }

        async function previewRoleMerge() {
            if (!selectedPrimaryRole || !selectedSecondaryRole) {
                alert('Please select both primary and secondary roles.');
                return;
            }
            
            // Hide step 1, show step 2
            document.getElementById('roleMergeStep1').style.display = 'none';
            document.getElementById('roleMergeStep2').style.display = 'block';
            
            const loading = document.getElementById('roleMergePreviewLoading');
            const content = document.getElementById('roleMergePreviewContent');
            
            loading.style.display = 'block';
            content.style.display = 'none';
            
            try {
                const primaryEncoded = encodeURIComponent(selectedPrimaryRole);
                const secondaryEncoded = encodeURIComponent(selectedSecondaryRole);
                const response = await fetch(`/api/role-merge-preview/${primaryEncoded}/${secondaryEncoded}`);
                
                if (!response.ok) throw new Error('Failed to load role merge preview');
                
                roleMergePreviewData = await response.json();
                displayRoleMergePreview(roleMergePreviewData);
                
                loading.style.display = 'none';
                content.style.display = 'block';
                
            } catch (error) {
                console.error('Error loading role merge preview:', error);
                alert('Failed to load merge preview. Please try again.');
                backToRoleSelection();
            }
        }

        function displayRoleMergePreview(data) {
            const primaryInfo = document.getElementById('primaryRoleInfo');
            const secondaryInfo = document.getElementById('secondaryRoleInfo');
            
            const primary = data.primary_role;
            const secondary = data.secondary_role;
            const impact = data.merge_impact;
            
            primaryInfo.innerHTML = `
                <div class="role-info">
                    <p><strong>Role Name:</strong> ${primary.role_name}</p>
                    <p><strong>Employee Count:</strong> ${primary.employee_count}</p>
                    <p><strong>Employees:</strong> ${primary.employees.slice(0, 5).join(', ')}${primary.employees.length > 5 ? ` (+${primary.employees.length - 5} more)` : ''}</p>
                </div>
            `;
            
            secondaryInfo.innerHTML = `
                <div class="role-info">
                    <p><strong>Role Name:</strong> ${secondary.role_name}</p>
                    <p><strong>Employee Count:</strong> ${secondary.employee_count}</p>
                    <p><strong>Employees:</strong> ${secondary.employees.slice(0, 5).join(', ')}${secondary.employees.length > 5 ? ` (+${secondary.employees.length - 5} more)` : ''}</p>
                </div>
            `;
            
            // Display merge impact
            const impactSummary = document.getElementById('roleMergeImpactSummary');
            impactSummary.innerHTML = `
                <div class="impact-stats">
                    <div class="impact-stat">
                        <strong>Total Affected Employees:</strong> ${impact.total_affected_employees}
                    </div>
                    <div class="impact-stat">
                        <strong>Employees with Both Roles:</strong> ${impact.employees_with_both_roles}
                    </div>
                    <div class="impact-stat success">
                        <strong>Will Merge Into:</strong> ${impact.will_merge_into}
                    </div>
                    <div class="impact-details">
                        <strong>Affected Employees:</strong><br>
                        ${impact.affected_employees.slice(0, 10).join(', ')}${impact.affected_employees.length > 10 ? ` (+${impact.affected_employees.length - 10} more)` : ''}
                    </div>
                </div>
            `;
        }

        function backToRoleSelection() {
            document.getElementById('roleMergeStep1').style.display = 'block';
            document.getElementById('roleMergeStep2').style.display = 'none';
        }

        async function confirmRoleMerge() {
            if (!selectedPrimaryRole || !selectedSecondaryRole) {
                alert('Invalid role selection.');
                return;
            }
            
            // Hide step 2, show step 3
            document.getElementById('roleMergeStep2').style.display = 'none';
            document.getElementById('roleMergeStep3').style.display = 'block';
            
            const loading = document.getElementById('roleMergeExecutionLoading');
            const results = document.getElementById('roleMergeResults');
            
            loading.style.display = 'block';
            results.style.display = 'none';
            
            try {
                const response = await fetch('/api/merge-roles', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        primary_role: selectedPrimaryRole,
                        secondary_role: selectedSecondaryRole,
                        merge_options: roleMergeOptions
                    })
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    const errorMessage = result.error || `Server returned ${response.status}: ${response.statusText}`;
                    throw new Error(`Failed to merge roles: ${errorMessage}`);
                }
                
                loading.style.display = 'none';
                
                if (result.success) {
                    displayRoleMergeSuccess(result);
                } else {
                    displayRoleMergeError(result.error || 'Unknown error occurred during role merge');
                }
                
                results.style.display = 'block';
                
            } catch (error) {
                console.error('Error merging roles:', error);
                loading.style.display = 'none';
                displayRoleMergeError(error.message);
                results.style.display = 'block';
            }
        }

        function displayRoleMergeSuccess(result) {
            const content = document.getElementById('roleMergeResultsContent');
            content.innerHTML = `
                <div class="merge-success">
                    <div class="success-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <h4>Roles Successfully Merged!</h4>
                    <div class="merge-summary">
                        <p><strong>Primary Role:</strong> ${result.primary_role} (kept)</p>
                        <p><strong>Secondary Role:</strong> ${result.secondary_role} (merged and removed)</p>
                        <p><strong>Final Role Name:</strong> ${result.final_role}</p>
                        <p><strong>Employees Affected:</strong> ${result.employees_affected}</p>
                        <p><strong>Role Instances Merged:</strong> ${result.role_instances_merged}</p>
                        <p><strong>Merge Completed:</strong> ${new Date(result.merged_at).toLocaleString()}</p>
                    </div>
                    <p>The role data has been successfully consolidated. All employee records containing these roles have been updated.</p>
                </div>
            `;
        }

        function displayRoleMergeError(error) {
            const content = document.getElementById('roleMergeResultsContent');
            content.innerHTML = `
                <div class="merge-error">
                    <div class="error-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <h4>Role Merge Failed</h4>
                    <p>The role merge operation could not be completed:</p>
                    <div class="error-message">${error}</div>
                    <p>Please try again or contact support if the problem persists.</p>
                </div>
            `;
        }

        async function executeRoleSplit() {
            const compoundSelect = document.getElementById('compoundRoleSelect');
            const compoundRole = compoundSelect.value;
            
            if (!compoundRole) {
                alert('Please select a compound role to split.');
                return;
            }
            
            const loading = document.getElementById('roleMergeFindingLoading');
            loading.style.display = 'block';
            
            try {
                const response = await fetch('/api/split-compound-roles', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        compound_role: compoundRole
                    })
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.error || 'Failed to split compound role');
                }
                
                if (result.success) {
                    alert(`Successfully split "${result.original_role}" into: ${result.split_roles.join(', ')}\n\nAffected ${result.employees_affected} employee records.`);
                    // Refresh the role list
                    await loadRolesForMerge();
                } else {
                    alert(`Failed to split role: ${result.error}`);
                }
                
            } catch (error) {
                console.error('Error splitting compound role:', error);
                alert(`Error splitting compound role: ${error.message}`);
            } finally {
                loading.style.display = 'none';
            }
        }

        async function normalizeAllRoles() {
            const button = document.getElementById('normalizeRolesBtn');
            const loading = document.getElementById('roleMergeFindingLoading');
            
            if (!confirm('This will normalize all role data (remove duplicates, fix formatting). Are you sure?')) {
                return;
            }
            
            button.disabled = true;
            loading.style.display = 'block';
            
            try {
                const response = await fetch('/api/normalize-roles', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({})
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.error || 'Failed to normalize roles');
                }
                
                if (result.success) {
                    alert(`Successfully normalized roles!\n\nEmployees updated: ${result.employees_updated}\nDuplicates removed: ${result.duplicates_removed}`);
                    // Refresh the role list
                    await loadRolesForMerge();
                } else {
                    alert(`Failed to normalize roles: ${result.error}`);
                }
                
            } catch (error) {
                console.error('Error normalizing roles:', error);
                alert(`Error normalizing roles: ${error.message}`);
            } finally {
                button.disabled = false;
                loading.style.display = 'none';
            }
        }

        function refreshAfterRoleMerge() {
            // Refresh the page to show updated data
            window.location.reload();
        }

        // =====================================================================
        // UNIFIED MERGE FUNCTIONALITY
        // =====================================================================
        
        // Main unified merge modal function
        function openMergeModal(type) {
            switch(type) {
                case 'employees':
                    openEmployeeMergeModal();
                    break;
                case 'teams':
                    openTeamMergeModal();
                    break;
                case 'roles':
                    openRoleMergeModal();
                    break;
                default:
                    console.error('Unknown merge type:', type);
            }
        }

        // Rename the old openMergeModal to avoid conflicts
        function openEmployeeMergeModal() {
            if (isDemoMode) {
                alert('Employee merge is not available in demo mode. Please configure Supabase credentials to enable this feature.');
                return;
            }
            document.getElementById('mergeModal').style.display = 'block';
            resetMergeModal();
            loadEmployeesForMerge();
        }

        // Add merge dropdown event listener
        document.addEventListener('DOMContentLoaded', function() {
            const mergeBtn = document.getElementById('mergeBtn');
            const mergeDropdown = document.querySelector('.merge-dropdown');
            
            if (mergeBtn && mergeDropdown) {
                mergeBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    mergeDropdown.classList.toggle('active');
                });
                
                // Close dropdown when clicking outside
                document.addEventListener('click', function(e) {
                    if (!mergeDropdown.contains(e.target)) {
                        mergeDropdown.classList.remove('active');
                    }
                });
            }
        });

        // Add upload dropdown event listener
        document.addEventListener('DOMContentLoaded', function() {
            const uploadBtnDropdown = document.getElementById('uploadBtn');
            const uploadDropdown = document.querySelector('.upload-dropdown');
            
            if (uploadBtnDropdown && uploadDropdown) {
                uploadBtnDropdown.addEventListener('click', function(e) {
                    e.stopPropagation();
                    uploadDropdown.classList.toggle('active');
                });
                
                // Close dropdown when clicking outside
                document.addEventListener('click', function(e) {
                    if (!uploadDropdown.contains(e.target)) {
                        uploadDropdown.classList.remove('active');
                    }
                });
            }

            // Add individual upload option listeners
            const uploadResumesBtn = document.getElementById('uploadResumesBtn');
            const uploadTemplateBtn = document.getElementById('uploadTemplateBtn');
            
            if (uploadResumesBtn) {
                uploadResumesBtn.addEventListener('click', function() {
                    uploadDropdown.classList.remove('active');
                    openUploadModal();
                });
            }
            
            if (uploadTemplateBtn) {
                uploadTemplateBtn.addEventListener('click', function() {
                    uploadDropdown.classList.remove('active');
                    openTemplateUploadModal();
                });
            }
        });

        // Close role merge modal when clicking outside
        document.addEventListener('DOMContentLoaded', function() {
            const roleMergeModal = document.getElementById('mergeRolesModal');
            if (roleMergeModal) {
                roleMergeModal.addEventListener('click', function(event) {
                    if (event.target === this) {
                        closeRoleMergeModal();
                    }
                });
            }
        });

        // Remove old merge button event listeners since we now use the unified dropdown
        // The old team merge button listener is removed by the UI changes

        // =====================================================================
        // ROLE DEDUPLICATION UTILITY
        // =====================================================================
        
        function deduplicateRoles(roleString) {
            if (!roleString) return roleString;
            
            // Split by comma, clean each role, and deduplicate
            const roles = [];
            roleString.split(',').forEach(role => {
                const cleanedRole = role.trim();
                if (cleanedRole && !roles.includes(cleanedRole)) {
                    roles.push(cleanedRole);
                }
            });
            
            return roles.join(', ');
        }

        // =====================================================================
        // SPLIT ROLES SCRIPT EXECUTION
        // =====================================================================
        
        async function executeSplitRolesScript() {
            if (isDemoMode) {
                alert('Role normalization is not available in demo mode. Please configure Supabase credentials to enable this feature.');
                return;
            }
            
            // Open the modal and show loading
            document.getElementById('splitRolesOutputModal').style.display = 'block';
            document.getElementById('splitRolesLoading').style.display = 'block';
            document.getElementById('splitRolesOutput').style.display = 'none';
            
            try {
                console.log(' Executing split_roles.py script...');
                
                const response = await fetch('/api/execute-split-roles', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                console.log(' Response status:', response.status, response.statusText);
                
                const result = await response.json();
                console.log(' Script execution result:', result);
                
                // Hide loading
                document.getElementById('splitRolesLoading').style.display = 'none';
                
                // Prepare output text
                let outputText = '';
                if (result.success) {
                    outputText += ' Script executed successfully!\n\n';
                    outputText += ' Executed at: ' + new Date(result.executed_at).toLocaleString() + '\n\n';
                    if (result.stdout) {
                        outputText += ' Output:\n' + result.stdout;
                    }
                    if (result.stderr) {
                        outputText += '\n\n Warnings/Errors:\n' + result.stderr;
                    }
                } else {
                    outputText += ' Script execution failed!\n\n';
                    outputText += ' Executed at: ' + new Date(result.executed_at).toLocaleString() + '\n\n';
                    outputText += ' Error: ' + (result.error || 'Unknown error') + '\n\n';
                    if (result.stdout) {
                        outputText += ' Output:\n' + result.stdout + '\n\n';
                    }
                    if (result.stderr) {
                        outputText += ' Error Details:\n' + result.stderr;
                    }
                }
                
                // Display the output
                document.getElementById('splitRolesOutputText').textContent = outputText;
                document.getElementById('splitRolesOutput').style.display = 'block';
                
            } catch (error) {
                console.error(' Error executing split roles script:', error);
                
                // Hide loading
                document.getElementById('splitRolesLoading').style.display = 'none';
                
                // Show error
                const errorText = ` Failed to execute script!\n\n Time: ${new Date().toLocaleString()}\n\n Error: ${error.message}`;
                document.getElementById('splitRolesOutputText').textContent = errorText;
                document.getElementById('splitRolesOutput').style.display = 'block';
            }
        }
        
        function closeSplitRolesOutputModal() {
            document.getElementById('splitRolesOutputModal').style.display = 'none';
        }
        
        function refreshAfterSplitRoles() {
            // Refresh the page to show updated data
            window.location.reload();
        }
        
        // Close modal when clicking outside
        document.addEventListener('DOMContentLoaded', function() {
            const splitRolesModal = document.getElementById('splitRolesOutputModal');
            if (splitRolesModal) {
                splitRolesModal.addEventListener('click', function(event) {
                    if (event.target === this) {
                        closeSplitRolesOutputModal();
                    }
                });
            }
        });

        // =====================================================================
        // DELETE EMPLOYEE FUNCTIONALITY
        // =====================================================================
        
        async function openDeleteEmployeeModal() {
            if (isDemoMode) {
                alert('Employee deletion is not available in demo mode. Please configure Supabase credentials to enable this feature.');
                return;
            }
            
            // For now, we'll ask user to select an employee through a dropdown
            // In a future enhancement, we could support multi-select from the table
            const employeeSelectModal = document.getElementById('deleteEmployeeSelectModal');
            if (!employeeSelectModal) {
                createDeleteEmployeeModal();
            }
            
            // Load employees for selection
            await loadEmployeesForDeletion();
            document.getElementById('deleteEmployeeSelectModal').style.display = 'block';
        }
        
        function createDeleteEmployeeModal() {
            const modalHTML = `
                <!-- Delete Employee Selection Modal -->
                <div id="deleteEmployeeSelectModal" class="merge-modal">
                    <div class="merge-modal-content">
                        <div class="merge-modal-header">
                            <h2 class="merge-modal-title">Delete Employee</h2>
                            <button class="merge-modal-close" onclick="closeDeleteEmployeeModal()">&times;</button>
                        </div>
                        <div class="merge-modal-body">
                            <div class="delete-warning" style="background: #fee2e2; color: #991b1b; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                                <h4 style="margin: 0 0 0.5rem 0;"><i class="fas fa-exclamation-triangle"></i> Warning</h4>
                                <p style="margin: 0;">This action will permanently delete the employee and ALL related data including projects, qualifications, and team assignments. This cannot be undone.</p>
                            </div>
                            
                            <div class="employee-selector">
                                <label>Select Employee to Delete:</label>
                                <select id="deleteEmployeeSelect" onchange="updateDeletePreview()">
                                    <option value="">Select an employee...</option>
                                </select>
                            </div>
                            
                            <div id="deletePreviewSection" style="display: none; margin-top: 1.5rem;">
                                <h4>Deletion Preview</h4>
                                <div id="deletePreviewContent"></div>
                                
                                <div style="margin-top: 1.5rem;">
                                    <button class="delete-btn" id="confirmDeleteBtn" onclick="confirmDeleteEmployee()" disabled>
                                        <i class="fas fa-trash-alt"></i> Delete Employee
                                    </button>
                                    <button class="cancel-btn" onclick="closeDeleteEmployeeModal()">
                                        <i class="fas fa-times"></i> Cancel
                                    </button>
                                </div>
                            </div>
                            
                            <div id="deleteEmployeeLoading" style="display: none; text-align: center; padding: 2rem;">
                                <i class="fas fa-spinner fa-spin"></i>
                                <p>Processing deletion...</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- CSS for delete modal -->
                <style>
                .delete-btn {
                    background: #dc2626;
                    color: white;
                    border: none;
                    padding: 0.75rem 1.5rem;
                    border-radius: 6px;
                    cursor: pointer;
                    font-size: 0.9rem;
                    margin-right: 1rem;
                }
                .delete-btn:hover:not(:disabled) {
                    background: #b91c1c;
                }
                .delete-btn:disabled {
                    background: #9ca3af;
                    cursor: not-allowed;
                }
                </style>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }
        
        async function loadEmployeesForDeletion() {
            try {
                const response = await fetch('/api/employees-for-merge');
                if (!response.ok) throw new Error('Failed to load employees');
                
                const data = await response.json();
                const employees = data.employees || [];
                
                const select = document.getElementById('deleteEmployeeSelect');
                select.innerHTML = '<option value="">Select an employee...</option>';
                
                employees.forEach(employee => {
                    const option = document.createElement('option');
                    option.value = employee.employee_id;
                    option.textContent = employee.employee_name;
                    select.appendChild(option);
                });
                
            } catch (error) {
                console.error('Error loading employees for deletion:', error);
                alert('Failed to load employees: ' + error.message);
            }
        }
        
        async function updateDeletePreview() {
            const select = document.getElementById('deleteEmployeeSelect');
            const previewSection = document.getElementById('deletePreviewSection');
            const previewContent = document.getElementById('deletePreviewContent');
            const confirmBtn = document.getElementById('confirmDeleteBtn');
            
            const employeeId = select.value;
            
            if (!employeeId) {
                previewSection.style.display = 'none';
                return;
            }
            
            try {
                const response = await fetch(`/api/delete-employee-preview/${employeeId}`);
                const data = await response.json();
                
                if (data.success) {
                    const employee = data.employee;
                    const impact = data.deletion_impact;
                    
                    previewContent.innerHTML = `
                        <div style="background: #f3f4f6; padding: 1rem; border-radius: 6px;">
                            <h5>Employee: ${employee.employee_name}</h5>
                            <p><strong>Experience:</strong> ${employee.total_years_experience || 'N/A'} years</p>
                            <p><strong>Education:</strong> ${employee.education || 'N/A'}</p>
                            <p><strong>Source:</strong> ${employee.source_filename || 'N/A'}</p>
                        </div>
                        
                        <div style="background: #fef2f2; border: 1px solid #fecaca; padding: 1rem; border-radius: 6px; margin-top: 1rem;">
                            <h5 style="color: #dc2626;">Items to be deleted:</h5>
                            <ul style="margin: 0.5rem 0;">
                                <li>${impact.assignments_to_delete} assignment(s)</li>
                                <li>${impact.projects_affected} project(s) affected</li>
                                <li>${impact.qualifications_to_delete} qualification record(s)</li>
                            </ul>
                            ${impact.project_titles ? `<p><strong>Projects:</strong> ${impact.project_titles}</p>` : ''}
                        </div>
                    `;
                    
                    previewSection.style.display = 'block';
                    confirmBtn.disabled = false;
                } else {
                    throw new Error(data.error || 'Failed to get delete preview');
                }
                
            } catch (error) {
                console.error('Error getting delete preview:', error);
                previewContent.innerHTML = `<p style="color: #dc2626;">Error: ${error.message}</p>`;
                previewSection.style.display = 'block';
                confirmBtn.disabled = true;
            }
        }
        
        async function confirmDeleteEmployee() {
            const select = document.getElementById('deleteEmployeeSelect');
            const employeeId = select.value;
            const employeeName = select.options[select.selectedIndex].text;
            
            if (!employeeId) {
                alert('Please select an employee to delete.');
                return;
            }
            
            // Final confirmation
            if (!confirm(`Are you absolutely sure you want to delete ${employeeName}?\n\nThis will permanently remove:\n- All employee data\n- All project assignments\n- All qualifications\n- All related records\n\nThis action CANNOT be undone.`)) {
                return;
            }
            
            const loading = document.getElementById('deleteEmployeeLoading');
            const modalBody = document.querySelector('#deleteEmployeeSelectModal .merge-modal-body');
            
            loading.style.display = 'block';
            
            try {
                const response = await fetch('/api/delete-employee', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        employee_id: employeeId
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`Successfully deleted ${result.employee_name}!\n\nDeleted:\n- ${result.assignments_deleted} assignment(s)\n- ${result.qualifications_deleted} qualification(s)\n- ${result.projects_affected} project(s) affected`);
                    closeDeleteEmployeeModal();
                    // Refresh the data
                    refreshData();
                } else {
                    throw new Error(result.error || 'Failed to delete employee');
                }
                
            } catch (error) {
                console.error('Error deleting employee:', error);
                alert('Failed to delete employee: ' + error.message);
            } finally {
                loading.style.display = 'none';
            }
        }
        
        function closeDeleteEmployeeModal() {
            const modal = document.getElementById('deleteEmployeeSelectModal');
            if (modal) {
                modal.style.display = 'none';
            }
            
            // Reset form
            const select = document.getElementById('deleteEmployeeSelect');
            if (select) select.value = '';
            
            const previewSection = document.getElementById('deletePreviewSection');
            if (previewSection) previewSection.style.display = 'none';
        }
        
        // =====================================================================
        // DELETE PROJECT FUNCTIONALITY
        // =====================================================================
        
        async function deleteIndividualProject(projectId) {
            if (isDemoMode) {
                alert('Project deletion is not available in demo mode. Please configure Supabase credentials to enable this feature.');
                return;
            }
            
            if (!currentEmployeeData || !currentEmployeeData.employee_id) {
                alert('Employee data not loaded. Please refresh the page and try again.');
                return;
            }
            
            // Get project details for confirmation
            const projectElement = document.querySelector(`[data-project-id="${projectId}"]`);
            if (!projectElement) {
                alert('Project not found.');
                return;
            }
            
            // Check if project has a real database ID
            const hasRealId = projectElement.getAttribute('data-has-real-id') === 'true';
            if (!hasRealId) {
                alert('Cannot delete this project: No valid database ID found.\n\nThis project may be from local data or may not be properly synchronized with the database.');
                return;
            }
            
            // Validate that projectId looks like a UUID (basic check)
            const uuidPattern = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
            if (!uuidPattern.test(projectId)) {
                alert('Cannot delete this project: Invalid project ID format.\n\nThis project may need to be re-synchronized with the database.');
                return;
            }
            
            const projectTitle = projectElement.querySelector('h4')?.textContent || 'Unknown Project';
            
            // Debug logging
            console.log('Delete project called with:', {
                projectId: projectId,
                employeeId: currentEmployeeData.employee_id,
                projectTitle: projectTitle,
                hasRealId: hasRealId
            });
            
            // Confirm deletion
            if (!confirm(`Are you sure you want to delete this project?\n\n"${projectTitle}"\n\nThis will remove the project from ${currentEmployeeData.employee_name}'s profile. If no other employees are assigned to this project, the project will be completely deleted from the database.\n\nThis action cannot be undone.`)) {
                return;
            }
            
            try {
                // Show loading state
                const deleteBtn = projectElement.querySelector('.project-delete-icon');
                if (deleteBtn) {
                    deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                    deleteBtn.disabled = true;
                }
                
                console.log('Sending delete request...');
                
                const response = await fetch('/api/delete-project', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        employee_id: currentEmployeeData.employee_id,
                        project_id: projectId
                    })
                });
                
                console.log('Response status:', response.status);
                console.log('Response headers:', response.headers);
                
                // Check if response is actually JSON
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const responseText = await response.text();
                    console.error('Non-JSON response received:', responseText);
                    throw new Error('Server returned invalid response. Check console for details.');
                }
                
                const result = await response.json();
                console.log('Delete result:', result);
                
                if (response.ok && result.success) {
                    // Remove the project element from the DOM
                    projectElement.remove();
                    
                    // Show success message
                    showSuccessMessage(`Successfully removed project "${result.project_title}" from ${result.employee_name}${result.project_deleted ? ' (project completely deleted)' : ''}.`);
                    
                    // Update project count if available
                    const totalProjectsElement = document.getElementById('detailTotalProjects');
                    if (totalProjectsElement) {
                        const currentCount = parseInt(totalProjectsElement.textContent) || 0;
                        const newCount = Math.max(0, currentCount - 1);
                        totalProjectsElement.textContent = newCount.toString();
                    }
                    
                } else {
                    throw new Error(result.error || `Server error: ${response.status} ${response.statusText}`);
                }
                
            } catch (error) {
                console.error('Error deleting project:', error);
                
                // Show more detailed error information
                let errorMessage = 'Failed to delete project: ' + error.message;
                if (error.message.includes('Server returned invalid response')) {
                    errorMessage += '\n\nThis might be because:\n- The project ID is invalid\n- The server is not running properly\n- Database connection issues';
                }
                
                alert(errorMessage);
                
                // Restore delete button
                const deleteBtn = projectElement.querySelector('.project-delete-icon');
                if (deleteBtn) {
                    deleteBtn.innerHTML = '<i class="fas fa-trash-alt"></i>';
                    deleteBtn.disabled = false;
                }
            }
        }
        
        // =====================================================================
        // REFRESH DATA FUNCTIONALITY
        // =====================================================================
        
        function refreshData() {
            const refreshBtn = document.getElementById('refreshDataBtn');
            if (refreshBtn) {
                refreshBtn.classList.add('spinning');
            }
            
            // Refresh the page to reload all data
            setTimeout(() => {
                window.location.reload();
            }, 500); // Small delay to show the spinning animation
        }
        
        // =====================================================================
        // EVENT LISTENERS FOR DELETE FUNCTIONALITY
        // =====================================================================
        
        document.addEventListener('DOMContentLoaded', function() {
            // Delete employee button
            const deleteEmployeeBtn = document.getElementById('deleteEmployeeBtn');
            if (deleteEmployeeBtn) {
                deleteEmployeeBtn.addEventListener('click', openDeleteEmployeeModal);
            }
            
            // Refresh button
            const refreshBtn = document.getElementById('refreshDataBtn');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', refreshData);
            }
            
            // Close delete modal when clicking outside
            document.addEventListener('click', function(e) {
                const modal = document.getElementById('deleteEmployeeSelectModal');
                if (modal && e.target === modal) {
                    closeDeleteEmployeeModal();
                }
            });
        });
    </script>
</body>
</html> 